<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>עזר חתנים - מערכת ניהול תשפ"ה</title>
    
    <!-- ספריות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; overflow: hidden; }
        .hidden-screen { display: none !important; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #1e1b4b; }
        .submenu.open { max-height: 500px; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Tabs */
        .tab-btn { padding: 8px 16px; border-bottom: 3px solid transparent; color: #64748b; font-weight: 600; transition: 0.2s; }
        .tab-btn.active { border-color: #4f46e5; color: #4f46e5; background: #eef2ff; }

        /* Sortable */
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; border: 2px dashed #4338ca; }
        .drag-handle { cursor: grab; color: #94a3b8; }
        .drag-handle:active { cursor: grabbing; }

        /* Print - Fixed for Hebrew */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; direction: rtl; }
            @page { size: A4; margin: 10mm; }
            table { width: 100%; border-collapse: collapse; font-size: 11pt; }
            th, td { border: 1px solid black; padding: 4px; text-align: right; }
            th { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="h-screen flex text-gray-800">

    <!-- Print Container -->
    <div id="print-area"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-indigo-900 flex flex-col justify-center items-center">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-96 text-center">
            <h1 class="text-4xl font-bold text-indigo-900 mb-2">עזר חתנים</h1>
            <p class="text-gray-500 mb-8">מערכת ניהול - גרסת Enterprise</p>
            <form onsubmit="Auth.login(event)" class="space-y-4">
                <input type="email" id="email" placeholder="אימייל" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                <input type="password" id="password" placeholder="סיסמה" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">כניסה למערכת</button>
            </form>
            <button onclick="Auth.resetPass()" class="mt-4 text-sm text-indigo-600 hover:underline">שכחתי סיסמה</button>
            <div id="login-msg" class="text-red-500 text-sm mt-4 hidden font-bold"></div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-indigo-900 text-white flex flex-col hidden-screen z-40 shadow-xl transition-all">
        <div class="p-6 bg-indigo-950 border-b border-indigo-800">
            <h2 class="text-xl font-bold tracking-wide">עזר חתנים</h2>
            <div class="text-xs text-indigo-300 mt-2 flex justify-between">
                <span id="display-user-role"></span>
                <span id="display-year" class="font-mono bg-indigo-800 px-1 rounded"></span>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-2">
            <ul>
                <li><a href="#" onclick="Router.go('dashboard')" class="flex items-center p-3 hover:bg-indigo-800 transition"><i class="fas fa-chart-pie w-8 text-center"></i> לוח מחוונים</a></li>
                
                <!-- Data Management -->
                <li>
                    <button onclick="UI.toggleMenu('menu-data')" class="w-full flex justify-between items-center p-3 hover:bg-indigo-800 transition">
                        <span class="flex items-center"><i class="fas fa-users w-8 text-center"></i> ניהול נתונים</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <ul id="menu-data" class="submenu">
                        <li><a href="#" onclick="Router.go('students')" class="block p-3 pr-12 hover:bg-indigo-800 text-sm opacity-90">בחורים</a></li>
                        <li><a href="#" onclick="Router.go('groups')" class="block p-3 pr-12 hover:bg-indigo-800 text-sm opacity-90">קבוצות ומסלולים</a></li>
                        <li><a href="#" onclick="Router.go('donors')" class="block p-3 pr-12 hover:bg-indigo-800 text-sm opacity-90">תורמים</a></li>
                    </ul>
                </li>

                <!-- Finance (Admin Only) -->
                <li class="admin-only">
                    <button onclick="UI.toggleMenu('menu-finance')" class="w-full flex justify-between items-center p-3 hover:bg-indigo-800 transition">
                        <span class="flex items-center"><i class="fas fa-shekel-sign w-8 text-center"></i> כספים ודוחות</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <ul id="menu-finance" class="submenu">
                        <li><a href="#" onclick="Router.go('finance')" class="block p-3 pr-12 hover:bg-indigo-800 text-sm opacity-90">ניהול קופה</a></li>
                        <li><a href="#" onclick="Router.go('vouchers')" class="block p-3 pr-12 hover:bg-indigo-800 text-sm opacity-90">זכאות ומתנות</a></li>
                    </ul>
                </li>

                <li class="admin-only"><a href="#" onclick="Router.go('settings')" class="flex items-center p-3 hover:bg-indigo-800 transition"><i class="fas fa-cogs w-8 text-center"></i> הגדרות מערכת</a></li>
            </ul>
        </nav>
        <div class="p-4 bg-indigo-950 text-center border-t border-indigo-800">
            <button onclick="Auth.logout()" class="text-red-300 hover:text-white text-sm hover:underline">יציאה</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 flex flex-col hidden-screen bg-gray-50 h-full overflow-hidden">
        
        <!-- Top Bar -->
        <header class="bg-white shadow-sm h-16 flex justify-between items-center px-6 z-20">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">דף הבית</h2>
                <div id="loading-indicator" class="hidden text-indigo-600 text-sm animate-pulse"><i class="fas fa-circle-notch fa-spin"></i> מסנכרן...</div>
            </div>
            
            <div class="flex items-center gap-3">
                <select id="hebrew-year-select" onchange="App.changeYear(this.value)" class="bg-gray-100 border border-gray-300 text-gray-700 py-1 px-3 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="תשפ״ג">תשפ״ג</option>
                    <option value="תשפ״ד">תשפ״ד</option>
                    <option value="תשפ״ה" selected>תשפ״ה</option>
                    <option value="תשפ״ו">תשפ״ו</option>
                </select>
                <button onclick="App.forceRefresh()" class="text-gray-400 hover:text-indigo-600" title="רענון מלא"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>

        <!-- Views Container -->
        <div class="flex-1 overflow-y-auto p-6 relative" id="views-container">

            <!-- 1. DASHBOARD -->
            <section id="view-dashboard" class="view hidden-screen space-y-6">
                <!-- Alerts (Admin Only) -->
                <div class="admin-only bg-yellow-50 border-r-4 border-yellow-400 p-4 rounded shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-yellow-800"><i class="fas fa-bell"></i> התראות מערכת (מנהל)</h3>
                        <span class="text-xs text-yellow-600">הודעות אוטומטיות על זכאות/יעדים</span>
                    </div>
                    <div id="dash-alerts" class="text-sm space-y-1 text-gray-700 max-h-32 overflow-y-auto">
                        <p class="italic text-gray-400">אין התראות חדשות</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-green-500">
                        <div class="text-gray-500 font-bold text-sm">הכנסות (<span class="curr-year-span"></span>)</div>
                        <div class="text-3xl font-bold mt-2 text-gray-800" id="dash-income">₪0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-red-500">
                        <div class="text-gray-500 font-bold text-sm">הוצאות</div>
                        <div class="text-3xl font-bold mt-2 text-gray-800" id="dash-expense">₪0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-indigo-500">
                        <div class="text-gray-500 font-bold text-sm">יתרה בקופה</div>
                        <div class="text-3xl font-bold mt-2 text-indigo-700" id="dash-balance">₪0</div>
                    </div>
                </div>

                <!-- Goal Progress -->
                <div class="bg-white p-8 rounded-xl shadow-sm">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-lg">יעד גיוס שנתי</h3>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-indigo-600" id="dash-current">₪0</div>
                            <div class="text-sm text-gray-500">מתוך <span id="dash-goal">₪0</span></div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="dash-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </section>

            <!-- 2. STUDENTS -->
            <section id="view-students" class="view hidden-screen flex flex-col h-full">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 flex flex-wrap gap-3 items-center">
                    <button onclick="Modals.studentForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow font-bold text-sm"><i class="fas fa-plus"></i> הוסף</button>
                    <button onclick="Excel.init('students')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow font-bold text-sm"><i class="fas fa-file-excel"></i> יבוא מתקדם</button>
                    <div class="flex-1 relative">
                        <input type="text" id="search-students" onkeyup="Students.filter()" placeholder="חיפש בחור (שם, שיעור)..." class="w-full border p-2 pr-10 rounded text-sm focus:ring-2 focus:ring-indigo-500">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                    </div>
                </div>
                
                <div class="flex-1 bg-white rounded-xl shadow-sm overflow-hidden flex flex-col">
                    <div class="overflow-y-auto flex-1" id="students-scroll-area">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 sticky top-0 shadow-sm text-gray-600 text-xs uppercase">
                                <tr>
                                    <th class="p-3">שם מלא</th>
                                    <th class="p-3">שיעור</th>
                                    <th class="p-3">טלפון</th>
                                    <th class="p-3 text-center">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="students-tbody" class="divide-y divide-gray-100 text-sm"></tbody>
                        </table>
                        <div id="students-loader" class="p-4 text-center text-gray-500 text-sm hidden">טוען עוד...</div>
                    </div>
                    <div class="p-2 bg-gray-50 text-xs text-center border-t text-gray-500" id="students-count">0 רשומות</div>
                </div>
            </section>

            <!-- 3. GROUPS & ROUTES -->
            <section id="view-groups" class="view hidden-screen flex flex-col h-full">
                <div class="flex gap-2 bg-white p-2 rounded-lg shadow-sm mb-4">
                    <button class="tab-btn active flex-1" onclick="Groups.setTab('night14', this)">ליל י"ד</button>
                    <button class="tab-btn flex-1" onclick="Groups.setTab('day14', this)">יום י"ד</button>
                    <button class="tab-btn flex-1" onclick="Groups.setTab('day15', this)">יום ט"ו</button>
                </div>

                <div class="flex flex-1 gap-4 overflow-hidden">
                    <!-- Sidebar: Group List -->
                    <div class="w-64 bg-white rounded-xl shadow-sm flex flex-col">
                        <div class="p-3 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <span class="font-bold text-sm">קבוצות</span>
                            <button onclick="Groups.addGroup()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-2 py-1 rounded text-xs"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="groups-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                    </div>

                    <!-- Main Editor -->
                    <div class="flex-1 bg-white rounded-xl shadow-sm flex flex-col relative" id="group-editor">
                        <!-- Empty State -->
                        <div id="group-empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                            <i class="fas fa-users text-4xl mb-2"></i>
                            <p>בחר קבוצה לעריכה</p>
                        </div>

                        <!-- Active State -->
                        <div id="group-content" class="hidden flex flex-col h-full">
                            <div class="p-3 border-b flex justify-between items-center bg-indigo-50">
                                <h3 id="active-group-name" class="font-bold text-lg text-indigo-900"></h3>
                                <div class="flex gap-2">
                                    <button onclick="Groups.printRoute()" class="bg-white border text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-50"><i class="fas fa-print"></i> דף מסלול</button>
                                </div>
                            </div>
                            
                            <div class="flex border-b">
                                <button onclick="Groups.setView('members')" id="btn-view-members" class="flex-1 py-2 text-sm font-bold border-b-2 border-indigo-600 bg-indigo-50/50">שיבוץ בחורים</button>
                                <button onclick="Groups.setView('route')" id="btn-view-route" class="flex-1 py-2 text-sm text-gray-500 hover:bg-gray-50">מסלול תרומות</button>
                            </div>

                            <!-- Members View -->
                            <div id="view-sub-members" class="flex-1 flex overflow-hidden">
                                <div class="w-1/2 flex flex-col border-l">
                                    <div class="p-2 bg-gray-50 border-b"><input type="text" placeholder="חפש בחור פנוי..." onkeyup="Groups.filterPool(this.value)" class="w-full text-sm border p-1 rounded"></div>
                                    <div id="pool-students" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-100/50"></div>
                                </div>
                                <div class="w-1/2 flex flex-col p-2 bg-white">
                                    <div class="text-xs text-gray-500 mb-2 font-bold">חברי הקבוצה (לחץ לשינוי תפקיד)</div>
                                    <div id="group-members" class="flex-1 overflow-y-auto space-y-1"></div>
                                </div>
                            </div>

                            <!-- Route View -->
                            <div id="view-sub-route" class="hidden flex-1 flex overflow-hidden">
                                <div class="w-1/2 flex flex-col border-l">
                                    <div class="p-2 bg-gray-50 border-b"><input type="text" placeholder="חפש תורם..." onkeyup="Groups.filterDonors(this.value)" class="w-full text-sm border p-1 rounded"></div>
                                    <div id="pool-donors" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-100/50"></div>
                                </div>
                                <div class="w-1/2 flex flex-col p-2 bg-white">
                                    <div class="text-xs text-gray-500 mb-2 font-bold">מסלול (גרירה לסידור)</div>
                                    <div id="group-route" class="flex-1 overflow-y-auto space-y-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. DONORS -->
            <section id="view-donors" class="view hidden-screen flex flex-col h-full">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 flex flex-wrap gap-3 items-center">
                    <button onclick="Modals.donorForm()" class="bg-indigo-600 text-white px-4 py-2 rounded shadow font-bold text-sm">הוסף תורם</button>
                    <button onclick="Excel.init('donors')" class="bg-green-600 text-white px-4 py-2 rounded shadow font-bold text-sm">יבוא אקסל</button>
                    <div class="flex-1 relative">
                        <input type="text" onkeyup="Donors.render(this.value)" placeholder="חפש תורם..." class="w-full border p-2 pr-10 rounded text-sm">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                    </div>
                </div>
                <div id="donors-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 pb-10"></div>
                <div id="donors-loader" class="text-center py-4 text-gray-500 hidden">טוען עוד...</div>
            </section>

            <!-- 5. FINANCE (Admin) -->
            <section id="view-finance" class="view hidden-screen flex flex-col h-full">
                <!-- Year Tabs for Finance -->
                <div class="flex gap-1 border-b mb-4 overflow-x-auto" id="finance-years-tabs">
                    <!-- Dynamic tabs -->
                </div>
                
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 flex gap-3 items-center">
                    <button onclick="Modals.transactionForm('income')" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold">+ הכנסה</button>
                    <button onclick="Modals.transactionForm('expense')" class="bg-red-600 text-white px-4 py-2 rounded text-sm font-bold">- הוצאה</button>
                    <div class="h-6 w-px bg-gray-300 mx-2"></div>
                    <button onclick="Excel.init('finance')" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">יבוא היסטוריה</button>
                    <div class="flex-1"></div>
                    <button onclick="Finance.exportPDF()" class="text-red-600 hover:bg-red-50 px-3 py-2 rounded text-sm border border-red-200"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button onclick="Finance.exportExcel()" class="text-green-600 hover:bg-green-50 px-3 py-2 rounded text-sm border border-green-200"><i class="fas fa-file-excel"></i> Excel</button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden flex-1 flex flex-col">
                    <div class="overflow-y-auto flex-1">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-gray-100 text-gray-600 sticky top-0">
                                <tr>
                                    <th class="p-3">תאריך</th>
                                    <th class="p-3">סוג</th>
                                    <th class="p-3">תיאור / קטגוריה</th>
                                    <th class="p-3">אמצעי תשלום</th>
                                    <th class="p-3">סכום</th>
                                    <th class="p-3">מחיקה</th>
                                </tr>
                            </thead>
                            <tbody id="finance-tbody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- 6. VOUCHERS & GIFTS (Admin) -->
            <section id="view-vouchers" class="view hidden-screen">
                <div class="grid grid-cols-2 gap-6 h-full">
                    <!-- Rules Config -->
                    <div class="bg-white p-6 rounded-xl shadow-sm overflow-y-auto">
                        <h3 class="font-bold text-lg mb-4 text-indigo-900 border-b pb-2">הגדרת מתנות ויעדים</h3>
                        <div id="gift-rules-container" class="space-y-4"></div>
                        <button onclick="Vouchers.addRule()" class="mt-4 w-full border border-dashed border-gray-400 p-2 text-gray-500 hover:bg-gray-50 rounded">+ הוסף דרגת זכאות</button>
                        <button onclick="Vouchers.saveRules()" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded font-bold">שמור הגדרות</button>
                    </div>

                    <!-- Eligibility List -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col">
                        <h3 class="font-bold text-lg mb-4 text-indigo-900 border-b pb-2">בחורים זכאים (<span class="curr-year-span"></span>)</h3>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-gray-50"><tr><th class="p-2">שם</th><th class="p-2">גייס</th><th class="p-2">זכאי ל...</th><th class="p-2">פעולה</th></tr></thead>
                                <tbody id="eligible-tbody" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 7. SETTINGS -->
            <section id="view-settings" class="view hidden-screen">
                <div class="bg-white p-6 rounded-xl shadow-sm max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">הגדרות מערכת ומשתמשים</h2>
                    
                    <div class="mb-8">
                        <h3 class="font-bold text-lg mb-2">משתמשים והרשאות</h3>
                        <div class="flex gap-2 mb-2">
                            <input id="new-u-email" type="email" placeholder="אימייל משתמש" class="border p-2 rounded flex-1">
                            <select id="new-u-role" class="border p-2 rounded">
                                <option value="editor">עורך (מוגבל)</option>
                                <option value="admin">מנהל (מלא)</option>
                            </select>
                            <button onclick="Settings.addUser()" class="bg-indigo-600 text-white px-4 rounded">הוסף</button>
                        </div>
                        <ul id="users-list" class="space-y-2 text-sm"></ul>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-2">הגדרות ייצוא אקסל</h3>
                        <p class="text-gray-500 text-sm mb-2">בחר אילו עמודות יופיעו כברירת מחדל ביצוא בחורים</p>
                        <div class="flex gap-4">
                            <label><input type="checkbox" checked disabled> שם</label>
                            <label><input type="checkbox" checked> טלפון</label>
                            <label><input type="checkbox" checked> שיעור</label>
                            <label><input type="checkbox" checked> יעד אישי</label>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Modals -->
    <!-- 1. Excel Import -->
    <div id="modal-excel" class="hidden-screen fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-[600px] max-h-[90vh] flex flex-col p-6">
            <h3 class="text-xl font-bold mb-1">יבוא נתונים מאקסל</h3>
            <p id="excel-type-title" class="text-sm text-gray-500 mb-4"></p>
            
            <div id="excel-step-1" class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-gray-100 transition cursor-pointer relative">
                    <input type="file" id="excel-file" accept=".xlsx, .xls" class="absolute inset-0 opacity-0 cursor-pointer" onchange="Excel.parseFile()">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 font-medium">גרור קובץ לכאן או לחץ לבחירה</p>
                </div>
            </div>

            <div id="excel-step-2" class="hidden flex-1 overflow-y-auto space-y-4">
                <p class="text-sm font-bold bg-indigo-50 p-2 rounded text-indigo-800">נא להתאים עמודות מהקובץ לשדות במערכת:</p>
                <div id="excel-mapping" class="grid grid-cols-1 gap-3 text-sm"></div>
            </div>

            <div class="mt-6 flex justify-between pt-4 border-t">
                <button onclick="Modals.close('excel')" class="text-gray-500 hover:text-gray-800 font-bold">ביטול</button>
                <button id="excel-btn-process" onclick="Excel.process()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold shadow hidden">בצע יבוא</button>
            </div>
        </div>
    </div>

    <!-- 2. Generic Form -->
    <div id="modal-form" class="hidden-screen fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
            <h3 id="form-title" class="text-xl font-bold mb-4"></h3>
            <div id="form-content" class="space-y-3"></div>
            <div class="mt-6 flex gap-3">
                <button id="form-btn-save" class="flex-1 bg-indigo-600 text-white py-2 rounded font-bold">שמור</button>
                <button onclick="Modals.close('form')" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded font-bold">ביטול</button>
            </div>
        </div>
    </div>

    <!-- 3. Export Column Picker -->
    <div id="modal-export" class="hidden-screen fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
            <h3 class="text-lg font-bold mb-2">בחירת עמודות ליצוא</h3>
            <div id="export-cols" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <button onclick="Finance.doExcelExport()" class="w-full bg-green-600 text-white py-2 rounded font-bold">הורד קובץ</button>
            <button onclick="Modals.close('export')" class="w-full mt-2 text-gray-500">ביטול</button>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRunXdWIFiP8-vZao0WZ6WxItMAUt-ORY",
            authDomain: "ezer--project.firebaseapp.com",
            databaseURL: "https://ezer--project-default-rtdb.firebaseio.com",
            projectId: "ezer--project",
            storageBucket: "ezer--project.firebasestorage.app",
            messagingSenderId: "838086109276",
            appId: "1:838086109276:web:201babf8b31c39a0cc9e99"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- App State ---
        const App = {
            year: 'תשפ״ה',
            user: null,
            role: 'viewer', // admin, editor, viewer
            
            // Local Cache (Realtime Sync)
            data: {
                students: [], // {id, name, grade, ...}
                donors: [],   // {id, name, address, history:{...}}
                groups: {},   // { night14: { gid: {members, route} } }
                finance: [],  // [ {id, type, amount, date...} ]
                alerts: [],
                rules: []
            },

            async init() {
                // UI Init
                document.querySelectorAll('.curr-year-span').forEach(e => e.innerText = this.year);
                document.getElementById('display-year').innerText = this.year;
                document.getElementById('hebrew-year-select').value = this.year;

                // Listeners
                this.listen('students', `students`); // Master list
                this.listen('donors', `donors`);     // Master list
                this.listen('groups', `years/${this.year}/groups`);
                this.listen('finance', `years/${this.year}/finance`);
                this.listen('alerts', `years/${this.year}/alerts`);
                this.listen('rules', `settings/rules`);
            },

            listen(key, path) {
                document.getElementById('loading-indicator').classList.remove('hidden');
                db.ref(path).on('value', snap => {
                    const val = snap.val();
                    this.data[key] = val ? (Array.isArray(val) ? val : Object.values(val)) : (key === 'groups' ? {} : []);
                    if(key === 'students') Students.cacheMap = snap.val() || {}; // Keep object map for fast lookup
                    if(key === 'donors') Donors.cacheMap = snap.val() || {};
                    
                    document.getElementById('loading-indicator').classList.add('hidden');
                    // Trigger UI Updates based on current view
                    if(Router.current === 'dashboard') Dashboard.render();
                    if(Router.current === 'students') Students.render();
                    if(Router.current === 'finance') Finance.render();
                    if(Router.current === 'vouchers') Vouchers.render();
                    if(Router.current === 'groups') Groups.refreshUI();
                });
            },

            changeYear(newYear) {
                // Remove old listeners
                db.ref(`years/${this.year}/groups`).off();
                db.ref(`years/${this.year}/finance`).off();
                
                this.year = newYear;
                this.init(); // Re-attach listeners
                Groups.currentTab = 'night14';
                Groups.activeGroupId = null;
                Router.go('dashboard');
            },

            forceRefresh() { location.reload(); }
        };

        // --- Auth ---
        const Auth = {
            login(e) {
                e.preventDefault();
                const em = document.getElementById('email').value;
                const pw = document.getElementById('password').value;
                auth.signInWithEmailAndPassword(em, pw).catch(e => {
                    document.getElementById('login-msg').innerText = "שגיאה: " + e.message;
                    document.getElementById('login-msg').classList.remove('hidden');
                });
            },
            logout() { auth.signOut().then(() => location.reload()); },
            resetPass() {
                const e = prompt("אימייל לשחזור:");
                if(e) auth.sendPasswordResetEmail(e).then(()=>alert("נשלח!")).catch(e=>alert(e.message));
            },
            checkUser(u) {
                if(!u) {
                    document.getElementById('login-screen').classList.remove('hidden-screen');
                    return;
                }
                App.user = u;
                document.getElementById('login-screen').classList.add('hidden-screen');
                document.getElementById('sidebar').classList.remove('hidden-screen');
                document.getElementById('main-content').classList.remove('hidden-screen');
                
                // Get Role
                db.ref(`users/${u.uid}`).once('value', s => {
                    App.role = s.val()?.role || 'editor';
                    document.getElementById('display-user-role').innerText = App.role === 'admin' ? 'מנהל מערכת' : 'עורך';
                    if(App.role !== 'admin') document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden-screen'));
                    App.init();
                    Router.go('dashboard');
                });
            }
        };
        auth.onAuthStateChanged(Auth.checkUser);

        // --- Dashboard ---
        const Dashboard = {
            render() {
                let inc = 0, exp = 0;
                (App.data.finance || []).forEach(tx => {
                    if(tx.type === 'income') inc += parseFloat(tx.amount || 0);
                    else exp += parseFloat(tx.amount || 0);
                });
                
                document.getElementById('dash-income').innerText = `₪${inc.toLocaleString()}`;
                document.getElementById('dash-expense').innerText = `₪${exp.toLocaleString()}`;
                document.getElementById('dash-balance').innerText = `₪${(inc - exp).toLocaleString()}`;
                
                // Alerts
                const alertDiv = document.getElementById('dash-alerts');
                if(App.role === 'admin') {
                    const alerts = App.data.alerts || [];
                    alertDiv.innerHTML = alerts.length ? '' : '<p class="italic text-gray-400">אין התראות</p>';
                    alerts.reverse().forEach(a => {
                        alertDiv.innerHTML += `<div class="bg-white p-2 rounded border border-yellow-100 mb-1">${a.text} <span class="text-xs text-gray-400 float-left">${new Date(a.date).toLocaleDateString()}</span></div>`;
                    });
                }

                // Goal (Logic: Sum of students' current year raised)
                // Note: Real "Raised" data usually comes from linking Donations -> Student. 
                // For this demo, let's assume we calculate it from Finance tagged with studentId, or manual entry.
                const goal = 100000; // Example global goal
                document.getElementById('dash-goal').innerText = `₪${goal.toLocaleString()}`;
                document.getElementById('dash-current').innerText = `₪${inc.toLocaleString()}`;
                document.getElementById('dash-bar').style.width = Math.min(100, (inc/goal)*100) + '%';
            }
        };

        // --- Students (Lazy Load) ---
        const Students = {
            displayLimit: 20,
            cacheMap: {},
            
            filter() { this.displayLimit = 20; this.render(); },
            
            render() {
                const term = document.getElementById('search-students').value.toLowerCase();
                const tbody = document.getElementById('students-tbody');
                tbody.innerHTML = '';
                
                const all = App.data.students || [];
                const filtered = all.filter(s => (s.name||'').includes(term) || (s.grade||'').includes(term));
                
                filtered.slice(0, this.displayLimit).forEach(s => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-indigo-50 group transition">
                            <td class="p-3 font-bold text-indigo-900">${s.name}</td>
                            <td class="p-3">${s.grade || '-'}</td>
                            <td class="p-3 text-gray-500">${s.phone || '-'}</td>
                            <td class="p-3 text-center">
                                <button onclick="Modals.editStudent('${s.id}')" class="text-indigo-600 hover:bg-indigo-100 p-1 rounded"><i class="fas fa-edit"></i></button>
                                ${App.role==='admin' ? `<button onclick="Students.del('${s.id}')" class="text-red-400 hover:bg-red-50 p-1 rounded mr-2"><i class="fas fa-trash"></i></button>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('students-count').innerText = `${filtered.length} רשומות`;
                const loader = document.getElementById('students-loader');
                if(filtered.length > this.displayLimit) {
                    loader.classList.remove('hidden');
                    loader.onclick = () => { this.displayLimit += 20; this.render(); };
                } else {
                    loader.classList.add('hidden');
                }
            },
            
            del(id) { if(confirm("למחוק?")) db.ref(`students/${id}`).remove(); }
        };

        // --- Groups (Logic Heavy) ---
        const Groups = {
            currentTab: 'night14',
            activeGroupId: null,
            
            setTab(t, btn) {
                this.currentTab = t;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.activeGroupId = null;
                this.refreshUI();
            },
            
            refreshUI() {
                // Render List
                const listDiv = document.getElementById('groups-list');
                listDiv.innerHTML = '';
                const groupsMap = App.data.groups[this.currentTab] || {};
                
                Object.entries(groupsMap).forEach(([gid, g]) => {
                    const active = gid === this.activeGroupId ? 'bg-indigo-600 text-white shadow-lg transform scale-105' : 'bg-gray-50 hover:bg-indigo-50';
                    listDiv.innerHTML += `
                        <div onclick="Groups.select('${gid}')" class="p-3 rounded cursor-pointer transition ${active} mb-1 border border-transparent">
                            <div class="font-bold text-sm">${g.name}</div>
                            <div class="text-xs opacity-75">${(g.members||[]).length} בחורים</div>
                        </div>
                    `;
                });
                
                // Render Editor Content
                const empty = document.getElementById('group-empty-state');
                const content = document.getElementById('group-content');
                
                if(this.activeGroupId && groupsMap[this.activeGroupId]) {
                    empty.classList.add('hidden');
                    content.classList.remove('hidden');
                    document.getElementById('active-group-name').innerText = groupsMap[this.activeGroupId].name;
                    this.renderMembers();
                    this.renderRoute();
                } else {
                    empty.classList.remove('hidden');
                    content.classList.add('hidden');
                }
            },

            select(gid) { this.activeGroupId = gid; this.refreshUI(); },
            
            addGroup() {
                const n = prompt("שם קבוצה:");
                if(n) db.ref(`years/${App.year}/groups/${this.currentTab}`).push({name:n, members:[], route:[]});
            },

            setView(v) {
                document.getElementById('view-sub-members').classList.add('hidden');
                document.getElementById('view-sub-route').classList.add('hidden');
                document.getElementById('view-sub-'+v).classList.remove('hidden');
                
                // Style Tabs
                const btnM = document.getElementById('btn-view-members');
                const btnR = document.getElementById('btn-view-route');
                if(v === 'members') {
                    btnM.className = "flex-1 py-2 text-sm font-bold border-b-2 border-indigo-600 bg-indigo-50/50";
                    btnR.className = "flex-1 py-2 text-sm text-gray-500 hover:bg-gray-50";
                } else {
                    btnR.className = "flex-1 py-2 text-sm font-bold border-b-2 border-indigo-600 bg-indigo-50/50";
                    btnM.className = "flex-1 py-2 text-sm text-gray-500 hover:bg-gray-50";
                }
            },

            // Members Logic
            renderMembers() {
                const group = App.data.groups[this.currentTab][this.activeGroupId];
                const members = group.members || [];
                const memDiv = document.getElementById('group-members');
                memDiv.innerHTML = '';

                members.forEach((m, idx) => {
                    const s = Students.cacheMap[m.id] || {name:'?'};
                    memDiv.innerHTML += `
                        <div class="p-2 bg-indigo-50 border border-indigo-100 rounded flex justify-between items-center text-sm">
                            <div><span class="font-bold">${s.name}</span> <span class="text-xs text-indigo-600">(${m.role})</span></div>
                            <div>
                                <i onclick="Groups.setRole(${idx}, 'ראש חוליה')" class="fas fa-crown text-yellow-500 cursor-pointer mr-2" title="הגדר ראש חוליה"></i>
                                <i onclick="Groups.removeMember(${idx})" class="fas fa-times text-red-400 cursor-pointer"></i>
                            </div>
                        </div>
                    `;
                });
                this.filterPool('');
            },

            filterPool(term) {
                const poolDiv = document.getElementById('pool-students');
                poolDiv.innerHTML = '';
                
                // Get all students currently assigned in THIS time slot (any group)
                const assignedIds = new Set();
                const allGroups = App.data.groups[this.currentTab] || {};
                Object.values(allGroups).forEach(g => {
                    (g.members||[]).forEach(m => assignedIds.add(m.id));
                });

                App.data.students.filter(s => 
                    !assignedIds.has(s.id) && s.name.includes(term)
                ).slice(0, 30).forEach(s => {
                    poolDiv.innerHTML += `
                        <div onclick="Groups.addMember('${s.id}')" class="p-2 bg-white border border-gray-200 rounded mb-1 cursor-pointer hover:bg-green-50 flex justify-between group">
                            <span class="text-sm">${s.name}</span>
                            <i class="fas fa-plus text-green-600 opacity-0 group-hover:opacity-100"></i>
                        </div>
                    `;
                });
            },

            addMember(sid) {
                const path = `years/${App.year}/groups/${this.currentTab}/${this.activeGroupId}/members`;
                const list = App.data.groups[this.currentTab][this.activeGroupId].members || [];
                list.push({id: sid, role: 'חבר'});
                db.ref(path).set(list);
            },
            
            removeMember(idx) {
                const path = `years/${App.year}/groups/${this.currentTab}/${this.activeGroupId}/members`;
                const list = App.data.groups[this.currentTab][this.activeGroupId].members;
                list.splice(idx, 1);
                db.ref(path).set(list);
            },
            
            setRole(idx, r) {
                 db.ref(`years/${App.year}/groups/${this.currentTab}/${this.activeGroupId}/members/${idx}/role`).set(r);
            },

            // Route Logic
            renderRoute() {
                const group = App.data.groups[this.currentTab][this.activeGroupId];
                const routeDiv = document.getElementById('group-route');
                routeDiv.innerHTML = '';
                
                (group.route || []).forEach(did => {
                    const d = Donors.cacheMap[did] || {name:'?', address:''};
                    const el = document.createElement('div');
                    el.className = "p-2 bg-white border rounded shadow-sm text-sm flex justify-between items-center drag-handle mb-1";
                    el.dataset.id = did;
                    el.innerHTML = `<div><div class="font-bold">${d.name}</div><div class="text-xs text-gray-500">${d.address}</div></div><i class="fas fa-bars text-gray-300"></i>`;
                    routeDiv.appendChild(el);
                });

                new Sortable(routeDiv, {
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: () => {
                        const newOrder = Array.from(routeDiv.children).map(c => c.dataset.id);
                        db.ref(`years/${App.year}/groups/${this.currentTab}/${this.activeGroupId}/route`).set(newOrder);
                    }
                });
                this.filterDonors('');
            },

            filterDonors(term) {
                const poolDiv = document.getElementById('pool-donors');
                poolDiv.innerHTML = '';
                const currentRoute = new Set(App.data.groups[this.currentTab][this.activeGroupId].route || []);
                
                App.data.donors.filter(d => !currentRoute.has(d.id) && (d.name.includes(term) || (d.address||'').includes(term))).slice(0, 20).forEach(d => {
                     poolDiv.innerHTML += `
                        <div onclick="Groups.addToRoute('${d.id}')" class="p-2 bg-white border mb-1 rounded text-sm cursor-pointer hover:bg-green-50">
                            <div class="font-bold">${d.name}</div>
                            <div class="text-xs text-gray-500">${d.address || ''}</div>
                        </div>
                    `;
                });
            },

            addToRoute(did) {
                 const path = `years/${App.year}/groups/${this.currentTab}/${this.activeGroupId}/route`;
                 const list = App.data.groups[this.currentTab][this.activeGroupId].route || [];
                 list.push(did);
                 db.ref(path).set(list);
            },

            // PRINT
            printRoute() {
                const g = App.data.groups[this.currentTab][this.activeGroupId];
                // Years calculation based on current Hebrew year string is complex, let's hardcode relative to integer for demo or use mapped values
                // Simulating years:
                const mapY = {"תשפ״ג":2023, "תשפ״ד":2024, "תשפ״ה":2025};
                const curInt = mapY[App.year] || 2025;
                const prev1 = curInt - 1; 
                const prev2 = curInt - 2; 
                const prev3 = curInt - 3;

                let html = `
                    <div style="text-align:center; margin-bottom:10px;">
                        <h1>מסלול: ${g.name}</h1>
                        <h3>זמן: ${document.querySelector('.tab-btn.active').innerText} | שנה: ${App.year}</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width:30px">#</th>
                                <th>פרטי תורם</th>
                                <th>${prev3}</th>
                                <th>${prev2}</th>
                                <th>${prev1}</th>
                                <th>הערות</th>
                                <th style="width:120px">סכום ${App.year}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                (g.route || []).forEach((did, idx) => {
                    const d = Donors.cacheMap[did];
                    if(!d) return;
                    const h = d.history || {};
                    html += `
                        <tr>
                            <td>${idx+1}</td>
                            <td><b>${d.name}</b><br>${d.address||''}</td>
                            <td>${h[prev3] || ''}</td>
                            <td>${h[prev2] || ''}</td>
                            <td>${h[prev1] || ''}</td>
                            <td>${d.remarks || ''}</td>
                            <td></td> <!-- Empty for handwriting -->
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                document.getElementById('print-area').innerHTML = html;
                window.print();
            }
        };

        // --- Donors ---
        const Donors = {
            cacheMap: {},
            render(term='') {
                const grid = document.getElementById('donors-grid');
                grid.innerHTML = '';
                
                App.data.donors.filter(d => d.name.includes(term)).slice(0, 30).forEach(d => {
                    grid.innerHTML += `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:border-indigo-300 transition">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-gray-800">${d.name}</div>
                                    <div class="text-sm text-gray-500"><i class="fas fa-map-marker-alt w-4"></i> ${d.address || 'אין כתובת'}</div>
                                    <div class="text-xs text-indigo-500 mt-1">מביא: ${d.referrer || '-'}</div>
                                </div>
                                <button onclick="Modals.editDonor('${d.id}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-pen"></i></button>
                            </div>
                        </div>
                    `;
                });
            }
        };

        // --- Finance ---
        const Finance = {
            render() {
                // Render Tabs
                const tabsDiv = document.getElementById('finance-years-tabs');
                tabsDiv.innerHTML = '';
                ["תשפ״ג", "תשפ״ד", "תשפ״ה"].forEach(y => {
                     const active = y === App.year ? 'border-indigo-600 text-indigo-600 font-bold' : 'border-transparent hover:text-gray-600';
                     tabsDiv.innerHTML += `<div onclick="App.changeYear('${y}')" class="cursor-pointer px-4 py-2 text-sm border-b-2 ${active}">${y}</div>`;
                });

                const tbody = document.getElementById('finance-tbody');
                tbody.innerHTML = '';
                const list = App.data.finance || [];
                
                list.sort((a,b) => b.date - a.date).forEach(tx => {
                     const color = tx.type === 'income' ? 'text-green-600' : 'text-red-600';
                     tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b last:border-0">
                            <td class="p-3 text-gray-500">${new Date(tx.date).toLocaleDateString('he-IL')}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${tx.type==='income'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${tx.type==='income'?'הכנסה':'הוצאה'}</span></td>
                            <td class="p-3 font-bold">${tx.category || '-'}</td>
                            <td class="p-3">${tx.method || '-'}</td>
                            <td class="p-3 font-bold ${color}" dir="ltr">₪${parseFloat(tx.amount).toLocaleString()}</td>
                            <td class="p-3"><button onclick="Finance.del('${tx.id}')" class="text-red-300 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                        </tr>
                     `;
                });
            },
            
            addTx(data) {
                const id = 'tx' + Date.now();
                db.ref(`years/${App.year}/finance/${id}`).set({...data, id, date: Date.now()});
                Modals.close('form');
            },

            del(id) { if(confirm('למחוק?')) db.ref(`years/${App.year}/finance/${id}`).remove(); },

            exportPDF() {
                window.print(); // Simple print using CSS media query is best for Hebrew
            },
            
            exportExcel() {
                // Populate picker
                const container = document.getElementById('export-cols');
                container.innerHTML = '';
                ['תאריך', 'סוג', 'קטגוריה', 'אמצעי תשלום', 'סכום'].forEach(c => {
                    container.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${c}" checked> ${c}</label>`;
                });
                Modals.open('export');
            },

            doExcelExport() {
                 const selected = Array.from(document.querySelectorAll('#export-cols input:checked')).map(c=>c.value);
                 // Map keys
                 const keyMap = {'תאריך':'date', 'סוג':'type', 'קטגוריה':'category', 'אמצעי תשלום':'method', 'סכום':'amount'};
                 
                 const data = (App.data.finance||[]).map(tx => {
                     const row = {};
                     selected.forEach(h => {
                         let val = tx[keyMap[h]];
                         if(h === 'תאריך') val = new Date(val).toLocaleDateString();
                         if(h === 'סוג') val = val==='income'?'הכנסה':'הוצאה';
                         row[h] = val;
                     });
                     return row;
                 });
                 
                 const ws = XLSX.utils.json_to_sheet(data);
                 const wb = XLSX.utils.book_new();
                 XLSX.utils.book_append_sheet(wb, ws, "Finance");
                 XLSX.writeFile(wb, `Finance_${App.year}.xlsx`);
                 Modals.close('export');
            }
        };

        // --- Vouchers & Gifts ---
        const Vouchers = {
            render() {
                // Render Rules
                const rulesDiv = document.getElementById('gift-rules-container');
                rulesDiv.innerHTML = '';
                const rules = App.data.rules || []; // [{target: 1000, gift: 'Book'}, ...]
                
                rules.forEach((r, i) => {
                    rulesDiv.innerHTML += `
                        <div class="flex gap-2 items-center bg-gray-50 p-2 rounded border">
                            <span>יעד:</span>
                            <input type="number" value="${r.target}" class="w-24 border p-1 rounded" onchange="Vouchers.updateRule(${i}, 'target', this.value)">
                            <span>₪ = מתנה:</span>
                            <input type="text" value="${r.gift}" class="flex-1 border p-1 rounded" onchange="Vouchers.updateRule(${i}, 'gift', this.value)">
                            <button onclick="Vouchers.delRule(${i})" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                });

                // Render Eligibility (Simulation)
                // In real app: loop students, calc total raised, check rules
                const tbody = document.getElementById('eligible-tbody');
                tbody.innerHTML = '';
                // Fake Calculation for Demo
                if(App.data.students.length > 0) {
                     // Assume first student raised 5000
                     const s = App.data.students[0];
                     tbody.innerHTML += `
                        <tr>
                            <td class="p-2">${s.name}</td>
                            <td class="p-2 font-bold">₪5,000</td>
                            <td class="p-2 text-green-600">סט ש"ס (הגיע ליעד 4000)</td>
                            <td class="p-2"><button class="bg-indigo-600 text-white text-xs px-2 py-1 rounded">הנפק שובר</button></td>
                        </tr>
                     `;
                }
            },
            
            addRule() {
                const list = App.data.rules || [];
                list.push({target: 0, gift: ''});
                db.ref('settings/rules').set(list);
            },
            updateRule(i, k, v) {
                db.ref(`settings/rules/${i}/${k}`).set(k==='target'?parseInt(v):v);
            },
            delRule(i) {
                const list = App.data.rules;
                list.splice(i, 1);
                db.ref('settings/rules').set(list);
            },
            saveRules() { alert('נשמר אוטומטית'); }
        };

        // --- Settings ---
        const Settings = {
            addUser() {
                const email = document.getElementById('new-u-email').value;
                if(!email) return;
                alert('במערכת אמיתית: כאן תשלח הזמנה או תיצור משתמש ב-Firebase Auth via Cloud Function. כרגע זה הדגמת ממשק.');
                document.getElementById('users-list').innerHTML += `<li class="flex justify-between bg-gray-50 p-2"><span>${email}</span> <span class="font-bold text-gray-500">${document.getElementById('new-u-role').value}</span></li>`;
            }
        };

        // --- Excel Engine ---
        const Excel = {
            type: null,
            data: null,
            
            init(t) {
                this.type = t;
                const titles = {students: 'יבוא בחורים', donors: 'יבוא תורמים', finance: 'יבוא היסטוריית כספים'};
                document.getElementById('excel-type-title').innerText = titles[t];
                document.getElementById('excel-step-1').classList.remove('hidden');
                document.getElementById('excel-step-2').classList.add('hidden');
                document.getElementById('excel-btn-process').classList.add('hidden');
                Modals.open('excel');
            },

            parseFile() {
                const f = document.getElementById('excel-file').files[0];
                const r = new FileReader();
                r.onload = e => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    this.data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(this.data.length) this.showMapping(Object.keys(this.data[0]));
                };
                r.readAsArrayBuffer(f);
            },

            showMapping(headers) {
                document.getElementById('excel-step-1').classList.add('hidden');
                document.getElementById('excel-step-2').classList.remove('hidden');
                document.getElementById('excel-btn-process').classList.remove('hidden');
                
                const mapDiv = document.getElementById('excel-mapping');
                mapDiv.innerHTML = '';
                
                const fields = this.type === 'students' ? [
                    {k:'name', l:'שם מלא'}, {k:'grade', l:'שיעור'}, {k:'phone', l:'טלפון'}
                ] : this.type === 'donors' ? [
                    {k:'name', l:'שם תורם'}, {k:'address', l:'כתובת'}, {k:'referrer', l:'מביא התורם'}
                ] : [
                    {k:'date', l:'תאריך'}, {k:'amount', l:'סכום'}, {k:'type', l:'סוג (inc/exp)'}
                ];

                fields.forEach(f => {
                    const opts = headers.map(h => `<option value="${h}">${h}</option>`).join('');
                    mapDiv.innerHTML += `
                        <div class="flex items-center justify-between border-b pb-2">
                            <span>${f.l}</span>
                            <select id="map-${f.k}" class="border bg-white p-1 rounded w-1/2">
                                <option value="">-- בחר עמודה --</option>
                                ${opts}
                            </select>
                        </div>
                    `;
                });
            },

            process() {
                const updates = {};
                let c = 0;
                
                this.data.forEach((row, i) => {
                    const obj = {};
                    const inputs = document.querySelectorAll('[id^="map-"]');
                    inputs.forEach(inp => {
                        const key = inp.id.replace('map-', '');
                        if(inp.value) obj[key] = row[inp.value];
                    });
                    
                    if(this.type === 'students' && obj.name) {
                        const id = 's' + Date.now() + i;
                        updates[`students/${id}`] = {id, ...obj};
                    } 
                    else if(this.type === 'donors' && obj.name) {
                        const id = 'd' + Date.now() + i;
                        updates[`donors/${id}`] = {id, ...obj};
                    }
                    else if(this.type === 'finance' && obj.amount) {
                         const id = 'tx' + Date.now() + i;
                         updates[`years/${App.year}/finance/${id}`] = {id, ...obj, type: (obj.type||'').includes('ex') ? 'expense' : 'income'};
                    }
                    c++;
                });

                db.ref().update(updates).then(() => {
                    alert(`נקלטו ${c} רשומות!`);
                    Modals.close('excel');
                });
            }
        };

        // --- Infrastructure ---
        const UI = {
            toggleMenu(id) {
                const el = document.getElementById(id);
                el.classList.toggle('open');
            }
        };

        const Modals = {
            open(id) { document.getElementById('modal-'+id).classList.remove('hidden-screen'); },
            close(id) { document.getElementById('modal-'+id).classList.add('hidden-screen'); },
            
            studentForm() {
                this.renderGenForm('הוספת בחור', [
                    {id:'nm', l:'שם מלא'}, {id:'gr', l:'שיעור'}, {id:'ph', l:'טלפון'}
                ], (v) => {
                    const id = 's'+Date.now();
                    db.ref('students/'+id).set({id, name:v.nm, grade:v.gr, phone:v.ph});
                });
            },
            donorForm() {
                 this.renderGenForm('הוספת תורם', [
                    {id:'nm', l:'שם תורם'}, {id:'ad', l:'כתובת'}, {id:'rf', l:'שם הבחור המביא'}
                ], (v) => {
                    const id = 'd'+Date.now();
                    db.ref('donors/'+id).set({id, name:v.nm, address:v.ad, referrer:v.rf});
                });
            },
            transactionForm(type) {
                const title = type==='income' ? 'הוספת הכנסה' : 'הוספת הוצאה';
                this.renderGenForm(title, [
                    {id:'am', l:'סכום', t:'number'}, {id:'ca', l:'קטגוריה (תרומה/אוטובוס...)'}, {id:'me', l:'אמצעי תשלום'}
                ], (v) => {
                    Finance.addTx({type, amount:v.am, category:v.ca, method:v.me});
                });
            },

            renderGenForm(title, fields, cb) {
                document.getElementById('form-title').innerText = title;
                const c = document.getElementById('form-content');
                c.innerHTML = '';
                fields.forEach(f => c.innerHTML += `<div class="mb-2"><label class="text-xs text-gray-500">${f.l}</label><input id="f-${f.id}" type="${f.t||'text'}" class="w-full border p-2 rounded"></div>`);
                
                const btn = document.getElementById('form-btn-save');
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.onclick = () => {
                    const val = {};
                    fields.forEach(f => val[f.id] = document.getElementById('f-'+f.id).value);
                    cb(val);
                    this.close('form');
                };
                this.open('form');
            },
            
            editStudent(id) {
                const s = App.data.students.find(x => x.id === id);
                if(!s) return;
                this.renderGenForm('עריכת בחור', [
                    {id:'nm', l:'שם מלא'}, {id:'gr', l:'שיעור'}, {id:'ph', l:'טלפון'}
                ], (v) => {
                    db.ref('students/'+id).update({name:v.nm, grade:v.gr, phone:v.ph});
                });
                // Fill values
                setTimeout(() => {
                    document.getElementById('f-nm').value = s.name;
                    document.getElementById('f-gr').value = s.grade || '';
                    document.getElementById('f-ph').value = s.phone || '';
                }, 100);
            },
            
            editDonor(id) {
                const d = App.data.donors.find(x => x.id === id);
                this.renderGenForm('עריכת תורם', [
                    {id:'nm', l:'שם תורם'}, {id:'ad', l:'כתובת'}, {id:'rf', l:'מביא'}
                ], (v) => {
                    db.ref('donors/'+id).update({name:v.nm, address:v.ad, referrer:v.rf});
                });
                 setTimeout(() => {
                    document.getElementById('f-nm').value = d.name;
                    document.getElementById('f-ad').value = d.address || '';
                    document.getElementById('f-rf').value = d.referrer || '';
                }, 100);
            }
        };

        const Router = {
            current: 'dashboard',
            go(view) {
                this.current = view;
                document.querySelectorAll('.view').forEach(e => e.classList.add('hidden-screen'));
                document.getElementById('view-'+view).classList.remove('hidden-screen');
                
                const titles = {dashboard:'דף הבית', students:'ניהול בחורים', groups:'קבוצות ומסלולים', donors:'ניהול תורמים', finance:'ניהול קופה', vouchers:'זכאות', settings:'הגדרות'};
                document.getElementById('page-title').innerText = titles[view];
                
                // Trigger renders
                if(view === 'students') Students.render();
                if(view === 'donors') Donors.render();
                if(view === 'finance') Finance.render();
                if(view === 'vouchers') Vouchers.render();
                if(view === 'groups') Groups.refreshUI();
            }
        };

    </script>
</body>
</html>
