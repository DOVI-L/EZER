<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול - עזר חתנים</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* הגדרות בסיס ועיצוב */
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');
        body { font-family: 'Rubik', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        
        /* גלילה מותאמת */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* אנימציות ומעברים */
        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* סגנונות מיוחדים להדפסה (PDF/Route Sheet) */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 99999; direction: rtl; padding: 0; margin: 0; }
            @page { size: A4; margin: 10mm; }
            .print-table { width: 100%; border-collapse: collapse; font-size: 12px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 4px; text-align: right; }
            .print-header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; }
            .no-print { display: none !important; }
        }
        #print-area { display: none; }
        
        /* הסתרת אלמנטים פיננסיים למשתמשים רגילים */
        body.role-user .financial-data { display: none !important; }
        body.role-user .admin-only { display: none !important; }

        /* עיצוב לוגו */
        .logo-img-login { max-height: 120px; width: auto; margin: 0 auto 1.5rem auto; display: block; }
        .logo-img-sidebar { max-height: 50px; width: auto; max-width: 100%; object-fit: contain; }
    </style>
</head>
<body class="h-screen flex text-gray-800">

    <!-- אזור הדפסה -->
    <div id="print-area"></div>

    <!-- מסך טעינה -->
    <div id="loader" class="fixed inset-0 z-[100] bg-indigo-900 flex flex-col justify-center items-center transition-opacity duration-500">
        <div id="loader-spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <h2 id="loader-text" class="text-white text-xl font-bold">טוען מערכת...</h2>
        
        <!-- אזור הודעת שגיאה שיופיע במידה ונתקע -->
        <div id="loader-error" class="hidden text-center mt-6 p-4 bg-red-800/80 rounded-lg max-w-md mx-4">
            <div class="text-red-200 text-lg font-bold mb-2"><i class="fas fa-exclamation-triangle"></i> התחברות נכשלת</div>
            <p class="text-white text-sm mb-4">המערכת לא מצליחה להתחבר לשרת. ייתכן שיש בעיה בחיבור לאינטרנט או בהגדרות ה-Firebase.</p>
            <button onclick="location.reload()" class="bg-white text-red-900 px-4 py-2 rounded font-bold hover:bg-gray-200 transition">נסה שוב</button>
        </div>
    </div>

    <!-- מסך התחברות -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col justify-center items-center hidden-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center">
            
            <!-- שינוי לוגו (1.JPG) -->
            <img src="1.JPG" alt="לוגו מערכת" class="logo-img-login" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <div class="hidden text-indigo-700 text-5xl mb-4"><i class="fas fa-synagogue"></i></div> <!-- גיבוי אם אין תמונה -->
            
            <p class="text-gray-500 mb-6 text-sm font-bold mt-2">ניהול מערכת - כניסה מאובטחת</p>
            <form onsubmit="Auth.login(event)" class="space-y-4">
                <input type="email" id="email" placeholder="אימייל" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                <input type="password" id="password" placeholder="סיסמה" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition shadow-lg transform active:scale-95">כניסה</button>
            </form>
            <div id="login-msg" class="text-red-500 text-sm mt-4 hidden font-bold"></div>
        </div>
    </div>

    <!-- תפריט צד -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-slate-100 flex flex-col hidden-screen shadow-xl z-20">
        <div class="p-6 border-b border-slate-800 flex items-center justify-center bg-slate-950 h-24">
            <!-- לוגו בתפריט (1.JPG) -->
            <img src="1.JPG" alt="לוגו" class="logo-img-sidebar" onerror="this.outerHTML='<h2 class=\'font-bold text-lg\'>עזר חתנים</h2>'">
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="Router.go('dashboard')" class="nav-btn w-full text-right px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 border-r-4 border-transparent hover:border-indigo-500">
                <i class="fas fa-chart-line w-5 text-center"></i> לוח מחוונים
            </button>
            
            <div class="px-6 py-2 text-xs font-bold text-slate-500 uppercase mt-2">נתונים</div>
            <button onclick="Router.go('students')" class="nav-btn w-full text-right px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 border-r-4 border-transparent hover:border-indigo-500">
                <i class="fas fa-user-graduate w-5 text-center"></i> בחורים
            </button>
            <button onclick="Router.go('donors')" class="nav-btn w-full text-right px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 border-r-4 border-transparent hover:border-indigo-500">
                <i class="fas fa-hand-holding-heart w-5 text-center"></i> תורמים
            </button>
            <button onclick="Router.go('groups')" class="nav-btn w-full text-right px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 border-r-4 border-transparent hover:border-indigo-500">
                <i class="fas fa-users w-5 text-center"></i> קבוצות ומסלולים
            </button>

            <div class="px-6 py-2 text-xs font-bold text-slate-500 uppercase mt-2 financial-data">כספים ודוחות</div>
            <button onclick="Router.go('finance')" class="nav-btn financial-data w-full text-right px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 border-r-4 border-transparent hover:border-indigo-500">
                <i class="fas fa-cash-register w-5 text-center"></i> ניהול קופה
            </button>
            <button onclick="Router.go('reports')" class="nav-btn financial-data w-full text-right px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 border-r-4 border-transparent hover:border-indigo-500">
                <i class="fas fa-file-invoice-dollar w-5 text-center"></i> דוחות והדפסות
            </button>
            
            <div class="px-6 py-2 text-xs font-bold text-slate-500 uppercase mt-2 admin-only">מנהל</div>
            <button onclick="Router.go('settings')" class="nav-btn admin-only w-full text-right px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 border-r-4 border-transparent hover:border-indigo-500">
                <i class="fas fa-cogs w-5 text-center"></i> הגדרות וזכאות
            </button>
        </nav>

        <div class="p-4 bg-slate-950 border-t border-slate-800">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-user text-xs"></i></div>
                <div class="text-xs">
                    <div id="user-email-display" class="font-bold truncate w-32">user@sys</div>
                    <div id="user-role-display" class="text-slate-400">טוען...</div>
                </div>
            </div>
            <button onclick="Auth.logout()" class="w-full bg-slate-800 hover:bg-red-900/50 text-slate-300 hover:text-white py-2 rounded text-xs transition">יציאה</button>
        </div>
    </aside>

    <!-- תוכן ראשי -->
    <main id="main-content" class="flex-1 flex flex-col hidden-screen h-full overflow-hidden relative">
        
        <!-- כותרת עליונה -->
        <header class="bg-white shadow-sm h-16 flex justify-between items-center px-6 z-10 shrink-0">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-xl font-bold text-slate-800">דף הבית</h2>
                <div id="sync-status" class="text-xs px-2 py-1 rounded bg-green-100 text-green-700 hidden"><i class="fas fa-check"></i> מסונכרן</div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="text-sm text-gray-500 ml-2">שנה נוכחית:</div>
                <select id="year-selector" onchange="System.changeYear(this.value)" class="bg-slate-100 border-none text-slate-800 py-1.5 px-3 rounded-lg text-sm font-bold focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                    <!-- שנים יטענו דינמית -->
                </select>
            </div>
        </header>

        <!-- מיכל תצוגות -->
        <div id="views-container" class="flex-1 overflow-hidden relative bg-slate-50">
            
            <!-- 1. DASHBOARD -->
            <div id="view-dashboard" class="view-section p-6 h-full overflow-y-auto fade-in hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6 financial-data">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-r-4 border-indigo-500">
                        <div class="text-gray-500 text-sm font-bold mb-1">יתרה בקופה (כללי)</div>
                        <div class="text-2xl font-bold text-slate-800" id="dash-total-balance">₪0</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-r-4 border-green-500">
                        <div class="text-gray-500 text-sm font-bold mb-1">הכנסות (<span class="curr-year"></span>)</div>
                        <div class="text-2xl font-bold text-green-600" id="dash-income">₪0</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-r-4 border-red-500">
                        <div class="text-gray-500 text-sm font-bold mb-1">הוצאות (<span class="curr-year"></span>)</div>
                        <div class="text-2xl font-bold text-red-600" id="dash-expense">₪0</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-r-4 border-yellow-500">
                        <div class="text-gray-500 text-sm font-bold mb-1">גיוס יעד (<span class="curr-year"></span>)</div>
                        <div class="text-2xl font-bold text-yellow-600" id="dash-goal-progress">0%</div>
                        <div class="w-full bg-gray-200 h-1.5 mt-2 rounded-full"><div id="dash-bar" class="bg-yellow-500 h-1.5 rounded-full" style="width:0%"></div></div>
                    </div>
                </div>

                <!-- התראות ומשימות -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[calc(100%-120px)]">
                    <div class="bg-white rounded-xl shadow-sm flex flex-col">
                        <div class="p-4 border-b font-bold text-slate-700 flex justify-between">
                            <span><i class="fas fa-bell text-indigo-500"></i> עדכונים אחרונים</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">פעילות חיה</span>
                        </div>
                        <div id="dash-logs" class="p-4 overflow-y-auto flex-1 space-y-3 text-sm"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm flex flex-col">
                        <div class="p-4 border-b font-bold text-slate-700">
                            <span><i class="fas fa-chart-pie text-indigo-500"></i> סטטוס רישום (<span class="curr-year"></span>)</span>
                        </div>
                        <div class="p-4 grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded text-center">
                                <div class="text-3xl font-bold text-blue-600" id="dash-stat-students">0</div>
                                <div class="text-xs text-blue-400">בחורים רשומים</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded text-center">
                                <div class="text-3xl font-bold text-purple-600" id="dash-stat-donors">0</div>
                                <div class="text-xs text-purple-400">תורמים פעילים</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. STUDENTS -->
            <div id="view-students" class="view-section h-full flex flex-col hidden fade-in">
                <div class="p-4 bg-white border-b flex gap-3 items-center shadow-sm z-10">
                    <button onclick="Students.openAddModal()" class="btn-primary"><i class="fas fa-plus"></i> הוסף בחור</button>
                    <button onclick="Importer.init('students')" class="btn-secondary"><i class="fas fa-file-excel"></i> יבוא/עדכון</button>
                    <div class="flex-1 relative">
                        <input type="text" id="student-search" oninput="Students.handleSearch(this.value)" placeholder="חפש לפי שם, שיעור, טלפון..." class="input-field w-full pl-4 pr-10">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="students-container">
                    <table class="w-full bg-white shadow rounded-lg overflow-hidden text-sm">
                        <thead class="bg-slate-100 text-slate-600 sticky top-0 shadow-sm">
                            <tr>
                                <th class="p-3 text-right">שם מלא</th>
                                <th class="p-3 text-right">שיעור (נוכחי)</th>
                                <th class="p-3 text-right">שנת כניסה</th>
                                <th class="p-3 text-right">יעד אישי (<span class="curr-year"></span>)</th>
                                <th class="p-3 text-center">פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="students-tbody" class="divide-y divide-slate-100"></tbody>
                    </table>
                    <div id="students-loader-more" class="p-4 text-center">
                        <button onclick="Students.loadMore()" class="text-indigo-600 hover:underline">טען עוד...</button>
                    </div>
                </div>
            </div>

            <!-- 3. DONORS -->
            <div id="view-donors" class="view-section h-full flex flex-col hidden fade-in">
                <div class="p-4 bg-white border-b flex gap-3 items-center shadow-sm z-10">
                    <button onclick="Donors.openAddModal()" class="btn-primary"><i class="fas fa-plus"></i> הוסף תורם</button>
                    <button onclick="Importer.init('donors')" class="btn-secondary"><i class="fas fa-file-excel"></i> יבוא</button>
                    <div class="flex-1 relative">
                        <input type="text" oninput="Donors.handleSearch(this.value)" placeholder="חפש תורם..." class="input-field w-full pl-4 pr-10">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="donors-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-4"></div>
                    <div id="donors-loader-more" class="p-4 text-center mt-4">
                        <button onclick="Donors.loadMore()" class="text-indigo-600 hover:underline">טען עוד...</button>
                    </div>
                </div>
            </div>

            <!-- 4. GROUPS -->
            <div id="view-groups" class="view-section h-full flex flex-col hidden fade-in">
                <!-- טאבים לימים -->
                <div class="bg-white px-4 pt-2 border-b flex gap-1">
                    <button onclick="Groups.setDay('night14')" class="group-tab active" data-day="night14">ליל י"ד</button>
                    <button onclick="Groups.setDay('day14')" class="group-tab" data-day="day14">יום י"ד</button>
                    <button onclick="Groups.setDay('day15')" class="group-tab" data-day="day15">יום ט"ו</button>
                </div>

                <div class="flex flex-1 overflow-hidden">
                    <!-- רשימת קבוצות -->
                    <div class="w-72 bg-white border-l flex flex-col">
                        <div class="p-3 border-b flex justify-between items-center bg-gray-50">
                            <span class="font-bold text-sm">רשימת קבוצות</span>
                            <button onclick="Groups.addNewGroup()" class="text-indigo-600 hover:bg-indigo-100 p-1 rounded"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="groups-list" class="flex-1 overflow-y-auto"></div>
                    </div>

                    <!-- אזור עבודה -->
                    <div class="flex-1 flex flex-col bg-slate-50 relative" id="group-workspace">
                        <div id="group-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-people-arrows text-4xl mb-2"></i>
                                <p>בחר קבוצה לעריכה</p>
                            </div>
                        </div>

                        <div id="group-editor" class="hidden flex flex-col h-full">
                            <!-- כותרת הקבוצה -->
                            <div class="bg-white p-3 border-b flex justify-between items-center">
                                <div class="flex gap-2 items-center">
                                    <h3 id="active-group-name" class="font-bold text-lg cursor-pointer hover:bg-gray-100 px-2 rounded" onclick="Groups.renameGroup()"></h3>
                                    <span id="active-group-count" class="text-xs bg-gray-200 px-2 rounded-full">0 בחורים</span>
                                </div>
                                <div class="flex gap-2 text-sm">
                                    <button onclick="Groups.addQuickDonation()" class="bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200"><i class="fas fa-shekel-sign"></i> הכנסה לקבוצה</button>
                                    <button onclick="Groups.printSheet('members')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200"><i class="fas fa-list"></i> דף שמי</button>
                                    <button onclick="Groups.printSheet('route')" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-200"><i class="fas fa-route"></i> דף מסלול</button>
                                </div>
                            </div>

                            <div class="flex flex-1 overflow-hidden">
                                <!-- עמודת שיבוץ בחורים -->
                                <div class="w-1/2 flex flex-col border-l">
                                    <div class="p-2 bg-indigo-50 font-bold text-xs text-indigo-800 text-center">שיבוץ בחורים (גרירה)</div>
                                    <div class="flex-1 flex overflow-hidden">
                                        <div class="w-1/2 flex flex-col border-l bg-white">
                                            <input type="text" placeholder="חפש בחור פנוי..." oninput="Groups.filterStudents(this.value)" class="p-2 border-b text-sm">
                                            <div id="pool-students" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                                        </div>
                                        <div class="w-1/2 flex flex-col bg-indigo-50/30">
                                            <div class="text-xs p-1 text-center text-gray-400">חברי הקבוצה</div>
                                            <div id="group-members-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- עמודת מסלול תורמים -->
                                <div class="w-1/2 flex flex-col">
                                    <div class="p-2 bg-green-50 font-bold text-xs text-green-800 text-center">מסלול תורמים (גרירה)</div>
                                    <div class="flex-1 flex overflow-hidden">
                                        <div class="w-1/2 flex flex-col border-l bg-white">
                                            <input type="text" placeholder="חפש תורם..." oninput="Groups.filterDonors(this.value)" class="p-2 border-b text-sm">
                                            <div id="pool-donors" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                                        </div>
                                        <div class="w-1/2 flex flex-col bg-green-50/30">
                                            <div class="text-xs p-1 text-center text-gray-400">סדר המסלול</div>
                                            <div id="group-route-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. FINANCE -->
            <div id="view-finance" class="view-section h-full flex flex-col hidden fade-in financial-data">
                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm">
                    <div class="flex gap-2">
                         <button onclick="Finance.openTransactionModal('income')" class="btn-primary bg-green-600 hover:bg-green-700 border-none"><i class="fas fa-plus"></i> הכנסה</button>
                         <button onclick="Finance.openTransactionModal('expense')" class="btn-primary bg-red-600 hover:bg-red-700 border-none"><i class="fas fa-minus"></i> הוצאה</button>
                    </div>
                    <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                        <button onclick="Finance.setFilter('all')" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-indigo-600 finance-filter active" data-f="all">הכל</button>
                        <button onclick="Finance.setFilter('income')" class="px-3 py-1 rounded text-sm text-gray-600 hover:bg-gray-200 finance-filter" data-f="income">הכנסות</button>
                        <button onclick="Finance.setFilter('expense')" class="px-3 py-1 rounded text-sm text-gray-600 hover:bg-gray-200 finance-filter" data-f="expense">הוצאות</button>
                        <button onclick="Finance.setFilter('purim')" class="px-3 py-1 rounded text-sm text-purple-600 font-bold hover:bg-purple-100 finance-filter" data-f="purim"><i class="fas fa-mask"></i> פורים</button>
                    </div>
                </div>
                
                <div class="flex-1 bg-white overflow-hidden flex flex-col m-4 rounded-xl shadow border">
                    <div class="overflow-y-auto flex-1">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 text-gray-600 sticky top-0">
                                <tr>
                                    <th class="p-3">תאריך</th>
                                    <th class="p-3">סוג</th>
                                    <th class="p-3">קטגוריה</th>
                                    <th class="p-3">תיאור / משוייך ל...</th>
                                    <th class="p-3">סכום</th>
                                    <th class="p-3">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="finance-tbody" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. REPORTS -->
            <div id="view-reports" class="view-section p-8 hidden fade-in financial-data">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">מחולל דוחות מתקדם</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- דוח סטנדרטי -->
                    <div class="bg-white p-6 rounded-xl shadow border border-gray-200">
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 border-b pb-2">דוח פעילות כספית</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-bold">סינון:</label>
                                <select id="rep-type" class="w-full border p-2 rounded mt-1">
                                    <option value="all">הכל (הכנסות והוצאות)</option>
                                    <option value="income">רק הכנסות</option>
                                    <option value="expense">רק הוצאות</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-bold">ישות (אופציונלי):</label>
                                <select id="rep-entity" class="w-full border p-2 rounded mt-1">
                                    <option value="">כללי</option>
                                    <option value="student">לפי בחור</option>
                                    <option value="donor">לפי תורם</option>
                                    <option value="group">לפי קבוצה</option>
                                </select>
                            </div>
                            <button onclick="Reports.generateStandard()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">הורד לאקסל</button>
                        </div>
                    </div>

                    <!-- דוח פורים מיוחד -->
                    <div class="bg-white p-6 rounded-xl shadow border border-purple-200">
                        <h3 class="font-bold text-lg mb-4 text-purple-700 border-b pb-2"><i class="fas fa-mask"></i> דוח פורים שנתי</h3>
                        <p class="text-sm text-gray-500 mb-4">הפקת דוח סיכום פעילות פורים לשנה הנוכחית.</p>
                        
                        <div class="flex gap-2">
                            <button onclick="Reports.generatePurim('real')" class="flex-1 bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700">
                                דוח אמיתי
                                <span class="block text-xs font-normal opacity-75">סכומים בפועל בקופה</span>
                            </button>
                            <button onclick="Reports.generatePurim('display')" class="flex-1 bg-yellow-600 text-white py-3 rounded font-bold hover:bg-yellow-700">
                                דוח לתצוגה (פיקטיבי)
                                <span class="block text-xs font-normal opacity-75">כולל קיזוזים והנחות יעד</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7. SETTINGS & ADMIN -->
            <div id="view-settings" class="view-section p-8 hidden fade-in admin-only">
                <div class="max-w-4xl mx-auto space-y-6">
                    
                    <!-- הגדרת חוקים -->
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="font-bold text-lg mb-4">חוקים וזכאות (הנחות יעד)</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <label>יעד כללי למערכת (ש"ח)</label>
                                <input type="number" id="conf-global-goal" class="input-field w-full mt-1" onchange="Settings.save('globalGoal', this.value)">
                            </div>
                            <div>
                                <label>הנחת חבר קבוצה (ש"ח מהיעד)</label>
                                <input type="number" id="conf-group-disc" class="input-field w-full mt-1" onchange="Settings.save('groupDiscount', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- משתמשים -->
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="font-bold text-lg mb-4">ניהול משתמשים</h3>
                        <div class="flex gap-2 mb-2">
                            <input id="new-user-email" type="email" placeholder="אימייל משתמש" class="input-field flex-1">
                            <select id="new-user-role" class="input-field w-32">
                                <option value="user">משתמש</option>
                                <option value="admin">מנהל</option>
                            </select>
                            <button onclick="Settings.addUser()" class="btn-primary">הוסף</button>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">* משתמש רגיל יכול להזין נתונים אך לא רואה סיכומי כספים.</div>
                        <ul id="users-list" class="divide-y text-sm"></ul>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal: Generic Form -->
    <div id="modal-form" class="fixed inset-0 z-50 bg-black/60 hidden-screen flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] max-w-[90vw] overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 bg-indigo-900 text-white flex justify-between items-center">
                <h3 id="modal-title" class="font-bold text-lg">כותרת</h3>
                <button onclick="Modal.close()" class="hover:text-red-300"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto space-y-4"></div>
            <div class="p-4 bg-gray-50 flex gap-3 border-t">
                <button id="modal-save-btn" class="flex-1 btn-primary">שמור</button>
                <button onclick="Modal.close()" class="flex-1 btn-secondary">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
   <script>
        // --- 1. CONFIGURATION ---
        // עליך לוודא שהפרטים כאן נכונים מה-Firebase Console שלך
        const firebaseConfig = {
            apiKey: "AIzaSyBRunXdWIFiP8-vZao0WZ6WxItMAUt-ORY",
            authDomain: "ezer--project.firebaseapp.com",
            databaseURL: "https://ezer--project-default-rtdb.firebaseio.com",
            projectId: "ezer--project",
            storageBucket: "ezer--project.firebasestorage.app",
            messagingSenderId: "838086109276",
            appId: "1:838086109276:web:201babf8b31c39a0cc9e99"
        };
        
        // אתחול בטוח
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const auth = firebase.auth();

        const SHIURIM_ORDER = ['שיעור א', 'שיעור ב', 'שיעור ג', 'קיבוץ א', 'קיבוץ ב', 'קיבוץ ג', 'קיבוץ ד', 'קיבוץ ה', 'קיבוץ ו', 'קיבוץ ז', 'קיבוץ ח'];

        const getHebrewYear = () => {
            const d = new Date();
            return d.getMonth() > 8 ? 'תשפ״ו' : 'תשפ״ה'; // חישוב פשוט להדגמה
        };

        // --- 2. STORE ---
        const Store = {
            currentYear: getHebrewYear(),
            user: null,
            role: 'user',
            data: { students: {}, donors: {}, yearData: {}, config: {} },
            loaded: { students: false, donors: false, year: {} },

            init() {
                // טעינת הגדרות בסיס
                this.loadConfig();
                this.loadYearData(this.currentYear);
                
                // האזנה לנתונים גלובליים (פעם אחת בלבד)
                if(!this.loaded.students) {
                    db.ref('global/students').limitToLast(100).on('child_added', s => { 
                        this.data.students[s.key] = s.val(); 
                        UI.updateIfVisible('students'); 
                    });
                    this.loaded.students = true;
                }
                if(!this.loaded.donors) {
                    db.ref('global/donors').limitToLast(100).on('child_added', s => { 
                        this.data.donors[s.key] = s.val(); 
                        UI.updateIfVisible('donors'); 
                    });
                    this.loaded.donors = true;
                }
            },

            loadYearData(y) {
                if(this.loaded.year[y]) return;
                console.log("Loading data for year:", y);
                
                const yearRef = db.ref(`years/${y}`);
                yearRef.child('finance').on('value', snap => {
                    if(!this.data.yearData[y]) this.data.yearData[y] = {};
                    this.data.yearData[y].finance = snap.val() || {};
                    UI.updateIfVisible('finance');
                    if(Router.current === 'dashboard') Dashboard.render();
                });
                yearRef.child('groups').on('value', snap => {
                    if(!this.data.yearData[y]) this.data.yearData[y] = {};
                    this.data.yearData[y].groups = snap.val() || {};
                    UI.updateIfVisible('groups');
                });
                yearRef.child('studentData').on('value', snap => {
                    if(!this.data.yearData[y]) this.data.yearData[y] = {};
                    this.data.yearData[y].students = snap.val() || {};
                    UI.updateIfVisible('students');
                });
                this.loaded.year[y] = true;
            },

            loadConfig() {
                db.ref('settings').on('value', s => this.data.config = s.val() || {});
            }
        };

        // --- 3. AUTH & ROUTER (THE FIX) ---
        const Auth = {
            login(e) {
                e.preventDefault();
                const em = document.getElementById('email').value;
                const pw = document.getElementById('password').value;
                document.getElementById('login-msg').classList.add('hidden');
                
                auth.signInWithEmailAndPassword(em, pw).catch(err => {
                    const msg = document.getElementById('login-msg');
                    msg.innerText = "שגיאה: " + err.message;
                    msg.classList.remove('hidden');
                });
            },
            logout() { auth.signOut(); },
            
            onStateChange(u) {
                const loader = document.getElementById('loader');
                const loginScreen = document.getElementById('login-screen');
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content');

                if (u) {
                    // 1. משתמש מחובר - מיד מציגים ממשק
                    console.log("User logged in:", u.email);
                    Store.user = u;
                    
                    document.getElementById('user-email-display').innerText = u.email;
                    
                    // הסתרת מסכי כניסה וטעינה
                    loader.classList.add('hidden-screen');
                    loginScreen.classList.add('hidden-screen');
                    
                    // הצגת ממשק ראשי
                    sidebar.classList.remove('hidden-screen');
                    mainContent.classList.remove('hidden-screen');

                    // 2. הפעלת המערכת מיד (ברירת מחדל: משתמש רגיל)
                    Store.init();
                    System.initUI();
                    
                    // אם אנחנו עדיין לא בדף ספציפי, לך לדשבורד
                    if (!Router.current) {
                        Router.go('dashboard');
                    }

                    // 3. בדיקת הרשאות מנהל ברקע
                    db.ref(`users/${u.uid}`).once('value')
                        .then(s => {
                            const val = s.val() || {};
                            Store.role = val.role || 'user';
                            document.getElementById('user-role-display').innerText = Store.role === 'admin' ? 'מנהל מערכת' : 'משתמש';
                            document.body.className = `role-${Store.role}`;
                            // רענון אם אנחנו בהגדרות
                            if(Router.current === 'settings') Router.go('settings');
                        })
                        .catch(err => console.log("Role check skipped or failed", err));

                } else {
                    // משתמש מנותק
                    console.log("No user");
                    loader.classList.add('hidden-screen'); // מסתירים טעינה בכל מקרה
                    loginScreen.classList.remove('hidden-screen');
                    sidebar.classList.add('hidden-screen');
                    mainContent.classList.add('hidden-screen');
                    Router.current = null;
                }
            }
        };

        const Router = {
            current: null,
            go(view) {
                console.log("Navigating to:", view);
                this.current = view;
                
                // הסתרת כל התצוגות
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.add('hidden');
                    el.classList.remove('fade-in');
                    el.style.display = 'none'; // ווידוא CSS חזק
                });

                // הצגת התצוגה הרלוונטית
                const el = document.getElementById('view-' + view);
                if (el) {
                    el.classList.remove('hidden');
                    el.style.display = 'block'; // ווידוא CSS חזק
                    setTimeout(() => el.classList.add('fade-in'), 10);
                } else {
                    console.error("View not found:", view);
                }
                
                // עדכון סרגל צד
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('border-indigo-500', 'bg-slate-800'));
                
                // עדכון כותרת
                const titles = {dashboard:'דף הבית', students:'ניהול בחורים', donors:'ניהול תורמים', groups:'קבוצות', finance:'כספים', reports:'דוחות', settings:'הגדרות'};
                document.getElementById('page-title').innerText = titles[view] || view;

                // טעינת נתונים
                if(view === 'students') Students.render();
                if(view === 'donors') Donors.render();
                if(view === 'groups') Groups.render();
                if(view === 'finance') Finance.render();
                if(view === 'dashboard') Dashboard.render();
            }
        };

        const UI = {
            updateIfVisible(module) {
                if(Router.current === module) {
                    if(module === 'students') Students.render(true);
                    if(module === 'donors') Donors.render(true);
                    if(module === 'groups') Groups.render();
                    if(module === 'finance') Finance.render();
                }
                if(module === 'finance' && Router.current === 'dashboard') Dashboard.render();
            }
        };

        const System = {
            initUI() {
                const sel = document.getElementById('year-selector');
                if(sel.options.length === 0) { // מניעת כפילויות
                    ['תשפ״ד','תשפ״ה','תשפ״ו'].forEach(y => {
                        const op = document.createElement('option');
                        op.value = y; op.innerText = y;
                        if(y === Store.currentYear) op.selected = true;
                        sel.appendChild(op);
                    });
                }
                document.querySelectorAll('.curr-year').forEach(s => s.innerText = Store.currentYear);
            },
            changeYear(y) {
                Store.currentYear = y;
                Store.loadYearData(y);
                document.querySelectorAll('.curr-year').forEach(s => s.innerText = y);
                if(Router.current) Router.go(Router.current);
            }
        };

        // --- MODULES ---

        const Students = {
            currentLimit: 20,
            render(keepScroll = false) {
                const term = document.getElementById('student-search')?.value.trim() || '';
                const tbody = document.getElementById('students-tbody');
                if(!tbody) return;
                
                if(!keepScroll) tbody.innerHTML = '';

                let list = Object.values(Store.data.students).map(s => {
                    const yData = (Store.data.yearData[Store.currentYear]?.students || {})[s.id] || {};
                    return { ...s, ...yData };
                });

                if(term) list = list.filter(s => s.name.includes(term) || s.phone.includes(term));
                
                const toShow = list.slice(0, this.currentLimit);
                tbody.innerHTML = toShow.map(s => `
                    <tr class="hover:bg-slate-50 transition cursor-pointer" onclick="Students.openEdit('${s.id}')">
                        <td class="p-3 text-right font-medium text-indigo-900">${s.name}</td>
                        <td class="p-3 text-right">${s.grade || '-'}</td>
                        <td class="p-3 text-right text-gray-500">${s.entryYear || '-'}</td>
                        <td class="p-3 text-right font-bold text-gray-700">₪${(s.personalGoal || 0).toLocaleString()}</td>
                        <td class="p-3 text-center"><i class="fas fa-pen text-indigo-400"></i></td>
                    </tr>
                `).join('');

                const btn = document.getElementById('students-loader-more');
                if(btn) btn.style.display = list.length > this.currentLimit ? 'block' : 'none';
                if(document.getElementById('dash-stat-students')) document.getElementById('dash-stat-students').innerText = list.length;
            },
            loadMore() { this.currentLimit += 20; this.render(true); },
            handleSearch() { this.currentLimit = 20; this.render(); },
            openAddModal() {
                Modal.render('הוספת בחור', [{id:'name',l:'שם',r:true},{id:'phone',l:'טלפון'},{id:'grade',l:'שיעור',t:'select',opts:SHIURIM_ORDER},{id:'goal',l:'יעד אישי',t:'number'}], d => {
                    const id = db.ref('global/students').push().key;
                    db.ref(`global/students/${id}`).set({id, name:d.name, phone:d.phone, grade:d.grade, entryYear:Store.currentYear});
                    if(d.goal) db.ref(`years/${Store.currentYear}/studentData/${id}/personalGoal`).set(parseInt(d.goal));
                });
            },
            openEdit(id) {
                const s = Store.data.students[id];
                const y = (Store.data.yearData[Store.currentYear]?.students||{})[id] || {};
                const extra = `<div class="mt-4 pt-4 border-t flex gap-2"><button onclick="Finance.quickAdd('income','${id}','student')" class="btn-secondary w-full text-green-700">הוסף תרומה</button></div>`;
                Modal.render('עריכה', [{id:'name',l:'שם',v:s.name},{id:'phone',l:'טלפון',v:s.phone},{id:'grade',l:'שיעור',t:'select',opts:SHIURIM_ORDER,v:s.grade},{id:'goal',l:'יעד',t:'number',v:y.personalGoal||0}], d => {
                    db.ref(`global/students/${id}`).update({name:d.name, phone:d.phone, grade:d.grade});
                    db.ref(`years/${Store.currentYear}/studentData/${id}/personalGoal`).set(parseInt(d.goal));
                }, extra);
            }
        };

        const Donors = {
            currentLimit: 30,
            render(keep = false) {
                const grid = document.getElementById('donors-grid');
                if(!grid) return;
                if(!keep) grid.innerHTML = '';
                
                const term = document.querySelector('#view-donors input')?.value || '';
                let list = Object.values(Store.data.donors);
                if(term) list = list.filter(d => d.name.includes(term));
                
                grid.innerHTML = list.slice(0, this.currentLimit).map(d => `
                    <div class="bg-white p-4 rounded shadow-sm border hover:border-indigo-400 cursor-pointer relative group">
                        <div class="font-bold flex justify-between"><span>${d.name}</span> <i onclick="Donors.openEdit('${d.id}')" class="fas fa-pen text-gray-300 hover:text-indigo-600"></i></div>
                        <div class="text-sm text-gray-500">${d.address||''}</div>
                        <button onclick="Finance.quickAdd('income','${d.id}','donor')" class="absolute bottom-2 left-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">תרומה</button>
                    </div>
                `).join('');
                const btn = document.getElementById('donors-loader-more');
                if(btn) btn.style.display = list.length > this.currentLimit ? 'block' : 'none';
                if(document.getElementById('dash-stat-donors')) document.getElementById('dash-stat-donors').innerText = list.length;
            },
            loadMore() { this.currentLimit += 30; this.render(true); },
            handleSearch() { this.currentLimit = 30; this.render(); },
            openAddModal() {
                 const sOpts = Object.values(Store.data.students).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
                 Modal.renderRaw('הוספת תורם', `<div><label class="lbl">שם</label><input id="f-n" class="input-field w-full"></div><div><label class="lbl">כתובת</label><input id="f-a" class="input-field w-full"></div><div><label class="lbl">מביא</label><select id="f-r" class="input-field w-full"><option value="">--</option>${sOpts}</select></div>`, ()=>{
                     const id = db.ref('global/donors').push().key;
                     db.ref(`global/donors/${id}`).set({id, name:document.getElementById('f-n').value, address:document.getElementById('f-a').value, referrerId:document.getElementById('f-r').value});
                 });
            },
            openEdit(id) {
                const d = Store.data.donors[id];
                const sOpts = Object.values(Store.data.students).map(s=>`<option value="${s.id}" ${s.id===d.referrerId?'selected':''}>${s.name}</option>`).join('');
                 Modal.renderRaw('עריכת תורם', `<div><label class="lbl">שם</label><input id="f-n" value="${d.name}" class="input-field w-full"></div><div><label class="lbl">כתובת</label><input id="f-a" value="${d.address||''}" class="input-field w-full"></div><div><label class="lbl">מביא</label><select id="f-r" class="input-field w-full"><option value="">--</option>${sOpts}</select></div>`, ()=>{
                     db.ref(`global/donors/${id}`).update({name:document.getElementById('f-n').value, address:document.getElementById('f-a').value, referrerId:document.getElementById('f-r').value});
                 });
            }
        };

        const Groups = {
            currentDay: 'night14', activeGroupId: null,
            setDay(d) {
                this.currentDay = d;
                document.querySelectorAll('.group-tab').forEach(b => {
                    b.classList.toggle('active', b.dataset.day === d);
                    b.classList.toggle('bg-white', b.dataset.day === d);
                    b.classList.toggle('border-t-2', b.dataset.day === d);
                    b.classList.toggle('border-indigo-600', b.dataset.day === d);
                });
                this.activeGroupId = null;
                this.render();
            },
            render() {
                const listEl = document.getElementById('groups-list');
                if(!listEl) return;
                listEl.innerHTML = '';
                const groups = (Store.data.yearData[Store.currentYear]?.groups || {})[this.currentDay] || {};
                
                Object.entries(groups).forEach(([gid, g]) => {
                    const el = document.createElement('div');
                    el.className = `p-3 border-b cursor-pointer hover:bg-indigo-50 ${gid===this.activeGroupId?'bg-indigo-100 border-l-4 border-l-indigo-600':''}`;
                    el.innerHTML = `<div class="font-bold text-sm">${g.name}</div><div class="text-xs text-gray-500">${(g.members||[]).length} בחורים</div>`;
                    el.onclick = () => {
                        this.activeGroupId = gid;
                        document.getElementById('active-group-name').innerText = g.name;
                        document.getElementById('active-group-count').innerText = (g.members||[]).length + ' בחורים';
                        this.render(); 
                        this.renderEditor(g);
                    };
                    listEl.appendChild(el);
                });

                if(this.activeGroupId && groups[this.activeGroupId]) {
                    document.getElementById('group-placeholder').classList.add('hidden');
                    document.getElementById('group-editor').classList.remove('hidden');
                    this.renderEditor(groups[this.activeGroupId]);
                } else {
                    document.getElementById('group-placeholder').classList.remove('hidden');
                    document.getElementById('group-editor').classList.add('hidden');
                }
            },
            renderEditor(g) {
                const memList = document.getElementById('group-members-list');
                memList.innerHTML = (g.members||[]).map((m,i) => {
                    const s = Store.data.students[m.id];
                    return s ? `<div class="bg-white p-2 border mb-1 flex justify-between text-sm"><span>${s.name} (${m.role})</span><button onclick="Groups.removeMember(${i})" class="text-red-500">x</button></div>` : '';
                }).join('');
                
                const routeList = document.getElementById('group-route-list');
                routeList.innerHTML = '';
                (g.route||[]).forEach(did => {
                    const d = Store.data.donors[did];
                    if(d) {
                        const el = document.createElement('div');
                        el.className = "bg-white p-2 border mb-1 cursor-grab text-sm";
                        el.dataset.id = did;
                        el.innerText = d.name + " - " + d.address;
                        routeList.appendChild(el);
                    }
                });
                new Sortable(routeList, { animation:150, onEnd: () => {
                    const ids = Array.from(routeList.children).map(c => c.dataset.id);
                    db.ref(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/route`).set(ids);
                }});
            },
            addNewGroup() {
                const n = prompt('שם הקבוצה:');
                if(n) db.ref(`years/${Store.currentYear}/groups/${this.currentDay}`).push({name:n, members:[], route:[]});
            },
            filterStudents(t) {
                const p = document.getElementById('pool-students');
                p.innerHTML = '';
                if(!t) return;
                Object.values(Store.data.students).filter(s=>s.name.includes(t)).slice(0,10).forEach(s => {
                    p.innerHTML += `<div onclick="Groups.addMember('${s.id}')" class="p-2 border-b cursor-pointer hover:bg-green-50 text-sm flex justify-between"><span>${s.name}</span><span>+</span></div>`;
                });
            },
            addMember(sid) {
                const ref = db.ref(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members`);
                ref.once('value', s => {
                    const l = s.val() || [];
                    if(!l.some(x=>x.id===sid)) { l.push({id:sid, role:'חבר'}); ref.set(l); }
                });
            },
            removeMember(idx) {
                const ref = db.ref(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members`);
                ref.once('value', s => { const l=s.val(); l.splice(idx,1); ref.set(l); });
            },
            filterDonors(t) {
                const p = document.getElementById('pool-donors');
                p.innerHTML = '';
                if(!t) return;
                Object.values(Store.data.donors).filter(d=>d.name.includes(t)).slice(0,10).forEach(d => {
                    p.innerHTML += `<div onclick="Groups.addToRoute('${d.id}')" class="p-2 border-b cursor-pointer hover:bg-green-50 text-sm">${d.name}</div>`;
                });
            },
            addToRoute(did) {
                const ref = db.ref(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/route`);
                ref.once('value', s => { const l=s.val()||[]; if(!l.includes(did)) { l.push(did); ref.set(l); } });
            },
            printSheet(type) {
                const g = Store.data.yearData[Store.currentYear].groups[this.currentDay][this.activeGroupId];
                let h = `<div class="print-header"><h1>${g.name} - ${type}</h1></div><table class="print-table"><tbody>`;
                if(type==='members') (g.members||[]).forEach(m => h += `<tr><td>${Store.data.students[m.id]?.name}</td><td>${m.role}</td></tr>`);
                else (g.route||[]).forEach((did,i) => h += `<tr><td>${i+1}</td><td>${Store.data.donors[did]?.name}</td><td>${Store.data.donors[did]?.address}</td><td></td></tr>`);
                h += `</tbody></table>`;
                document.getElementById('print-area').innerHTML = h;
                window.print();
            }
        };

        const Finance = {
            currentFilter: 'all',
            render() {
                const tb = document.getElementById('finance-tbody');
                if(!tb) return;
                tb.innerHTML = '';
                let d = Object.values(Store.data.yearData[Store.currentYear]?.finance || {});
                if(this.currentFilter!=='all') {
                    if(this.currentFilter==='purim') d = d.filter(x=>x.isPurim);
                    else d = d.filter(x=>x.type===this.currentFilter);
                }
                d.sort((a,b)=>b.date-a.date);
                tb.innerHTML = d.map(x => `
                    <tr class="border-b">
                        <td class="p-2 text-gray-500 text-xs">${new Date(x.date).toLocaleDateString('he')}</td>
                        <td class="p-2"><span class="px-2 py-0.5 rounded text-xs ${x.type==='income'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${x.type==='income'?'הכנסה':'הוצאה'}</span></td>
                        <td class="p-2 text-sm">${x.category}</td>
                        <td class="p-2 text-sm">${x.desc||''}</td>
                        <td class="p-2 font-bold dir-ltr text-right">₪${parseInt(x.amount).toLocaleString()}</td>
                        <td class="p-2"><button onclick="Finance.deleteTx('${x.id}')" class="text-red-300 hover:text-red-500">x</button></td>
                    </tr>
                `).join('');
            },
            setFilter(f) {
                this.currentFilter=f;
                document.querySelectorAll('.finance-filter').forEach(b=>b.classList.remove('active','bg-white','shadow','font-bold'));
                document.querySelector(`.finance-filter[data-f="${f}"]`).classList.add('active','bg-white','shadow','font-bold');
                this.render();
            },
            openTransactionModal(type) {
                Modal.render(type==='income'?'הכנסה':'הוצאה', [{id:'amount',l:'סכום',t:'number'},{id:'category',l:'קטגוריה',t:'select',opts:['תרומה','מזומן','צק','אשראי','הוצאות פורים']},{id:'desc',l:'תיאור'},{id:'isPurim',l:'פורים?',t:'checkbox'}], d => {
                    const id = 'tx'+Date.now();
                    db.ref(`years/${Store.currentYear}/finance/${id}`).set({id, date:Date.now(), type, amount:parseInt(d.amount), category:d.category, desc:d.desc, isPurim:!!d.isPurim});
                });
            },
            quickAdd(type, entId, entType) {
                Modal.render('הוספה מהירה', [{id:'amt',l:'סכום',t:'number'}], d => {
                    const id = 'tx'+Date.now();
                    db.ref(`years/${Store.currentYear}/finance/${id}`).set({id, date:Date.now(), type, amount:parseInt(d.amt), category:'תרומה מהירה', isPurim:true, [entType==='student'?'studentId':'donorId']:entId});
                });
            },
            deleteTx(id) { if(confirm('למחוק?')) db.ref(`years/${Store.currentYear}/finance/${id}`).remove(); }
        };

        const Dashboard = {
            render() {
                const d = Object.values(Store.data.yearData[Store.currentYear]?.finance || {});
                let inc=0, exp=0;
                d.forEach(x => x.type==='income' ? inc+=parseInt(x.amount) : exp+=parseInt(x.amount));
                document.getElementById('dash-income').innerText = '₪'+inc.toLocaleString();
                document.getElementById('dash-expense').innerText = '₪'+exp.toLocaleString();
                document.getElementById('dash-total-balance').innerText = '₪'+(inc-exp).toLocaleString();
                document.getElementById('dash-logs').innerHTML = d.slice(0,5).map(x=>`<div class="p-2 border-b text-xs flex justify-between"><span>${x.category}</span><b>${x.amount}</b></div>`).join('');
            }
        };

        const Reports = {
            generateStandard() {
                const d = Object.values(Store.data.yearData[Store.currentYear].finance||{});
                const ws = XLSX.utils.json_to_sheet(d);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, "Report.xlsx");
            },
            generatePurim(mode) { alert('דוח פורים ' + mode + ' יופק כעת'); }
        };

        const Settings = {
            save(k,v) { db.ref(`settings/${k}`).set(parseInt(v)); },
            addUser() { alert('יש להוסיף משתמשים דרך המסוף של Firebase'); }
        };

        const Modal = {
            render(t, f, onSave, ex='') {
                let h = '';
                f.forEach(x => {
                    h += `<div class="mb-2"><label class="lbl">${x.l}</label>`;
                    if(x.t==='select') h+=`<select id="mf-${x.id}" class="input-field w-full">${x.opts.map(o=>`<option ${x.v===o?'selected':''} value="${o}">${o}</option>`).join('')}</select>`;
                    else if(x.t==='checkbox') h+=`<input type="checkbox" id="mf-${x.id}" ${x.v?'checked':''}>`;
                    else h+=`<input id="mf-${x.id}" type="${x.t||'text'}" value="${x.v||''}" class="input-field w-full">`;
                    h+=`</div>`;
                });
                this.renderRaw(t, h+ex, () => {
                    const d = {}; f.forEach(x => { const e=document.getElementById(`mf-${x.id}`); d[x.id]=x.t==='checkbox'?e.checked:e.value; });
                    onSave(d);
                });
            },
            renderRaw(t, h, onSave) {
                document.getElementById('modal-title').innerText=t;
                document.getElementById('modal-body').innerHTML=h;
                document.getElementById('modal-form').classList.remove('hidden-screen');
                const btn = document.getElementById('modal-save-btn');
                const nBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(nBtn, btn);
                nBtn.onclick = () => { onSave(); this.close(); };
            },
            close() { document.getElementById('modal-form').classList.add('hidden-screen'); }
        };

        const Importer = { init() { alert('מודול יבוא אקסל'); } };
        
        // אתחול Auth Listener
        auth.onAuthStateChanged(Auth.onStateChange);

        // CSS Helper
        const style = document.createElement('style');
        style.innerHTML = `.btn-primary{background:#4f46e5;color:#fff;padding:.5rem 1rem;border-radius:.5rem}.input-field{border:1px solid #ccc;padding:.5rem;border-radius:.5rem;width:100%}`;
        document.head.appendChild(style);
    </script>
</body>
</html>
