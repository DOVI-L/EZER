<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="icon" type="image/png" href="1.JPG">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מערכת ניהול - עזר חתנים | גרסה מלאה ומשודרגת</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- SheetJS - גרסה מלאה ליבוא ויצוא אקסל -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- JSPDF ליצוא PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- פונט משודרג -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* הגדרות עיצוב מתקדמות */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; /* מניעת גלילה ראשית */ }
        body { font-family: 'Heebo', sans-serif; background-color: #f0f2f5; }
        
        .bg-sidebar { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); }
        .bg-main { background-color: #f3f4f6; }
        
        /* Scrollbar מעוצב ודק */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* החלה גורפת על אזורי תוכן */
        .view-section { 
            height: 100%; 
            overflow-y: auto; 
            padding-bottom: 2rem;
            /* החלת הסקרולבר המותאם */
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .view-section::-webkit-scrollbar { width: 6px; }
        .view-section::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- עיצוב כפתורי טאבים משודרג (חדש) --- */
        .tab-modern {
            position: relative;
            padding: 8px 24px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
            cursor: pointer;
        }
        .tab-modern::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }
        .tab-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
            border-color: #818cf8;
            color: #4f46e5;
        }
        .tab-modern.active {
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.35);
            z-index: 1;
        }
        .tab-modern.active::before { opacity: 1; }

        /* --- אזור עורך הדוחות החדש (חדש) --- */
        #report-editor-screen {
            background-color: #e2e8f0;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20000; display: flex;
        }
        #report-sidebar {
            width: 320px; background: white; border-left: 1px solid #cbd5e1;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); z-index: 20;
        }
        #report-canvas-container {
            flex: 1; overflow: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 40px; background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px; gap: 40px; /* רווח גדול יותר בין דפים */
        }
        .report-page {
            /* גודל בסיסי ישתנה דינמית */
            background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; overflow: hidden; 
            margin-bottom: 20px;
            transform-origin: top center; transition: transform 0.2s;
        }
        .page-landscape { width: 297mm; min-height: 210mm; }
        .page-portrait { width: 210mm; min-height: 297mm; }

        .draggable-item {
            position: absolute; cursor: move; border: 2px solid transparent; z-index: 50;
        }
        .draggable-item:hover, .draggable-item.selected {
            border: 2px dashed #6366f1;
        }
        .resize-handle {
            width: 15px; height: 15px; background: #6366f1;
            position: absolute; bottom: -7px; right: -7px;
            cursor: se-resize; display: none; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .draggable-item:hover .resize-handle, .draggable-item.selected .resize-handle { display: block; }

        /* --- אזור הדפסה משודרג --- */
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #report-editor-screen { display: none !important; } 
            
            #print-area { 
                display: block !important; 
                position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                z-index: 99999; background-color: white; direction: rtl; padding: 0;
                color: black !important;
            }

            @page { margin: 0; size: auto; } /* שוליים אוטומטיים */
            
            .editor-print-mode {
                width: 100% !important; height: 100% !important;
                transform: none !important; box-shadow: none !important;
                margin: 0 !important;
                page-break-after: always;
                position: relative;
                padding-bottom: 60px !important; /* תיקון מס' 5: שוליים רחבים למטה */
            }

            .print-layer-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .print-layer-content { position: relative; z-index: 10 !important; }
            .print-layer-decor { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5 !important; pointer-events: none; }

            .print-table { width: 100%; margin: 10px auto; border-collapse: collapse; font-size: 10pt; table-layout: fixed; }
            .print-table th { background-color: rgba(226, 232, 240, 0.8) !important; border: 1px solid #000; padding: 4px; text-align: center; color: #000 !important; font-weight: 800; -webkit-print-color-adjust: exact; white-space: nowrap; overflow: hidden; }
            .print-table td { border: 1px solid #000; padding: 4px; text-align: right; color: #000; vertical-align: middle; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; background: rgba(255,255,255,0.7); }
            
            .print-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 5px; }
            .print-header img { position: absolute; right: 0; top: 0; height: 60px; width: auto; }
            .print-header h1 { font-size: 22px; font-weight: 900; margin: 0; color: #000; text-shadow: 2px 2px 4px white; }
            .print-header h3 { font-size: 14px; font-weight: normal; margin: 2px 0 0 0; color: #444; text-shadow: 1px 1px 2px white; }
            
            .role-badge { border: 1px solid #000; padding: 1px 6px; border-radius: 10px; font-size: 9pt; font-weight: bold; display: inline-block; margin-left: 5px; }
            .role-commander { background-color: #e0f2fe !important; -webkit-print-color-adjust: exact; }
            .role-deputy { background-color: #fef3c7 !important; -webkit-print-color-adjust: exact; }

            /* הדפסת קוביות קבוצה */
            .boxes-container {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                justify-content: flex-start;
                padding: 10px;
                direction: rtl;
            }
            .group-box {
                width: 32%; /* 3 בשורה */
                border: 2px solid #000;
                padding: 0;
                box-sizing: border-box;
                page-break-inside: avoid;
                background: #fff;
            }
            .group-box-header {
                background: #e2e8f0;
                border-bottom: 2px solid #000;
                padding: 5px;
                text-align: center;
                font-weight: 900;
                font-size: 14pt;
                -webkit-print-color-adjust: exact;
            }
            .group-box-content {
                padding: 5px;
            }
            .group-box-row {
                display: flex;
                justify-content: space-between;
                border-bottom: 1px dashed #ccc;
                padding: 2px 0;
                font-size: 11pt;
            }
            .group-box-row:last-child { border-bottom: none; }
            .box-role { font-weight: bold; }

            /* עיצוב דף בחור - גזירה */
            .student-slip {
                border: 2px dashed #000;
                padding: 20px;
                margin: 20px auto;
                width: 90%;
                page-break-inside: avoid;
                text-align: center;
                background: white;
            }
            .student-slip-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 15px;
            }
            .student-slip-logo { height: 50px; }
            .student-slip-title { font-size: 24px; font-weight: 900; }
        }
        
        #print-area { display: none; }
        
        body.role-user .financial-data { display: none !important; }
        body.role-user .admin-only { display: none !important; }

        .logo-img-login { max-height: 120px; width: auto; margin: 0 auto 1.5rem auto; display: block; }
        .logo-img-sidebar { max-height: 90px; width: auto; max-width: 100%; object-fit: contain; }
        .nav-btn.active { background-color: rgba(255,255,255,0.1); border-right-color: #6366f1; color: white; }

        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; display: flex; align-items: center; gap: 12px; animation: slideInLeft 0.3s ease; border-right: 4px solid transparent; }
        .toast.success { border-right-color: #10b981; }
        .toast.error { border-right-color: #ef4444; }
        .toast.info { border-right-color: #3b82f6; }
        .toast-icon { font-size: 1.2rem; }
        .success .toast-icon { color: #10b981; }
        .error .toast-icon { color: #ef4444; }
        .info .toast-icon { color: #3b82f6; }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* [5] תיקון סטטוס חיבור: תמיד מוצג, עם מצב מכווץ */
        #connection-status {
            position: fixed; bottom: 10px; right: 10px; z-index: 9999;
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            display: flex !important; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s; cursor: pointer; align-items: center;
        }
        .status-offline { background-color: #fee2e2; color: #991b1b; }
        .status-connected { background-color: #d1fae5; color: #065f46; }
        .status-syncing { background-color: #fef3c7; color: #92400e; }
        
        .status-collapsed {
             width: 24px; height: 24px; padding: 0; justify-content: center; overflow: hidden; border-radius: 50%;
        }
        .status-collapsed span { display: none; }

        .kanban-group-list {
            height: calc(100vh - 350px);
            overflow-y: auto;
            min-height: 200px;
        }
        
        #groups-kanban-container {
             display: flex;
             gap: 15px;
             overflow-x: auto;
             padding-bottom: 20px;
             width: 100%;
        }

        .celebration-bg {
            background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%);
            animation: pulse 1s infinite;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* תיקון מס' 1: עיצוב בחור בארכיון */
        .archived-student {
            background-color: #f3f4f6;
            color: #9ca3af;
        }
        .archived-student td {
            color: #9ca3af !important;
            font-style: italic;
        }

        /* תיקון מס' 9: בועת AI למנהל */
        #ai-bubble-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 99999;
        }
        #ai-fab {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px; cursor: pointer;
            transition: all 0.3s;
        }
        #ai-fab:hover { transform: scale(1.1); }
        #ai-chat-window {
            position: absolute; bottom: 80px; left: 0;
            width: 350px; height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none; flex-direction: column;
            overflow: hidden; border: 1px solid #e2e8f0;
        }
        .chat-header { background: #f8fafc; padding: 15px; border-bottom: 1px solid #e2e8f0; font-weight: bold; color: #334155; display: flex; justify-content: space-between; }
        .chat-body { flex: 1; padding: 15px; background: #fff; overflow-y: auto; color: #64748b; font-size: 0.9rem; }
        
        /* עיצוב טבלת הוספה מרוכזת */
        .batch-table th { background: #f1f5f9; padding: 8px; font-size: 0.8rem; border-bottom: 2px solid #e2e8f0; }
        .batch-table td { border-bottom: 1px solid #f1f5f9; padding: 4px; }
        .batch-input { width: 100%; border: 1px solid #e2e8f0; padding: 4px; font-size: 0.85rem; border-radius: 4px; }
        .batch-input:focus { border-color: #6366f1; outline: none; }
    </style>
</head>
<body class="h-full text-slate-800 bg-main overflow-hidden">

    <!-- מכל התראות -->
    <div id="toast-container"></div>
    
    <!-- [5] מחוון חיבור משופר - לחיץ -->
    <div id="connection-status" class="status-offline" onclick="this.classList.toggle('status-collapsed')" title="לחץ לכיווץ/הרחבה">
        <i class="fas fa-wifi"></i> <span id="conn-text" class="mr-2">טוען...</span>
    </div>

    <!-- אלמנט נסתר ליבוא קבצים -->
    <input type="file" id="excel-upload-input" accept=".xlsx, .xls" class="hidden" onchange="Importer.handleFileSelect(this)">
    <!-- אלמנט נסתר ליבוא JSON -->
    <input type="file" id="json-import-input" accept=".json" class="hidden" onchange="Settings.importDataFromJSON(this)">

    <!-- אזור הדפסה -->
    <div id="print-area"></div>

    <!-- עורך דוחות חדש -->
    <div id="report-editor-screen" class="hidden-screen">
        <aside id="report-sidebar">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-xl font-bold">עורך דוח תצוגה</h2>
                <button onclick="Reports.closeEditor()" class="text-red-500 hover:bg-red-50 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4 overflow-y-auto custom-scroll flex-1">
                <div>
                    <label class="text-sm font-bold block mb-1">כותרת הדוח</label>
                    <input type="text" id="editor-title-input" value="דוח תצוגה משוקלל" class="input-field w-full text-sm" oninput="Reports.updateTitle(this.value)">
                </div>
                
                <!-- [4] הגדרת כמות שורות לדף -->
                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-1">שורות לדף (פריטים)</label>
                    <input type="number" value="22" onchange="Reports.setRowsPerPage(this.value)" class="input-field w-full text-sm">
                </div>

                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">תמונת רקע</label>
                    <input type="file" id="editor-bg-input" accept="image/*" class="text-xs mb-2" onchange="Reports.updateBackground(this)">
                    <div class="flex items-center gap-2">
                        <span class="text-xs">שקיפות:</span>
                        <input type="range" min="0" max="1" step="0.1" value="0.2" oninput="Reports.updateBgOpacity(this.value)" class="flex-1">
                    </div>
                </div>

                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">כיוון דף</label>
                    <select onchange="Reports.setOrientation(this.value)" class="input-field w-full text-sm">
                        <option value="landscape">לרוחב (Landscape)</option>
                        <option value="portrait">לאורך (Portrait)</option>
                    </select>
                </div>

                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">אלמנטים נוספים</label>
                    <button onclick="document.getElementById('editor-add-img').click()" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded font-bold text-sm border border-indigo-200 hover:bg-indigo-100 mb-2">
                        <i class="fas fa-image ml-1"></i> הוסף תמונה
                    </button>
                    <input type="file" id="editor-add-img" accept="image/*" class="hidden" onchange="Reports.addDecorImage(this)">
                    <p class="text-[10px] text-gray-500">ניתן לגרור ולשנות גודל. יופיע בהדפסה.</p>
                </div>
                
                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-1">זום תצוגה</label>
                    <input type="range" min="0.3" max="1.5" step="0.1" value="0.6" oninput="Reports.setZoom(this.value)" class="w-full">
                </div>

                <!-- עריכת כותרות טבלה (חדש) - תיקון מס' 3 -->
                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">עריכת כותרות וסדר (לחץ לשינוי)</label>
                    <div id="editor-headers-container" class="space-y-1">
                        <!-- headers generated dynamically -->
                    </div>
                </div>
            </div>

            <div class="border-t pt-4 mt-auto gap-2 flex flex-col">
                <button onclick="Reports.printEditor()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700">
                    <i class="fas fa-print ml-2"></i> הדפס דוח (רב עמודים)
                </button>
                <button onclick="Reports.closeEditor()" class="w-full bg-gray-100 text-gray-700 py-2 rounded-xl font-bold hover:bg-gray-200">
                    סגור
                </button>
            </div>
        </aside>
        
        <div id="report-canvas-container">
            <!-- הדפים ייווצרו כאן דינמית -->
        </div>
    </div>

    <!-- טיימר התנתקות (פופאפ) -->
    <div id="timeout-modal" class="fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center hidden-screen backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md border-t-8 border-red-500 animate-bounce-slight">
            <div class="text-6xl text-red-500 mb-4"><i class="fas fa-hourglass-half"></i></div>
            <h2 class="text-2xl font-bold mb-2">זיהינו חוסר פעילות</h2>
            <p class="text-gray-600 mb-6">המערכת תתנתק באופן אוטומטי בעוד <span id="timeout-countdown" class="font-bold text-red-600 text-xl">60</span> שניות לצורכי אבטחה.</p>
            <button onclick="InactivityTimer.stayLoggedIn()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">השאר אותי מחובר</button>
        </div>
    </div>

    <!-- Celebration Modal (New) -->
    <div id="celebration-modal" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center hidden-screen">
        <div class="absolute inset-0 overflow-hidden pointer-events-none" id="confetti-container"></div>
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-lg border-4 border-amber-400 relative z-10 transform scale-100 transition-transform">
            <div class="w-24 h-24 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-trophy text-5xl text-amber-500 animate-bounce"></i>
            </div>
            <h2 class="text-4xl font-extrabold text-slate-800 mb-2">כל הכבוד!</h2>
            <h3 class="text-2xl font-bold text-indigo-600 mb-4" id="celebration-name">שם הבחור</h3>
            <p class="text-lg text-gray-600 mb-6">הבחור הגיע ליעד של <span id="celebration-amount" class="font-bold"></span> ש"ח!</p>
            <div class="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-6">
                <div class="text-sm text-amber-800 font-bold uppercase tracking-wider mb-1">המתנה שמגיעה לו:</div>
                <div class="text-2xl font-black text-amber-600" id="celebration-reward">...</div>
            </div>
            <button onclick="document.getElementById('celebration-modal').classList.add('hidden-screen')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">סגור חלון</button>
        </div>
    </div>

    <!-- מסך טעינה -->
    <div id="loader" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col justify-center items-center transition-opacity duration-500">
        <div id="loader-spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
        <h2 id="loader-text" class="text-white text-xl font-medium tracking-wide">טוען נתונים...</h2>
    </div>

    <!-- מסך התחברות -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col justify-center items-center hidden-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="bg-white/95 backdrop-blur p-10 rounded-3xl shadow-2xl w-96 text-center border border-white/20">
            <img src="1.JPG" alt="לוגו מערכת" class="logo-img-login" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <div class="hidden text-indigo-700 text-6xl mb-6"><i class="fas fa-synagogue"></i></div>
            
            <h1 class="text-2xl font-bold text-slate-800 mb-1">ברוכים הבאים</h1>
            <p class="text-gray-500 mb-8 text-sm">ניהול מערכת - עזר חתנים</p>
            
            <form onsubmit="Auth.login(event)" class="space-y-4" autocomplete="off">
                <div class="relative">
                    <i class="fas fa-envelope absolute top-3.5 right-3 text-gray-400"></i>
                    <input style="display:none" type="text" name="fakeusernameremembered"/>
                    <input style="display:none" type="password" name="fakepasswordremembered"/>
                    
                    <input type="email" id="email" placeholder="אימייל" autocomplete="off" class="w-full bg-slate-50 border border-slate-200 p-3 pr-10 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute top-3.5 right-3 text-gray-400"></i>
                    <input type="password" id="password" placeholder="סיסמה" autocomplete="new-password" class="w-full bg-slate-50 border border-slate-200 p-3 pr-10 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95">כניסה למערכת</button>
            </form>
            <div id="login-msg" class="text-red-500 text-sm mt-4 hidden font-bold bg-red-50 p-2 rounded"></div>
        </div>
    </div>

    <!-- ממשק האפליקציה -->
    <div class="flex h-full w-full relative overflow-hidden">

        <!-- תפריט צד -->
        <aside id="sidebar" class="w-64 bg-sidebar text-slate-300 flex flex-col hidden-screen shadow-2xl z-20 h-full border-l border-slate-700 shrink-0">
            <!-- לוגו מוגדל -->
            <div class="p-6 border-b border-slate-700/50 flex items-center justify-center h-32 bg-black/20">
                <img src="1.JPG" alt="לוגו" class="logo-img-sidebar hover:scale-105 transition" onerror="this.outerHTML='<h2 class=\'font-bold text-xl text-white\'>עזר חתנים</h2>'">
            </div>

            <nav class="flex-1 overflow-y-auto py-6 space-y-1 custom-scroll">
                <button onclick="Router.go('dashboard')" id="nav-dashboard" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-chart-pie w-5 text-center text-indigo-400"></i> לוח מחוונים
                </button>
                
                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider">ניהול נתונים</div>
                <button onclick="Router.go('students')" id="nav-students" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-user-graduate w-5 text-center text-blue-400"></i> בחורים
                </button>
                <button onclick="Router.go('donors')" id="nav-donors" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-hand-holding-usd w-5 text-center text-emerald-400"></i> תורמים
                </button>
                <button onclick="Router.go('groups')" id="nav-groups" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-users-cog w-5 text-center text-amber-400"></i> קבוצות ומסלולים
                </button>

                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider financial-data">כספים ודוחות</div>
                <button onclick="Router.go('finance')" id="nav-finance" class="nav-btn financial-data w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-cash-register w-5 text-center text-rose-400"></i> ניהול קופה
                </button>
                <button onclick="Router.go('reports')" id="nav-reports" class="nav-btn financial-data w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-file-excel w-5 text-center text-green-400"></i> דוחות והדפסות
                </button>
                
                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider admin-only">מנהל</div>
                <button onclick="Router.go('settings')" id="nav-settings" class="nav-btn admin-only w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-sliders-h w-5 text-center text-gray-400"></i> הגדרות מערכת
                </button>
            </nav>

            <!-- חלק תחתון מעוצב מחדש -->
            <div class="mt-auto bg-slate-900/50 backdrop-blur-md border-t border-slate-700/50 p-4">
                <!-- כפתור יציאה -->
                <button onclick="Auth.logout()" class="group w-full flex items-center gap-3 p-2.5 rounded-xl hover:bg-red-500/10 hover:text-red-400 transition-all duration-300 mb-4 border border-transparent hover:border-red-500/20">
                    <div class="bg-slate-800 group-hover:bg-red-50 text-slate-400 group-hover:text-white w-8 h-8 rounded-lg flex items-center justify-center transition-colors shadow-lg">
                        <i class="fas fa-power-off text-xs"></i>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-300 group-hover:text-red-300">התנתק מהמערכת</div>
                        <div id="user-email-display" class="text-[10px] text-slate-500 truncate w-32">user@sys</div>
                    </div>
                </button>

                <!-- קרדיט מודרני -->
                <div class="relative overflow-hidden rounded-xl bg-gradient-to-r from-indigo-900/40 to-slate-900/40 border border-slate-700/50 p-3 text-center group">
                    <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <p class="text-[10px] text-slate-400 font-medium tracking-wide mb-1 relative z-10">פותח ועוצב ע״י</p>
                    <h4 class="text-sm font-bold text-indigo-300 relative z-10 group-hover:text-white transition-colors">דובי לוי</h4>
                    <a href="mailto:7640421@gmail.com" class="text-[10px] text-slate-500 hover:text-indigo-400 transition relative z-10 flex items-center justify-center gap-1 mt-1">
                        <i class="fas fa-envelope"></i> 7640421@gmail.com
                    </a>
                </div>
            </div>
        </aside>

        <!-- תוכן ראשי -->
        <main id="main-content" class="flex-1 flex flex-col hidden-screen h-full overflow-hidden relative bg-slate-50">
            
            <!-- כותרת עליונה -->
            <header class="bg-white shadow-sm h-16 flex justify-between items-center px-8 z-10 shrink-0 border-b border-gray-200">
                <div class="flex items-center gap-4">
                    <button onclick="document.getElementById('sidebar').classList.toggle('hidden-screen')" class="lg:hidden p-2 text-gray-600"><i class="fas fa-bars"></i></button>
                    <h2 id="page-title" class="text-2xl font-bold text-slate-800 tracking-tight">דף הבית</h2>
                </div>
                
                <div class="flex items-center gap-2">
                     <!-- תיקון מס' 6: רענון פנימי ספציפי -->
                     <button onclick="System.refreshModule()" class="text-gray-500 hover:text-indigo-600 p-2" title="רענן מודול נוכחי"><i class="fas fa-sync-alt"></i></button>
                     <button onclick="history.back()" class="text-gray-500 hover:text-indigo-600 p-2" title="חזור"><i class="fas fa-arrow-left"></i></button>
                    <div class="bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100 flex items-center gap-2">
                        <span class="text-sm text-indigo-900 font-bold">שנה נוכחית:</span>
                        <select id="year-selector" onchange="System.changeYear(this.value)" class="bg-transparent border-none text-indigo-700 font-bold text-sm focus:ring-0 cursor-pointer py-0 outline-none">
                            <!-- שנים יטענו דינמית -->
                        </select>
                        <button onclick="System.addCustomYear()" class="text-indigo-600 hover:text-indigo-800 text-xs bg-white border border-indigo-200 rounded px-1 ml-1 admin-only" title="הוסף שנה ידנית"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </header>

            <!-- מיכל תצוגות -->
            <div id="views-container" class="flex-1 overflow-hidden relative">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="view-section p-6 fade-in hidden space-y-6">
                    <!-- כרטיסי סיכום (נטענים מ-Stats) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 financial-data">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">יתרה בקופה (כללי)</div>
                                <div class="text-3xl font-bold text-slate-800" id="dash-total-balance">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-xl"><i class="fas fa-wallet"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">הכנסות (<span class="curr-year"></span>)</div>
                                <div class="text-3xl font-bold text-emerald-600" id="dash-income">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl"><i class="fas fa-arrow-down"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">הוצאות (<span class="curr-year"></span>)</div>
                                <div class="text-3xl font-bold text-rose-600" id="dash-expense">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-rose-50 text-rose-600 flex items-center justify-center text-xl"><i class="fas fa-arrow-up"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <div class="text-slate-500 text-sm font-medium">יעד שנתי: <span id="dash-goal-text-amount" class="text-amber-700 font-bold ml-1"></span></div>
                                <div class="text-amber-600 font-bold" id="dash-goal-progress">0%</div>
                            </div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div id="dash-bar" class="bg-amber-500 h-full rounded-full transition-all duration-1000" style="width:0%"></div>
                            </div>
                            <div class="mt-2 text-xs text-slate-400">הנתונים מתעדכנים בזמן אמת</div>
                        </div>
                    </div>

                    <!-- אזור פעילות -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700"><i class="fas fa-history text-indigo-500 ml-2"></i>עדכונים אחרונים</h3>
                                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">לייב</span>
                            </div>
                            <div id="dash-logs" class="p-4 overflow-y-auto flex-1 custom-scroll">
                                <p class="text-center text-gray-400 mt-4">טוען תנועות אחרונות...</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div class="bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white flex flex-col items-center justify-center relative overflow-hidden">
                                <i class="fas fa-user-graduate absolute -bottom-4 -right-4 text-8xl text-white/10"></i>
                                <div class="text-5xl font-bold mb-2 z-10" id="dash-stat-students">...</div>
                                <div class="text-indigo-100 z-10">בחורים רשומים</div>
                            </div>
                            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white flex flex-col items-center justify-center relative overflow-hidden">
                                <i class="fas fa-hand-holding-heart absolute -bottom-4 -right-4 text-8xl text-white/10"></i>
                                <div class="text-5xl font-bold mb-2 z-10" id="dash-stat-donors">...</div>
                                <div class="text-emerald-100 z-10">תורמים במערכת</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. STUDENTS -->
                <div id="view-students" class="view-section flex flex-col hidden fade-in bg-white h-full overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex gap-3 items-center justify-between shrink-0">
                        <div class="flex gap-3">
                            <button onclick="Students.openAddModal()" class="btn-primary bg-indigo-600"><i class="fas fa-plus ml-2"></i> הוסף בחור</button>
                            <button onclick="Students.openQuickAdd()" class="btn-secondary"><i class="fas fa-layer-group ml-2 text-indigo-500"></i> הוספה מהירה</button>
                            <button onclick="Importer.init('students')" class="btn-secondary"><i class="fas fa-file-excel ml-2 text-green-600"></i> יבוא מאקסל</button>
                        </div>
                        <div class="relative w-96">
                            <input type="text" id="student-search" oninput="System.searchFirebase(this.value, 'students')" placeholder="חיפוש לפי שם, שיעור או טלפון..." class="input-field w-full pl-4 pr-10">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 custom-scroll" id="students-container">
                        <!-- תיקון: גלילה רוחבית לטבלה -->
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-sm min-w-[600px]">
                                <thead class="bg-slate-50 text-slate-600 sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-3 text-right rounded-r-lg bg-slate-50">שם מלא</th>
                                        <th class="p-3 text-right bg-slate-50">שיעור</th>
                                        <th class="p-3 text-right bg-slate-50">שנת כניסה</th>
                                        <th class="p-3 text-right bg-slate-50">יעד אישי (<span class="curr-year"></span>)</th>
                                        <th class="p-3 text-center rounded-l-lg bg-slate-50">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="students-tbody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="students-loader-more" class="p-6 text-center mt-2 hidden">
                            <button onclick="Students.loadMore()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-6 py-2 rounded-full text-sm font-bold transition shadow-sm">
                                <i class="fas fa-chevron-down ml-2"></i> טען עוד בחורים
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. DONORS -->
                <div id="view-donors" class="view-section flex flex-col hidden fade-in h-full overflow-hidden">
                    <!-- תפריט עליון -->
                    <div class="p-4 bg-white rounded-t-2xl shadow-sm border-b flex flex-col gap-4 mb-0 shrink-0">
                         <div class="flex justify-between items-center w-full">
                            <div class="flex gap-3">
                                <button onclick="Donors.openAddModal()" class="btn-primary bg-emerald-600"><i class="fas fa-plus ml-2"></i> הוסף תורם</button>
                                <button onclick="Donors.toggleQuickManager()" class="btn-secondary border-emerald-200 text-emerald-700 bg-emerald-50 hover:bg-emerald-100">
                                    <i class="fas fa-th ml-2"></i> ניהול שיבוץ מהיר לקבוצות
                                </button>
                                <button onclick="Importer.init('donors')" class="btn-secondary"><i class="fas fa-file-excel text-green-600"></i> יבוא מאקסל</button>
                            </div>
                            <div class="relative w-80">
                                <input type="text" id="donor-search-input" oninput="Donors.renderList(this.value)" placeholder="חפש תורם..." class="input-field w-full pl-4 pr-10">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        <!-- טאבים לזמנים -->
                        <div class="flex gap-2 justify-center border-t pt-3 flex-wrap">
                             <button onclick="Donors.setViewTab('all')" class="tab-modern donor-view-tab active" data-tab="all">כל התורמים</button>
                             <button onclick="Donors.setViewTab('unassigned')" class="tab-modern donor-view-tab" data-tab="unassigned">לא משובצים</button>
                             <button onclick="Donors.setViewTab('night14')" class="tab-modern donor-view-tab" data-tab="night14">ליל י"ד</button>
                             <button onclick="Donors.setViewTab('day14')" class="tab-modern donor-view-tab" data-tab="day14">יום י"ד</button>
                             <button onclick="Donors.setViewTab('day15')" class="tab-modern donor-view-tab" data-tab="day15">יום ט"ו</button>
                        </div>
                        <!-- תיקון מס' 2: חלוקה לקבוצות קיימות -->
                        <div id="donors-groups-filter" class="hidden flex justify-center gap-2 mt-2 bg-gray-50 p-2 rounded">
                            <span class="text-sm font-bold text-gray-500 self-center">סנן לפי קבוצה:</span>
                            <select id="donor-group-select" onchange="Donors.renderList()" class="border p-1 rounded text-sm min-w-[150px]">
                                <option value="">הכל</option>
                            </select>
                        </div>
                    </div>

                    <!-- מסך רגיל: רשימת תורמים (טבלה) -->
                    <div id="donors-list-view" class="flex-1 overflow-y-auto p-4 custom-scroll">
                        <!-- תיקון: גלילה רוחבית לטבלה -->
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-sm min-w-[600px]">
                                <thead class="bg-slate-50 text-slate-600 sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-3 text-right rounded-r-lg bg-slate-50">שם מלא</th>
                                        <th class="p-3 text-right bg-slate-50">כתובת</th>
                                        <th class="p-3 text-right bg-slate-50">טלפון</th>
                                        <th class="p-3 text-right bg-slate-50">קבוצה</th>
                                        <th class="p-3 text-center rounded-l-lg bg-slate-50">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="donors-tbody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="donors-loader-more" class="p-4 text-center hidden">
                            <button onclick="Donors.loadMore()" class="bg-slate-200 text-slate-600 px-6 py-2 rounded-full font-bold text-sm">טען עוד...</button>
                        </div>
                    </div>

                    <!-- מסך ניהול מהיר (Kanban) -->
                    <div id="donors-quick-manager" class="hidden flex-1 flex flex-col h-full overflow-hidden bg-white">
                         <!-- Tabs Container for Donors Manager -->
                         <div class="p-3 border-b bg-slate-50 flex gap-2 shrink-0 justify-center">
                            <button onclick="Donors.setKanbanDay('night14')" class="tab-modern kanban-tab active" data-day="night14">ליל י"ד</button>
                            <button onclick="Donors.setKanbanDay('day14')" class="tab-modern kanban-tab" data-day="day14">יום י"ד</button>
                            <button onclick="Donors.setKanbanDay('day15')" class="tab-modern kanban-tab" data-day="day15">יום ט"ו</button>
                        </div>
                        
                        <div class="flex-1 flex gap-4 overflow-hidden p-4">
                             <!-- עמודה 1: מאגר תורמים לא משובצים -->
                            <div class="w-1/4 bg-white rounded-xl shadow border flex flex-col h-full shrink-0">
                                <div class="p-3 border-b bg-gray-50 font-bold text-gray-700 flex justify-between">
                                    <span>מאגר לא משובצים</span>
                                    <span id="pool-count" class="bg-gray-200 text-xs px-2 py-0.5 rounded-full">0</span>
                                </div>
                                <div class="p-2 border-b"><input type="text" placeholder="סנן..." oninput="Donors.filterPool(this.value)" class="w-full text-xs p-1 border rounded"></div>
                                <div id="donor-pool-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50/50 custom-scroll"></div>
                            </div>

                            <!-- אזור קבוצות (גרירה) -->
                            <div class="flex-1 bg-white rounded-xl shadow border flex flex-col overflow-hidden">
                                <div class="p-3 border-b bg-indigo-50 font-bold text-indigo-800 flex justify-between items-center">
                                    <span>קבוצות השנה (<span class="curr-year"></span>)</span>
                                    <div class="text-xs font-normal">לחץ על כותרת קבוצה לצפייה בפרטים</div>
                                </div>
                                <div class="flex-1 overflow-x-auto overflow-y-hidden p-4 whitespace-nowrap bg-slate-100 custom-scroll" id="groups-kanban-container">
                                    <!-- קבוצות ייווצרו כאן דינמית כעמודות -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. GROUPS -->
                <div id="view-groups" class="view-section flex flex-col hidden fade-in bg-white h-full overflow-hidden">
                    <div class="px-6 py-4 border-b bg-slate-50 flex gap-3 shrink-0 justify-center shadow-sm z-10 items-center">
                        <button onclick="Groups.setDay('night14')" class="tab-modern group-tab active" data-day="night14">ליל י"ד</button>
                        <button onclick="Groups.setDay('day14')" class="tab-modern group-tab" data-day="day14">יום י"ד</button>
                        <button onclick="Groups.setDay('day15')" class="tab-modern group-tab" data-day="day15">יום ט"ו</button>
                        <div class="h-8 w-px bg-gray-300 mx-2"></div>
                        <button onclick="Groups.printAllGroups()" class="bg-gray-800 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-gray-700"><i class="fas fa-print ml-1"></i> הדפס משבצות (יום נבחר)</button>
                    </div>

                    <div class="flex flex-1 overflow-hidden">
                        <!-- רשימת קבוצות בצד -->
                        <div class="w-72 border-l flex flex-col bg-white">
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50/50">
                                <span class="font-bold text-sm text-slate-700">רשימת קבוצות</span>
                                <button onclick="Groups.addNewGroup()" class="bg-indigo-100 text-indigo-600 hover:bg-indigo-200 p-1.5 rounded-lg transition"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="groups-list" class="flex-1 overflow-y-auto custom-scroll"></div>
                        </div>

                        <!-- אזור עבודה -->
                        <div class="flex-1 flex flex-col bg-slate-50 relative" id="group-workspace">
                            <div id="group-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400 flex-col">
                                <i class="fas fa-layer-group text-6xl mb-4 text-slate-200"></i>
                                <p>בחר קבוצה לעריכה</p>
                            </div>

                            <div id="group-editor" class="hidden flex flex-col h-full">
                                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10">
                                    <div class="flex gap-3 items-center">
                                        <h3 id="active-group-name" class="font-bold text-xl text-slate-800 cursor-pointer hover:bg-gray-100 px-2 rounded" onclick="Groups.renameGroup()" title="לחץ לשינוי שם"></h3>
                                        <span id="active-group-details" class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full border"></span>
                                        <button onclick="Groups.deleteGroup()" class="text-red-500 bg-red-50 hover:bg-red-100 px-2 py-1 rounded border border-red-100 text-xs font-bold mr-2">מחק קבוצה</button>
                                        <!-- כפתור תרומה קבוצתית -->
                                        <button onclick="Groups.openGroupDonationModal()" class="btn-secondary text-xs bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 font-bold"><i class="fas fa-hand-holding-usd"></i> תרומה קבוצתית</button>
                                    </div>
                                    <div class="flex gap-2 text-sm">
                                        <button onclick="Groups.printSheet('members')" class="btn-secondary text-xs"><i class="fas fa-users"></i> דף קבוצה</button>
                                        <button onclick="Groups.printSheet('route')" class="btn-secondary text-xs"><i class="fas fa-route"></i> דף מסלול</button>
                                        <button onclick="Groups.exportGroupData('excel')" class="btn-secondary text-xs admin-only"><i class="fas fa-file-excel"></i> יצוא אקסל</button>
                                        <button onclick="Groups.exportGroupData('pdf')" class="btn-secondary text-xs admin-only"><i class="fas fa-file-pdf"></i> יצוא PDF</button>
                                    </div>
                                </div>

                                <div class="flex flex-1 overflow-hidden">
                                    <!-- עמודה 1: מסלול תורמים -->
                                    <div class="w-1/2 flex flex-col border-l bg-white">
                                        <div class="p-3 bg-emerald-50 text-emerald-900 font-bold text-sm border-b flex justify-between">
                                            <span><i class="fas fa-map-signs"></i> מסלול תורמים</span>
                                            <span class="text-xs font-normal opacity-70">סדר את המסלול בגרירה</span>
                                        </div>
                                        <div id="group-route-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50 custom-scroll"></div>
                                    </div>

                                    <!-- עמודה 2: שיבוץ בחורים -->
                                    <div class="w-1/2 flex flex-col bg-white">
                                        <div class="p-3 bg-indigo-50 text-indigo-900 font-bold text-sm border-b"><i class="fas fa-user-friends"></i> שיבוץ בחורים</div>
                                        <div class="flex-1 flex flex-col overflow-hidden">
                                            <!-- רשימת בחורים בקבוצה -->
                                            <div id="group-members-list" class="flex-1 overflow-y-auto p-3 space-y-2 h-1/2 border-b custom-scroll"></div>
                                            <!-- הוספת בחור -->
                                            <div class="h-1/2 flex flex-col bg-slate-50">
                                                <div class="p-2 border-b bg-white relative">
                                                    <input type="text" placeholder="חפש בחור להוספה..." oninput="Groups.filterStudents(this.value)" class="w-full text-sm p-2 border rounded pl-8">
                                                    <i class="fas fa-search absolute left-4 top-4 text-gray-300 text-xs"></i>
                                                </div>
                                                <div id="pool-students" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. FINANCE -->
                <div id="view-finance" class="view-section flex flex-col hidden fade-in financial-data bg-white h-full overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0">
                        <div class="flex gap-3">
                             <!-- איחוד כפתורים -->
                             <button onclick="Finance.renderBatchTransactionForm()" class="btn-primary bg-indigo-600 hover:bg-indigo-700"><i class="fas fa-plus-circle ml-2"></i> הוסף תנועה / רשימה מרוכזת</button>
                             <!-- תיקון מס' 4: כפתור לניהול תלושים -->
                             <button onclick="Finance.openVouchersView()" class="btn-secondary text-purple-700 border-purple-200 bg-purple-50 hover:bg-purple-100 font-bold"><i class="fas fa-ticket-alt ml-2"></i> מימוש תלושים</button>
                             <button onclick="Finance.openStoreDebtsView()" class="btn-secondary text-rose-700 border-rose-200 bg-rose-50 hover:bg-rose-100 font-bold"><i class="fas fa-store-alt ml-2"></i> ניהול חובות לחנויות</button>
                        </div>
                        <div class="flex bg-white rounded-lg p-1 border shadow-sm">
                            <button onclick="Finance.setFilter('all')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter active" data-f="all">הכל</button>
                            <button onclick="Finance.setFilter('income')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-gray-50 text-gray-600" data-f="income">הכנסות</button>
                            <button onclick="Finance.setFilter('expense')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-gray-50 text-gray-600" data-f="expense">הוצאות</button>
                            <button onclick="Finance.setFilter('purim')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-purple-50 text-purple-600" data-f="purim"><i class="fas fa-mask ml-1"></i> פורים</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-hidden flex flex-col" id="finance-main-view">
                        <div class="overflow-y-auto flex-1 p-4 custom-scroll" id="finance-scroll-container">
                             <!-- תיקון: גלילה רוחבית לטבלה -->
                            <div class="overflow-x-auto w-full">
                                <table class="w-full text-sm text-right border-collapse min-w-[600px]">
                                    <thead class="bg-slate-100 text-slate-600 sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th class="p-3 rounded-r-lg bg-slate-100">תאריך</th>
                                            <th class="p-3 bg-slate-100">סוג</th>
                                            <th class="p-3 bg-slate-100">קטגוריה</th>
                                            <th class="p-3 bg-slate-100">תיאור / משוייך ל...</th>
                                            <th class="p-3 bg-slate-100">סכום</th>
                                            <th class="p-3 rounded-l-lg bg-slate-100">פעולות</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finance-tbody" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                            <div id="finance-loader-more" class="p-4 text-center mt-2 hidden">
                                <button onclick="Finance.loadMore()" class="text-indigo-600 hover:underline font-bold">טען היסטוריה ישנה יותר...</button>
                            </div>
                        </div>
                    </div>
                    <!-- אזור מימוש תלושים -->
                    <div id="finance-vouchers-view" class="hidden flex-1 overflow-y-auto p-4 custom-scroll bg-purple-50">
                        <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow">
                            <h3 class="font-bold text-xl mb-4 text-purple-800 flex justify-between">
                                <span><i class="fas fa-ticket-alt ml-2"></i> תלושים שממתינים למימוש (עדיין לא הוצאה)</span>
                                <button onclick="Finance.closeVouchersView()" class="text-sm bg-gray-200 px-3 py-1 rounded">חזור לקופה</button>
                            </h3>
                            <div id="pending-vouchers-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <!-- אזור חובות לחנויות -->
                    <div id="finance-store-debts-view" class="hidden flex-1 overflow-y-auto p-4 custom-scroll bg-rose-50">
                         <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow">
                            <h3 class="font-bold text-xl mb-4 text-rose-800 flex justify-between">
                                <span><i class="fas fa-store-alt ml-2"></i> ניהול חובות לחנויות (תלושים שמומשו)</span>
                                <button onclick="Finance.closeStoreDebtsView()" class="text-sm bg-gray-200 px-3 py-1 rounded">חזור לקופה</button>
                            </h3>
                            <div id="store-debts-container"></div>
                        </div>
                    </div>
                </div>

                <!-- 6. REPORTS -->
                <div id="view-reports" class="view-section hidden fade-in financial-data p-6">
                    <h2 class="text-3xl font-bold mb-8 text-slate-800">דוחות והדפסות</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        
                        <!-- דוח כללי -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-4"><i class="fas fa-file-invoice-dollar text-xl"></i></div>
                            <h3 class="font-bold text-lg mb-2">דוח תנועות כספיות</h3>
                            <p class="text-sm text-gray-500 mb-4">ייצוא כל ההכנסות וההוצאות לאקסל עם אפשרויות סינון.</p>
                            <div class="space-y-3">
                                <select id="rep-type" class="input-field w-full text-sm"><option value="all">הכל</option><option value="income">רק הכנסות</option><option value="expense">רק הוצאות</option></select>
                                <!-- חיפוש חכם לישות -->
                                <div class="relative group">
                                    <input type="text" id="rep-entity-search" placeholder="חפש בחור/תורם לסינון..." oninput="Reports.searchEntity(this.value)" class="input-field w-full text-sm">
                                    <input type="hidden" id="rep-entity-id">
                                    <div id="rep-entity-results" class="absolute top-full right-0 w-full bg-white border shadow-lg rounded-b max-h-40 overflow-y-auto hidden z-20 custom-scroll"></div>
                                </div>
                                <button onclick="Reports.generateStandard()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold hover:bg-slate-700 text-sm">הורד לאקסל</button>
                            </div>
                        </div>

                        <!-- דוח תצוגה פורים -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition">
                            <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-4"><i class="fas fa-magic text-xl"></i></div>
                            <h3 class="font-bold text-lg mb-2">דוח תצוגה (אחרי פורים)</h3>
                            <p class="text-sm text-gray-500 mb-4">נתונים משוקללים להדפסה (כל הבחורים, בונוסים ועוד) עם עורך חזותי מלא.</p>
                            <button onclick="Reports.openEditor()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700 text-sm">פתח עורך דוחות</button>
                        </div>
                    </div>
                </div>

                <!-- 7. SETTINGS & ADMIN -->
                <div id="view-settings" class="view-section p-6 hidden fade-in admin-only">
                    <div class="max-w-5xl mx-auto space-y-8 pb-10">
                        <h2 class="text-3xl font-bold text-slate-800">הגדרות מערכת</h2>

                        <!-- סנכרון שנתי -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-orange-100 bg-orange-50/30">
                            <div class="flex justify-between items-center gap-4">
                                <div>
                                    <h3 class="font-bold text-xl text-orange-800">תחזוקה שנתית</h3>
                                    <p class="text-sm text-gray-500">קידום שיעורים וסנכרון לשנה העברית החדשה. בוגרי "קיבוץ ח" יועברו לרשימת תורמים.</p>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="Settings.syncYears()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition text-sm">בצע סנכרון שנתי</button>
                                    <button onclick="Groups.copyFromPreviousYear()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition text-sm">יבא מבנה קבוצות משנה שעברה</button>
                                    <!-- תיקון מס' 7: מחיקת מטמון -->
                                    <button onclick="System.clearLocalCache()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition text-sm"><i class="fas fa-eraser ml-1"></i> נקה מטמון דפדפן (פתרון תקלות)</button>
                                </div>
                            </div>
                        </div>

                        <!-- הוספת משתמשים -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-6 text-slate-700 border-b pb-2">ניהול משתמשים והרשאות</h3>
                            <div class="grid grid-cols-1 gap-4">
                                <div class="p-4 bg-gray-50 rounded-xl border">
                                    <h4 class="font-bold mb-3 text-sm">הוספת משתמש / מנהל חדש</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <input type="email" id="new-user-email" placeholder="אימייל" class="input-field text-sm">
                                        <input type="password" id="new-user-pass" placeholder="סיסמה" class="input-field text-sm">
                                        <select id="new-user-role" class="input-field text-sm">
                                            <option value="user">משתמש (עריכה בלבד, ללא כספים)</option>
                                            <option value="admin">מנהל (הרשאה מלאה)</option>
                                        </select>
                                        <button onclick="Settings.createUser()" class="bg-slate-800 text-white rounded-lg font-bold text-sm">צור משתמש</button>
                                    </div>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <h4 class="font-bold mb-3 text-sm">משתמשים קיימים</h4>
                                    <div id="users-list-container" class="space-y-2">
                                        <!-- רשימת משתמשים תטען כאן -->
                                    </div>
                                    <button onclick="Settings.loadUsersList()" class="text-sm text-blue-600 font-bold hover:underline mt-2">טען רשימת משתמשים</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- JSON IMPORT / EXPORT -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-indigo-100">
                             <h3 class="font-bold text-xl mb-6 text-indigo-800 border-b pb-2">גיבוי וייצוא מלא (JSON)</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <button onclick="Settings.exportDataAsJSON()" class="w-full bg-indigo-600 text-white p-4 rounded-xl shadow hover:bg-indigo-700 flex items-center justify-center gap-2">
                                         <i class="fas fa-download"></i> הורד גיבוי מלא (JSON)
                                     </button>
                                     <p class="text-xs text-gray-500 mt-2">מוריד את כל הנתונים של המערכת לקובץ אחד.</p>
                                 </div>
                                 <div>
                                     <button onclick="document.getElementById('json-import-input').click()" class="w-full bg-white border-2 border-indigo-200 text-indigo-700 p-4 rounded-xl hover:bg-indigo-50 flex items-center justify-center gap-2">
                                         <i class="fas fa-upload"></i> שחזר / ייבא מגיבוי (JSON)
                                     </button>
                                     <p class="text-xs text-gray-500 mt-2 text-red-500 font-bold"><i class="fas fa-exclamation-triangle"></i> הפעולה לא דורסת נתונים קיימים, אלא מוסיפה רק חוסרים.</p>
                                 </div>
                             </div>
                        </div>

                        <!-- ניהול שדות מותאמים -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-6 text-slate-700 border-b pb-2">ניהול שדות מידע</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label class="block text-sm font-bold mb-2">בחר סוג רשימה:</label>
                                    <select id="settings-field-type" onchange="Settings.renderFieldsEditor()" class="input-field w-full mb-4">
                                        <option value="students">שדות בחור</option>
                                        <option value="donors">שדות תורם</option>
                                        <option value="finance">שדות כספים</option>
                                    </select>
                                    
                                    <div class="bg-gray-50 p-4 rounded-xl border">
                                        <div class="text-sm font-bold mb-2">הוסף שדה מהרשימה:</div>
                                        <div class="flex gap-2 mb-4">
                                            <select id="settings-predefined-field" class="input-field flex-1 text-sm"></select>
                                            <button onclick="Settings.addField()" class="btn-primary bg-indigo-600 text-sm px-4">הוסף</button>
                                        </div>
                                        
                                        <!-- אזור הוספת שדה מותאם אישית חדש -->
                                        <div class="border-t pt-4 mt-4">
                                             <div class="text-sm font-bold mb-2 text-indigo-700">+ צור שדה חדש לגמרי:</div>
                                             <div class="grid grid-cols-2 gap-2 mb-2">
                                                 <input type="text" id="custom-field-key" placeholder="מזהה (באנגלית)" class="input-field text-sm">
                                                 <input type="text" id="custom-field-label" placeholder="תווית (בעברית)" class="input-field text-sm">
                                             </div>
                                             <button onclick="Settings.addCustomField()" class="w-full bg-indigo-100 text-indigo-700 text-sm font-bold py-2 rounded hover:bg-indigo-200">צור והוסף שדה</button>
                                        </div>

                                        <div class="border-t pt-4 mt-4">
                                            <div class="text-sm font-bold mb-2 text-red-700">שדות מותאמים שנשמרו במערכת:</div>
                                            <div id="settings-custom-list" class="space-y-1"></div>
                                        </div>

                                        <div class="text-sm font-bold mt-4 mb-2">שדות פעילים:</div>
                                        <div id="settings-active-fields" class="space-y-2"></div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500 bg-blue-50 p-4 rounded-xl">
                                    <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-info-circle"></i> מידע</h4>
                                    <p class="mb-2">שינוי שדות כאן ישפיע על:</p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>טפסי הוספה/עריכה</li>
                                        <li>עמודות ביבוא ויצוא אקסל</li>
                                        <li>תצוגת הנתונים בטבלאות</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- תיקון מס' 4: כפתור נפרד להוספת תלושים ומענקים -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-purple-100 bg-purple-50/20">
                            <h3 class="font-bold text-xl mb-6 text-purple-800 border-b pb-2">ניהול תלושים ומענקים</h3>
                            <div id="settings-vouchers-list" class="space-y-3"></div>
                            <button onclick="Settings.addVoucherType()" class="btn-secondary text-purple-700 border-purple-200 hover:bg-purple-100 mt-3 text-sm font-bold">+ הוסף סוג תלוש חדש</button>
                            <p class="text-xs text-gray-500 mt-2">כאן מגדירים את סוגי התלושים והחנויות. בעת רישום הוצאה לבחור, ניתן יהיה לבחור תלוש במקום מזומן.</p>
                        </div>
                        
                        <!-- חוקים, יעדים ומתנות -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-6 text-slate-700 border-b pb-2">יעדים ותמריצים כלליים</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="lbl">יעד גיוס כללי למערכת (ש"ח)</label>
                                    <input type="number" id="conf-global-goal" class="input-field w-full" onchange="Settings.save('globalGoal', this.value)">
                                </div>
                                <div class="bg-gray-50 p-4 rounded border">
                                    <label class="lbl mb-2">הנחת חבר קבוצה לפי זמן (ש"ח)</label>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 text-sm">ליל י"ד:</span>
                                            <input type="number" id="conf-disc-night14" class="input-field w-full text-sm p-1" onchange="Settings.saveGroupDiscount('night14', this.value)">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 text-sm">יום י"ד:</span>
                                            <input type="number" id="conf-disc-day14" class="input-field w-full text-sm p-1" onchange="Settings.saveGroupDiscount('day14', this.value)">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 text-sm">יום ט"ו:</span>
                                            <input type="number" id="conf-disc-day15" class="input-field w-full text-sm p-1" onchange="Settings.saveGroupDiscount('day15', this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 border-t pt-4">
                                <h4 class="font-bold text-sm mb-3">בונוס אחוזים לתרומת תורם בודד (לפי מדרגות)</h4>
                                <p class="text-xs text-gray-500 mb-2">כאשר תורם תורם סכום בטווח מסוים, הבחור יקבל אחוז מסוים.</p>
                                <div id="settings-bonus-tiers" class="space-y-2"></div>
                                <button onclick="Settings.addBonusTier()" class="text-indigo-600 text-sm font-bold mt-2 hover:underline">+ הוסף מדרגת טווח לתורם</button>
                            </div>

                            <div class="mt-6 border-t pt-4">
                                <h4 class="font-bold text-sm mb-3">בונוסים למביא תורם (סכום קבוע/מתנה)</h4>
                                <div id="settings-goals-tiers" class="space-y-2"></div>
                                <button onclick="Settings.addGoalTier()" class="text-indigo-600 text-sm font-bold mt-2 hover:underline">+ הוסף בונוס קבוע</button>
                            </div>
                        </div>

                        <!-- יעדים ותגמולים לבחורים (חדש) -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-amber-100 bg-amber-50/20">
                            <h3 class="font-bold text-xl mb-6 text-amber-800 border-b pb-2"><i class="fas fa-trophy mr-2"></i> יעדים ותגמולים לבחורים</h3>
                            <div class="mb-6">
                                <label class="lbl text-amber-900">יעד בסיס לכל בחור (מינימום)</label>
                                <input type="number" id="conf-base-student-goal" placeholder="לדוגמה: 2000" class="input-field w-full max-w-xs" onchange="Settings.save('baseStudentGoal', this.value)">
                                <p class="text-xs text-gray-500 mt-1">יעד זה יוצג כברירת מחדל לכל בחור שלא הוגדר לו יעד אחר.</p>
                            </div>

                            <div>
                                <h4 class="font-bold text-sm mb-3 text-amber-800">הגדרת מדרגות יעדים ומתנות</h4>
                                <div id="settings-student-rewards" class="space-y-3"></div>
                                <button onclick="Settings.addStudentReward()" class="btn-secondary text-amber-700 border-amber-200 hover:bg-amber-100 mt-3 text-sm font-bold">+ הוסף יעד תגמול</button>
                            </div>
                        </div>
                        
                        <!-- תיקון מס' 9: אפשרות ביטול AI למנהל -->
                        <div class="bg-white p-8 rounded-2xl shadow-sm border mt-4">
                            <h3 class="font-bold text-xl mb-2 text-slate-700">עוזר אישי (AI)</h3>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="conf-enable-ai" onchange="Settings.save('enableAI', this.checked ? 1 : 0); System.toggleAI(this.checked);" class="h-5 w-5 rounded text-indigo-600">
                                <span class="text-sm font-medium">הפעל עוזר אישי למנהל (בועת צ'אט)</span>
                            </label>
                        </div>

                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal: Generic Form -->
    <div id="modal-form" class="fixed inset-0 z-50 bg-black/60 hidden-screen flex items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-[550px] max-w-[90vw] overflow-hidden flex flex-col max-h-[90vh] scale-100 transition-transform">
            <div class="p-5 bg-gradient-to-r from-slate-800 to-slate-900 text-white flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="font-bold text-xl tracking-wide">כותרת</h3>
                <button onclick="Modal.close()" class="hover:text-red-300 hover:rotate-90 transition transform"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-body" class="p-8 overflow-y-auto space-y-5 custom-scroll"></div>
            <div class="p-5 bg-gray-50 flex gap-4 border-t shrink-0">
                <button id="modal-save-btn" class="flex-1 btn-primary py-3 text-lg shadow-md">שמור</button>
                <button onclick="Modal.close()" class="flex-1 btn-secondary py-3 text-lg">ביטול</button>
            </div>
        </div>
    </div>

    <!-- תיקון מס' 9 + AI Offline: בועת AI למנהל -->
    <div id="ai-bubble-container" class="hidden-screen">
        <div id="ai-chat-window">
            <div class="chat-header">
                <span>עוזר אישי (BETA)</span>
                <button onclick="document.getElementById('ai-chat-window').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-body" id="ai-messages">
                <div class="p-2 bg-indigo-50 rounded mb-2 text-xs">
                    שלום! אני העוזר האישי. אני מבין שפה טבעית ועובד גם ללא אינטרנט.<br>
                    נסה לבקש דוחות, לחפש בחורים ("נתונים על יוסי"), או לשאול על מצב הקופה.<br>
                    אם לא אבין, אשאל שאלות הכוונה.<br>
                    <b>הקש "עזרה" לרשימת פקודות.</b>
                </div>
            </div>
            <div class="p-2 border-t bg-gray-50 flex">
                <input type="text" id="ai-input" placeholder="הקלד שאלה (למשל: תן לי דוח כספי)..." class="flex-1 border rounded px-2 py-1 text-sm outline-none" onkeypress="if(event.key === 'Enter') OfflineAI.send()">
                <button class="ml-2 text-indigo-600 font-bold" onclick="OfflineAI.send()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div id="ai-fab" onclick="const w=document.getElementById('ai-chat-window'); w.style.display = w.style.display==='flex'?'none':'flex'">
            <i class="fas fa-robot"></i>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. CONFIGURATION & PREDEFINED DATA ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRunXdWIFiP8-vZao0WZ6WxItMAUt-ORY",
            authDomain: "ezer--project.firebaseapp.com",
            databaseURL: "https://ezer--project-default-rtdb.firebaseio.com",
            projectId: "ezer--project",
            storageBucket: "ezer--project.firebasestorage.app",
            messagingSenderId: "838086109276",
            appId: "1:838086109276:web:201babf8b31c39a0cc9e99"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

        const SHIURIM_ORDER = ['שיעור א', 'שיעור ב', 'שיעור ג', 'קיבוץ א', 'קיבוץ ב', 'קיבוץ ג', 'קיבוץ ד', 'קיבוץ ה', 'קיבוץ ו', 'קיבוץ ז', 'קיבוץ ח'];
        const HEBREW_YEARS_MAPPING = {
            'תש״פ': '5780', 'תשפ״א': '5781', 'תשפ״ב': '5782', 'תשפ״ג': '5783', 
            'תשפ״ד': '5784', 'תשפ״ה': '5785', 'תשפ״ו': '5786', 'תשפ״ז': '5787'
        };
        
        // רשימת שדות קבועה לבחירה בהגדרות (עודכן: שדות תורם חדשים)
        const PREDEFINED_FIELDS = {
            students: [
                {k:'firstName', l:'שם פרטי', t:'text', r:true},
                {k:'lastName', l:'שם משפחה', t:'text', r:true},
                {k:'phone', l:'טלפון', t:'text'},
                {k:'grade', l:'שיעור', t:'select', opts:SHIURIM_ORDER},
                {k:'entryYear', l:'שנת כניסה', t:'text'}, 
                {k:'idNum', l:'תעודת זהות', t:'text'},
                {k:'city', l:'עיר מגורים', t:'text'},
                {k:'fatherName', l:'שם האב', t:'text'},
                {k:'room', l:'מספר חדר', t:'text'}
            ],
            donors: [
                {k:'firstName', l:'שם פרטי', t:'text', r:true},
                {k:'lastName', l:'שם משפחה', t:'text', r:true},
                {k:'city', l:'עיר', t:'text'},
                {k:'neighborhood', l:'שכונה', t:'text'},
                {k:'street', l:'רחוב', t:'text'},
                {k:'floor', l:'קומה', t:'text'},
                {k:'phone', l:'טלפון', t:'text'},
                {k:'email', l:'אימייל', t:'email'},
                {k:'referrerId', l:'בחור מביא', t:'referrer_select'},
                {k:'notes', l:'הערות', t:'textarea'},
                {k:'vip', l:'VIP', t:'checkbox'}
            ]
        };
        
        // עדכון שדות פעילים ברירת מחדל
        const DEFAULT_ACTIVE_FIELDS = {
            students: ['firstName', 'lastName', 'phone','grade','entryYear'],
            donors: ['firstName', 'lastName', 'city', 'neighborhood', 'street', 'floor', 'phone', 'notes']
        };

        const getHebrewYear = () => {
            const d = new Date();
            const y = d.getFullYear();
            const hYear = d.getMonth() > 8 ? y + 3761 : y + 3760; 
            const map = {5780:'תש״פ', 5781:'תשפ״א', 5782:'תשפ״ב', 5783:'תשפ״ג', 5784:'תשפ״ד', 5785:'תשפ״ה', 5786:'תשפ״ו', 5787:'תשפ״ז', 5788:'תשפ״ח'};
            return map[hYear] || hYear.toString();
        };

        // --- NEW: LISTENER MANAGER ---
        const ListenerManager = {
            activeListeners: [],
            add(ref, eventType, callback) {
                ref.on(eventType, callback);
                this.activeListeners.push({ ref, eventType, callback });
            },
            remove(ref, eventType, callback) {
                ref.off(eventType, callback);
                this.activeListeners = this.activeListeners.filter(l => l.callback !== callback);
            },
            clearAll() {
                this.activeListeners.forEach(l => l.ref.off(l.eventType, l.callback));
                this.activeListeners = [];
                console.log('All listeners cleared');
            }
        };

        // --- 0. UTILS ---
        const Notify = {
            show(msg, type = 'info') {
                const con = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
                el.innerHTML = `<i class="fas ${icon} toast-icon"></i><span class="font-medium text-slate-800 text-sm">${msg}</span>`;
                con.appendChild(el);
                setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
            }
        };

        const OfflineManager = {
            isOnline: navigator.onLine,
            queue: [],
            
            init() {
                try {
                    const q = localStorage.getItem('offlineQueue');
                    this.queue = q ? JSON.parse(q) : [];
                } catch (e) {
                    console.error("Error parsing offline queue:", e);
                    this.queue = [];
                }
                
                window.addEventListener('online', () => this.updateStatus(true));
                window.addEventListener('offline', () => this.updateStatus(false));
                this.updateStatus(this.isOnline);
            },
            
            saveState(key, data) {
                try {
                    localStorage.setItem('cache_' + key, JSON.stringify(data));
                } catch(e) { console.error('Cache full or invalid', e); }
            },
            
            loadState(key) {
                try {
                    const item = localStorage.getItem('cache_' + key);
                    return item ? JSON.parse(item) : null;
                } catch(e) { return null; }
            },

            // [5] עדכון סטטוס חיבור כך שיהיה תמיד גלוי וברור
            updateStatus(online) {
                this.isOnline = online;
                const ind = document.getElementById('connection-status');
                const txt = document.getElementById('conn-text');
                
                // הסרנו את display:none, תמיד מוצג
                if(online) {
                    if(this.queue.length > 0) {
                        ind.className = 'status-syncing';
                        txt.innerText = `מסנכרן ${this.queue.length}...`;
                        this.processQueue();
                    } else {
                        ind.className = 'status-connected';
                        txt.innerText = 'מחובר';
                    }
                } else {
                    ind.className = 'status-offline';
                    txt.innerText = 'מנותק (שמירה מקומית)';
                }
            },
            
            write(path, data, type = 'set') {
                this.updateLocalStore(path, data, type);

                if(this.isOnline) {
                    if(type === 'set') return db.ref(path).set(data);
                    if(type === 'update') return db.ref(path).update(data);
                    if(type === 'remove') return db.ref(path).remove();
                    if(type === 'transaction') return db.ref(path).transaction(data);
                } else {
                    if(type === 'transaction') {
                        Notify.show('לא ניתן לבצע חישובים מורכבים במצב אופליין', 'error');
                        return;
                    }
                    this.queue.push({path, data, type, ts: Date.now()});
                    localStorage.setItem('offlineQueue', JSON.stringify(this.queue));
                    Notify.show('נשמר בתור לסינכרון', 'info');
                    this.updateStatus(false);
                }
            },

            updateLocalStore(path, data, type) {
                const parts = path.split('/');
                let storeKey = null;
                let itemId = null;

                // זיהוי לאיזה Store שייך הנתיב
                if (path.includes('global/students')) { storeKey = 'students'; itemId = parts[2]; }
                else if (path.includes('global/donors')) { storeKey = 'donors'; itemId = parts[2]; }
                else if (path.includes('/finance/')) {
                    // טיפול מיוחד בfinance - הנתיב הוא years/YEAR/finance/ID
                    // data הוא העסקה המלאה
                    const txId = parts[parts.length - 1];
                    if (type === 'remove') {
                        if (Finance.financeData[txId]) delete Finance.financeData[txId];
                    } else {
                         // עדכון מקומי של financeData כדי שיוצג מיד בטבלה
                         const txData = type === 'update' ? { ...(Finance.financeData[txId]||{}), ...data } : data;
                         Finance.financeData[txId] = txData;
                    }
                    if (Router.current === 'finance') Finance.render();
                    return; // finance handled
                }

                if (storeKey && itemId) {
                    if (type === 'remove') {
                        if (Store.data[storeKey][itemId]) {
                            delete Store.data[storeKey][itemId];
                        }
                    } else if (type === 'set' || type === 'update') {
                        const existing = Store.data[storeKey][itemId] || {};
                        Store.data[storeKey][itemId] = type === 'update' ? { ...existing, ...data } : data;
                    }
                    this.saveState(storeKey, Store.data[storeKey]);
                    
                    if (Router.current === storeKey) {
                        if(storeKey === 'students') Students.render();
                        else Donors.render();
                    }
                }
                
                // עדכון יעדים (studentData)
                if (path.includes('studentData') && path.includes('personalGoal')) {
                    const year = parts[1];
                    const sid = parts[3];
                    if(!Store.data.yearData[year]) Store.data.yearData[year] = {};
                    if(!Store.data.yearData[year].students) Store.data.yearData[year].students = {};
                    if(!Store.data.yearData[year].students[sid]) Store.data.yearData[year].students[sid] = {};
                    
                    if (type === 'remove') delete Store.data.yearData[year].students[sid].personalGoal;
                    else Store.data.yearData[year].students[sid].personalGoal = data;
                    
                    if(Router.current === 'students') Students.render();
                }
            },
            
            processQueue() {
                const q = [...this.queue];
                this.queue = [];
                localStorage.setItem('offlineQueue', '[]');
                
                q.forEach(item => {
                    if(item.type === 'set') db.ref(item.path).set(item.data);
                    if(item.type === 'update') db.ref(item.path).update(item.data);
                    if(item.type === 'remove') db.ref(item.path).remove();
                });
                
                setTimeout(() => {
                    Notify.show('כל הנתונים סונכרנו בהצלחה', 'success');
                    this.updateStatus(true);
                }, 1000);
            }
        };
        OfflineManager.init();


        // --- 2. SYSTEM STATE ---
        const Store = {
            currentYear: getHebrewYear(),
            user: null,
            role: 'user',
            data: {
                students: {}, 
                donors: {},   
                yearData: {}, 
                config: { fields: {}, goals: [], studentTiers: [], customFieldsDefs: {}, groupDiscounts: {}, bonusTiers: [], vouchers: [] },
                donorGroupMap: {},
                stats: { income: 0, expense: 0 } 
            },
            cursors: { students: null, donors: null, finance: null },
            loadedAll: { students: false, donors: false },

            init() {
                const cachedStudents = OfflineManager.loadState('students');
                const cachedDonors = OfflineManager.loadState('donors');
                
                if(cachedStudents) this.data.students = cachedStudents;
                if(cachedDonors) this.data.donors = cachedDonors;
                
                this.loadConfig();
                this.loadStats();
                
                if (!cachedStudents || Object.keys(cachedStudents).length === 0) {
                    Students.loadMore(true); 
                } else {
                    Students.syncNewest();
                }

                if (!cachedDonors || Object.keys(cachedDonors).length === 0) {
                    Donors.loadMore(true);
                } else {
                    Donors.syncNewest();
                }

                this.loadGroups();
            },

            loadStats() {
                if (Store.role === 'user') return;
                const ref = db.ref(`years/${this.currentYear}/stats`);
                ListenerManager.add(ref, 'value', s => {
                    this.data.stats = s.val() || { income: 0, expense: 0 };
                    if(Router.current === 'dashboard') Dashboard.render();
                });
            },
            
            loadGroups() {
                const ref = db.ref(`years/${this.currentYear}/groups`);
                ListenerManager.add(ref, 'value', snap => {
                    if(!this.data.yearData[this.currentYear]) this.data.yearData[this.currentYear] = {};
                    const groupsData = snap.val() || {};
                    this.data.yearData[this.currentYear].groups = groupsData;
                    
                    this.data.donorGroupMap = {};
                    Object.values(groupsData).forEach(dayGroups => {
                        Object.values(dayGroups).forEach(g => {
                            if(g.route) g.route.forEach(did => this.data.donorGroupMap[did] = g.name);
                        });
                    });
                    
                    UI.updateIfVisible('groups');
                    if(Router.current === 'donors') Donors.render(); 
                });
            },

            loadConfig() {
                const ref = db.ref('settings');
                ListenerManager.add(ref, 'value', s => {
                    this.data.config = s.val() || {};
                    if(!this.data.config.fields) this.data.config.fields = JSON.parse(JSON.stringify(DEFAULT_ACTIVE_FIELDS));
                    if(!this.data.config.tiers) this.data.config.tiers = [];
                    if(!this.data.config.studentTiers) this.data.config.studentTiers = [];
                    if(!this.data.config.customFieldsDefs) this.data.config.customFieldsDefs = {};
                    if(!this.data.config.groupDiscounts) this.data.config.groupDiscounts = {};
                    if(!this.data.config.bonusTiers) this.data.config.bonusTiers = [];
                    if(!this.data.config.vouchers) this.data.config.vouchers = [];
                    
                    // Render settings if active
                    if(Router.current === 'settings') {
                         Settings.renderFieldsEditor();
                         Settings.renderVouchers();
                    }
                    System.toggleAI(this.data.config.enableAI);
                });
            }
        };

        // --- 3. INACTIVITY TIMER ---
        const InactivityTimer = {
            timer: null,
            warningTimer: null,
            LIMIT: 30 * 60 * 1000, 
            WARNING: 60,
            
            init() {
                ['mousemove', 'keydown', 'click', 'scroll'].forEach(ev => document.addEventListener(ev, () => this.reset()));
                this.reset();
            },
            
            reset() {
                if(!Store.user) return;
                clearTimeout(this.timer);
                clearInterval(this.warningTimer);
                document.getElementById('timeout-modal').classList.add('hidden-screen');
                this.timer = setTimeout(() => this.showWarning(), this.LIMIT);
            },
            
            showWarning() {
                const modal = document.getElementById('timeout-modal');
                const countEl = document.getElementById('timeout-countdown');
                modal.classList.remove('hidden-screen');
                
                let left = this.WARNING;
                countEl.innerText = left;
                
                this.warningTimer = setInterval(() => {
                    left--;
                    countEl.innerText = left;
                    if(left <= 0) {
                        clearInterval(this.warningTimer);
                        Auth.logout();
                    }
                }, 1000);
            },
            
            stayLoggedIn() { this.reset(); }
        };

        // --- 4. AUTH ---
        const Auth = {
            login(e) {
                e.preventDefault();
                const em = document.getElementById('email').value;
                const pw = document.getElementById('password').value;

                auth.signInWithEmailAndPassword(em, pw).catch(err => {
                    const msg = document.getElementById('login-msg');
                    msg.innerText = "שגיאה: פרטים שגויים";
                    msg.classList.remove('hidden');
                });
            },
            logout() { 
                ListenerManager.clearAll();
                localStorage.removeItem('currentView');
                auth.signOut(); 
                location.reload(); 
            },
            onStateChange(u) {
                document.getElementById('loader').classList.add('hidden-screen');
                if(u) {
                    Store.user = u;
                    document.getElementById('user-email-display').innerText = u.email;
                    document.getElementById('login-screen').classList.add('hidden-screen');
                    document.getElementById('sidebar').classList.remove('hidden-screen');
                    document.getElementById('main-content').classList.remove('hidden-screen');
                    
                    db.ref(`users/${u.uid}`).once('value', s => {
                        const val = s.val() || {};
                        Store.role = val.role || 'user';
                        document.body.className = `role-${Store.role}`;
                        Store.init();
                        System.initUI();
                        
                        const savedView = localStorage.getItem('currentView');
                        Router.go(savedView || 'dashboard');
                        InactivityTimer.init();
                    });
                } else {
                    document.getElementById('login-screen').classList.remove('hidden-screen');
                    document.getElementById('sidebar').classList.add('hidden-screen');
                    document.getElementById('main-content').classList.add('hidden-screen');
                    clearTimeout(InactivityTimer.timer);
                }
            }
        };
        auth.onAuthStateChanged(Auth.onStateChange);

        // --- 5. ROUTER & UI ---
        const Router = {
            current: null,
            go(view) {
                if (view === 'finance' && Store.role === 'user') return Notify.show('אין לך הרשאה לצפות בנתונים כספיים', 'error');
                if (view === 'settings' && Store.role === 'user') return Notify.show('אין לך הרשאה להגדרות', 'error');
                if (view === 'reports' && Store.role === 'user') return Notify.show('אין לך הרשאה לדוחות', 'error');

                this.current = view;
                localStorage.setItem('currentView', view);
                
                document.querySelectorAll('.view-section').forEach(el => { el.classList.add('hidden'); el.classList.remove('fade-in'); });
                const el = document.getElementById('view-' + view);
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('fade-in'), 10);
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const navBtn = document.getElementById('nav-' + view);
                if(navBtn) navBtn.classList.add('active');
                
                const titles = {dashboard:'לוח מחוונים', students:'ניהול בחורים', donors:'ניהול תורמים', groups:'קבוצות ומסלולים', finance:'ניהול קופה', reports:'דוחות', settings:'הגדרות'};
                document.getElementById('page-title').innerText = titles[view] || view;

                if(view === 'students') Students.render();
                if(view === 'donors') Donors.render();
                if(view === 'finance') Finance.loadMore(true);
                if(view === 'dashboard') Dashboard.render();
                if(view === 'settings') Settings.init();
            }
        };

        const UI = {
            updateIfVisible(module) {
                if(Router.current === module) {
                    if(module === 'students') Students.render();
                    if(module === 'donors') Donors.render();
                    if(module === 'groups') Groups.render();
                    if(module === 'finance') Finance.render();
                }
                if(module === 'finance' && Router.current === 'dashboard') Dashboard.render();
            }
        };

        const System = {
            searchTimeout: null,
            initUI() {
                const sel = document.getElementById('year-selector');
                sel.innerHTML = '';
                
                const d = new Date();
                const currG = d.getFullYear();
                const currH = d.getMonth() > 8 ? currG + 3761 : currG + 3760; 
                const yearsList = [];
                for(let i = -7; i <= 2; i++) {
                    const hYear = currH + i;
                    const map = {5780:'תש״פ', 5781:'תשפ״א', 5782:'תשפ״ב', 5783:'תשפ״ג', 5784:'תשפ״ד', 5785:'תשפ״ה', 5786:'תשפ״ו', 5787:'תשפ״ז', 5788:'תשפ״ח'};
                    yearsList.push(map[hYear] || hYear.toString());
                }

                yearsList.forEach(y => {
                    const op = document.createElement('option');
                    op.value = y; op.innerText = y;
                    if(y === Store.currentYear) op.selected = true;
                    sel.appendChild(op);
                });
                document.querySelectorAll('.curr-year').forEach(s => s.innerText = Store.currentYear);
            },
            changeYear(y) {
                const currentView = Router.current;
                ListenerManager.clearAll();
                Store.currentYear = y;
                Store.data.yearData = {};
                Store.data.stats = { income: 0, expense: 0 };
                Store.loadConfig();
                Store.loadStats();
                Store.loadGroups();
                Finance.reset();
                document.querySelectorAll('.curr-year').forEach(s => s.innerText = y);
                Router.go(currentView || 'dashboard'); 
            },
            addCustomYear() {
                const y = prompt("הכנס שנה חדשה (לדוגמה: תשצ״ט או 5800):");
                if (y) {
                    const sel = document.getElementById('year-selector');
                    const op = document.createElement('option');
                    op.value = y; op.innerText = y;
                    op.selected = true;
                    sel.appendChild(op);
                    this.changeYear(y);
                }
            },
            checkStudentProgress(studentId, addedAmount) {
                if(!studentId) return;
                db.ref(`years/${Store.currentYear}/finance`).orderByChild('studentId').equalTo(studentId).once('value', snap => {
                    let total = 0;
                    if(snap.val()) {
                        Object.values(snap.val()).forEach(tx => {
                            if(tx.type === 'income') total += parseFloat(tx.amount || 0);
                        });
                    }
                    const tiers = (Store.data.config.studentTiers || []).sort((a,b) => b.amount - a.amount);
                    const reachedTier = tiers.find(t => total >= t.amount);
                    if(reachedTier) {
                        const previousTotal = total - addedAmount;
                        if(previousTotal < reachedTier.amount) {
                            this.showCelebration(Store.data.students[studentId]?.name || 'הבחור', total, reachedTier.reward);
                        }
                    }
                });
            },
            showCelebration(name, amount, reward) {
                const modal = document.getElementById('celebration-modal');
                document.getElementById('celebration-name').innerText = name;
                document.getElementById('celebration-amount').innerText = amount.toLocaleString();
                document.getElementById('celebration-reward').innerText = reward;
                modal.classList.remove('hidden-screen');
                const container = document.getElementById('confetti-container');
                container.innerHTML = '';
                const colors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6'];
                for(let i=0; i<100; i++) {
                    const c = document.createElement('div');
                    c.style.cssText = `
                        position: absolute;
                        width: ${Math.random()*10+5}px;
                        height: ${Math.random()*10+5}px;
                        background: ${colors[Math.floor(Math.random()*colors.length)]};
                        left: ${Math.random()*100}%;
                        top: -20px;
                        animation: confetti-fall ${Math.random()*2+2}s linear forwards;
                    `;
                    container.appendChild(c);
                }
            },
            // [8] תיקון שגיאות בקונסול: בדיקת undefined ותיקון לוגיקת החיפוש
            searchFirebase(term, type) {
                clearTimeout(this.searchTimeout);
                // רענון כללי אם אין פרמטרים
                if(!term && !type) {
                     location.reload();
                     return;
                }

                if(!term || term.length < 2) {
                     if(type === 'students') Students.render();
                     if(type === 'donors') Donors.render();
                     return;
                }
                
                this.searchTimeout = setTimeout(() => {
                    // תיקון: חיפוש אמיתי מול Firebase כדי לחסוך קריאות ולקבל תוצאות רלוונטיות
                    const path = type === 'students' ? 'global/students' : 'global/donors';
                    const ref = db.ref(path);
                    
                    // שאילתה שמחפשת לפי שם
                    ref.orderByChild('name')
                       .startAt(term)
                       .endAt(term + "\uf8ff")
                       .once('value')
                       .then(snapshot => {
                            const results = snapshot.val();
                            if(results) {
                                // עדכון המטמון בתוצאות החיפוש
                                const targetStore = type === 'students' ? Store.data.students : Store.data.donors;
                                Object.assign(targetStore, results);
                                OfflineManager.saveState(type, targetStore);
                                
                                // רינדור מחדש עם הסינון
                                if(type === 'students') Students.render(term);
                                else Donors.render(term);
                            } else {
                                Notify.show('לא נמצאו תוצאות', 'info');
                                if(type === 'students') Students.render(term);
                                else Donors.render(term);
                            }
                       }).catch(err => console.error("Search error", err));

                }, 800); 
            },
            
            // תיקון מס' 6: רענון פנימי למודול בלבד
            refreshModule() {
                const current = Router.current;
                if (current === 'students' || current === 'donors') {
                    Notify.show('מרענן ' + (current==='students'?'בחורים':'תורמים') + '...', 'info');
                    // מחיקת נתונים מקומיים של אותו מודול בלבד
                    Store.data[current] = {};
                    Store.cursors[current] = null;
                    Store.loadedAll[current] = false;
                    OfflineManager.saveState(current, {});
                    
                    if (current === 'students') Students.loadMore(true);
                    else Donors.loadMore(true);
                } else {
                    location.reload();
                }
            },
            
            // תיקון מס' 7: מחיקת מטמון
            clearLocalCache() {
                if(confirm('פעולה זו תמחק את כל הנתונים השמורים בדפדפן ותבצע רענון מלא. להמשיך?')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            // תיקון מס' 9: AI Toggle
            toggleAI(enabled) {
                if (Store.role === 'admin' && enabled) {
                    document.getElementById('ai-bubble-container').classList.remove('hidden-screen');
                    document.getElementById('conf-enable-ai').checked = true;
                } else {
                    document.getElementById('ai-bubble-container').classList.add('hidden-screen');
                    document.getElementById('conf-enable-ai').checked = false;
                }
            },

            // תיקון מס' 5: המרת תאריך לעברי
            toHebrewDate(dateInput) {
                try {
                    const date = new Date(dateInput);
                    if (isNaN(date.getTime())) return dateInput;
                    return date.toLocaleDateString('he-IL', { calendar: 'hebrew', day: 'numeric', month: 'long', year: 'numeric' });
                } catch (e) {
                    return dateInput;
                }
            }
        };

        // --- NEW: Offline AI Assistant Logic ---
        const OfflineAI = {
            context: null, // "report_type", "search_student"
            
            addMsg(text, isUser = false) {
                const div = document.createElement('div');
                div.className = `p-2 rounded mb-2 text-xs ${isUser ? 'bg-indigo-100 self-end text-left' : 'bg-gray-100 self-start'}`;
                div.innerHTML = text;
                const container = document.getElementById('ai-messages');
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },
            
            send() {
                const inp = document.getElementById('ai-input');
                const txt = inp.value.trim();
                if(!txt) return;
                this.addMsg(txt, true);
                inp.value = '';
                
                setTimeout(() => {
                    const response = this.processQuery(txt);
                    this.addMsg(response);
                }, 600);
            },
            
            // [9] חיפוש משופר עם תמיכה בחלקי שמות והצעות
            processQuery(txt) {
                txt = txt.toLowerCase();

                // Help Command
                if (txt.includes('עזרה') || txt.includes('help') || txt.includes('פקודות')) {
                    return `
                        <b>פקודות אפשריות:</b><br>
                        - "דוח כספי" (להורדת דוח אקסל)<br>
                        - "דוח תצוגה" (לפתיחת עורך הדוחות)<br>
                        - "נתונים על [שם הבחור]" (למידע ופעולות על בחור)<br>
                        - "כמה כסף בקופה" (לצפייה ביתרה)<br>
                        - "כמה בחורים יש" (לספירת בחורים)<br>
                    `;
                }

                // 1. טיפול בהקשר (Context) - שאלות המשך
                if (this.context === 'report_type') {
                    this.context = null;
                    if (txt.includes('כספ') || txt.includes('הכנס') || txt.includes('קופה')) {
                        Reports.generateStandard();
                        return "בבקשה, הפקתי עבורך דוח תנועות כספיות באקסל.";
                    }
                    if (txt.includes('תצוג') || txt.includes('משוקלל') || txt.includes('פורים')) {
                         Reports.openEditor();
                         return "פתחתי את עורך הדוחות המשוקלל (תצוגה).";
                    }
                    if (txt.includes('תורם')) return "עבור דוח תורמים, תוכל לייצא מהמסך 'תורמים' באקסל.";
                }

                // 2. זיהוי בקשות דוח כלליות - יצירת דיאלוג
                if (txt.includes('דוח') && !txt.includes('בחור') && !txt.includes('תורם') && !txt.includes('כספ')) {
                    this.context = 'report_type';
                    return "איזה דוח תרצה להפיק? (כספי, תצוגה/פורים, או תורמים?)";
                }

                // 3. זיהוי חיפוש ומידע על בחור ספציפי - שיפור החיפוש
                if (txt.includes('על') || txt.includes('בחור') || txt.includes('נתונים')) {
                    const cleanName = txt.replace('נתונים על', '').replace('בחור', '').trim();
                    if(!cleanName) return "איזה בחור לחפש? נסה: 'נתונים על יוסי כהן'";

                    const students = Object.values(Store.data.students).filter(s => s);
                    
                    // חיפוש מדויק
                    let found = students.find(s => {
                        const fullName = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                        return fullName && fullName.includes(cleanName);
                    });

                    // חיפוש חלקי / שם אמצעי אם לא נמצא
                    if(!found) {
                        const parts = cleanName.split(' ');
                        found = students.find(s => {
                            const fullName = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                            if(!fullName) return false;
                            // בדיקה אם כל חלקי החיפוש קיימים בשם המלא
                            return parts.every(part => fullName.includes(part));
                        });
                    }

                    if (found) {
                        const fullName = found.firstName && found.lastName ? `${found.firstName} ${found.lastName}` : found.name;
                        return `מצאתי את הבחור <b>${fullName}</b>.<br>
                                <button onclick="Reports.generateIndividual('${found.id}', '${fullName}')" class="text-blue-600 underline">לחץ כאן להפקת דוח אישי</button><br>
                                <button onclick="Students.openEdit('${found.id}')" class="text-blue-600 underline">לחץ לעריכת פרטים</button>`;
                    } else {
                        // הצעות קרובות (Fuzzy match simple)
                        const suggestions = students.filter(s => {
                             const fullName = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                             return fullName && fullName.includes(cleanName.split(' ')[0]);
                        }).slice(0,3);
                        
                        if(suggestions.length > 0) {
                            let msg = `לא מצאתי "${cleanName}". האם התכוונת ל:<br>`;
                            suggestions.forEach(s => {
                                 const n = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                                 msg += `- ${n}<br>`;
                            });
                            return msg;
                        }
                        return "לא זיהיתי את שם הבחור. נסה שם מדויק יותר.";
                    }
                }

                // 4. פקודות ישירות
                if(txt.includes('דוח') && (txt.includes('הכנס') || txt.includes('כספ'))) {
                    Reports.generateStandard();
                    return "מפיק דוח כספי, אנא המתן...";
                }
                
                // 5. שאלות כלליות
                if(txt.includes('כמה') && (txt.includes('כסף') || txt.includes('קופה') || txt.includes('הכנסות'))) {
                    const inc = Store.data.stats.income || 0;
                    return `סך ההכנסות בקופה לשנה זו: ₪${inc.toLocaleString()}`;
                }
                if(txt.includes('כמה') && (txt.includes('בחורים') || txt.includes('תלמידים'))) {
                    const count = Object.keys(Store.data.students).length;
                    return `ישנם כרגע ${count} בחורים במערכת (חלקם בזיכרון המקומי).`;
                }
                if(txt.includes('כמה') && txt.includes('תורמים')) {
                    const count = Object.keys(Store.data.donors).length;
                    return `ישנם כרגע ${count} תורמים במערכת.`;
                }

                if(txt.includes('שלום') || txt.includes('היי')) return "שלום רב! אני כאן לעזור. נסה לשאול 'כמה כסף בקופה' או לבקש דוח על בחור מסוים.";
                
                return "מצטער, לא הבנתי בדיוק. נסה לשאול על 'דוח', 'מצב קופה', או חפש שם של בחור. הקש 'עזרה' לרשימת פקודות.";
            }
        };

        // --- 6. STUDENTS LOGIC ---
        const Students = {
            limit: 30,
            loadMore(reset = false) {
                if (reset) {
                    Store.cursors.students = null;
                    Store.loadedAll.students = false;
                }
                document.getElementById('students-loader-more').style.display = 'block';
                document.getElementById('students-loader-more').innerText = 'טוען נתונים...';

                let query = db.ref('global/students').orderByKey().limitToLast(this.limit);
                if (Store.cursors.students) query = query.endBefore(Store.cursors.students);

                query.once('value', snap => {
                    const data = snap.val();
                    if (!data) {
                        Store.loadedAll.students = true;
                        document.getElementById('students-loader-more').style.display = 'none';
                        return;
                    }
                    const keys = Object.keys(data).sort();
                    Store.cursors.students = keys[0];
                    Object.assign(Store.data.students, data);
                    OfflineManager.saveState('students', Store.data.students);
                    this.render();
                    if (keys.length < this.limit) {
                        Store.loadedAll.students = true;
                        document.getElementById('students-loader-more').style.display = 'none';
                    } else {
                        document.getElementById('students-loader-more').innerHTML = `
                            <button onclick="Students.loadMore()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-6 py-2 rounded-full text-sm font-bold transition shadow-sm">
                                <i class="fas fa-chevron-down ml-2"></i> טען עוד בחורים
                            </button>`;
                    }
                });
            },
            syncNewest() {
                db.ref('global/students').orderByKey().limitToLast(10).once('value', snap => {
                    const data = snap.val();
                    if(data) {
                        Object.assign(Store.data.students, data);
                        OfflineManager.saveState('students', Store.data.students);
                        if(Router.current === 'students') this.render();
                    }
                });
            },
            render(searchTerm = null) {
                const term = searchTerm || document.getElementById('student-search').value.trim();
                const tbody = document.getElementById('students-tbody');
                tbody.innerHTML = '';
                // תיקון מס' 1: הצגת בחורים בארכיון אך בנפרד + הגנה מקריסה
                let list = Object.values(Store.data.students).filter(s => s).map(s => {
                    const fullName = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : (s.name || 'ללא שם');
                    return { ...s, displayName: fullName };
                });
                
                list.sort((a,b) => (a.displayName||'').localeCompare(b.displayName||''));
                const baseGoal = Store.data.config.baseStudentGoal || 0;
                list = list.map(s => {
                    const yData = (Store.data.yearData[Store.currentYear]?.students || {})[s.id] || {};
                    return { ...s, ...yData, effectiveGoal: yData.personalGoal || baseGoal }; 
                });
                
                if(term) {
                    // [8] תיקון undefined: שימוש ב-(s.displayName || '') כדי למנוע קריסה
                    list = list.filter(s => (s.displayName || '').includes(term) || (s.phone || '').includes(term) || (s.grade && s.grade.includes(term)));
                }
                
                const displayList = list.slice(0, 100); 
                
                if (displayList.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-400">לא נמצאו בחורים</td></tr>';
                     return;
                }

                displayList.forEach(s => {
                    const row = document.createElement('tr');
                    // עיצוב מותאם לארכיון
                    if(s.isArchived) {
                        row.className = "hover:bg-gray-200 border-b border-gray-100 transition cursor-pointer group archived-student";
                    } else {
                        row.className = "hover:bg-slate-50 border-b border-slate-50 transition cursor-pointer group";
                    }
                    row.onclick = (e) => { if(!e.target.closest('button')) this.openEdit(s.id); };
                    
                    const archiveIcon = s.isArchived ? 'fa-box-open' : 'fa-archive';
                    const archiveTitle = s.isArchived ? 'שחזר מהיסטוריה' : 'העבר להיסטוריה';
                    
                    row.innerHTML = `
                        <td class="p-3 text-right font-medium text-slate-700 group-hover:text-indigo-600 transition">${s.displayName} ${s.isArchived?'(ארכיון)':''}</td>
                        <td class="p-3 text-right text-gray-500">${s.grade || '-'}</td>
                        <td class="p-3 text-right text-gray-400">${s.entryYear || '-'}</td>
                        <td class="p-3 text-right font-bold text-slate-800">₪${parseInt(s.effectiveGoal).toLocaleString()}</td>
                        <td class="p-3 text-center flex items-center justify-center gap-2">
                             <button onclick="Reports.generateIndividual('${s.id}', '${s.displayName}')" class="text-green-500 hover:text-green-700 transition p-2 hover:bg-green-50 rounded-full" title="הפק דוח אקסל"><i class="fas fa-file-excel"></i></button>
                             <button onclick="Reports.printStudentSlip('${s.id}', '${s.displayName}')" class="text-red-500 hover:text-red-700 transition p-2 hover:bg-red-50 rounded-full" title="הדפס דף בחור"><i class="fas fa-print"></i></button>
                            <button onclick="Students.openEdit('${s.id}')" class="text-indigo-400 hover:text-indigo-600 transition p-2 hover:bg-indigo-50 rounded-full"><i class="fas fa-pen"></i></button>
                            <button onclick="Students.toggleArchive('${s.id}', ${!s.isArchived})" class="text-gray-400 hover:text-gray-600 transition p-2 hover:bg-gray-100 rounded-full" title="${archiveTitle}"><i class="fas ${archiveIcon}"></i></button>
                            <button onclick="Students.delete('${s.id}')" class="text-red-300 hover:text-red-600 transition p-2 hover:bg-red-50 rounded-full admin-only"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                if(term || Store.loadedAll.students) {
                     document.getElementById('students-loader-more').style.display = 'none';
                } else if(!Store.loadedAll.students && list.length < 500) {
                     document.getElementById('students-loader-more').style.display = 'block';
                }
            },
            handleSearch(term) { this.render(term); },
            getFormFields() {
                const activeKeys = Store.data.config.fields.students || DEFAULT_ACTIVE_FIELDS.students;
                const fields = [];
                activeKeys.forEach(k => {
                    let def = PREDEFINED_FIELDS.students.find(p => p.k === k);
                    if (!def && Store.data.config.customFieldsDefs && Store.data.config.customFieldsDefs[k]) {
                        def = { k: k, l: Store.data.config.customFieldsDefs[k].l, t: 'text' };
                    }
                    if(def) fields.push({id:k, l:def.l, t:def.t, opts:def.opts, r:def.r});
                });
                return fields;
            },
            openAddModal() {
                Modal.render('הוספת בחור חדש', this.getFormFields(), (data) => {
                    // [2] בדיקה: חובה שם פרטי ומשפחה
                    if (!data.firstName || !data.lastName) {
                        return Notify.show('שגיאה: חובה להזין שם פרטי ושם משפחה', 'error');
                    }
                    
                    // ID Generation fallback
                    const id = db.ref('global/students').push().key || ('stu' + Date.now());
                    if(data.firstName && data.lastName) data.name = `${data.firstName} ${data.lastName}`;
                    const studentData = { id, lastUpdatedYear: Store.currentYear, ...data };
                    OfflineManager.write(`global/students/${id}`, studentData);
                    Notify.show('בחור נוסף בהצלחה', 'success');
                });
            },
            openQuickAdd() {
                const html = `
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1">הדבק רשימת שמות (כל בחור בשורה נפרדת)</label>
                        <p class="text-xs text-gray-500 mb-2">פורמט: שם פרטי שם משפחה</p>
                        <textarea id="quick-add-list" class="w-full border p-2 rounded h-40 text-sm" placeholder="משה כהן\nדוד לוי\n..."></textarea>
                    </div>
                `;
                Modal.renderRaw('הוספה מהירה', html, () => {
                    const txt = document.getElementById('quick-add-list').value;
                    const lines = txt.split('\n').map(l => l.trim()).filter(l => l);
                    if(lines.length === 0) return;
                    const batch = {};
                    lines.forEach(line => {
                        const id = db.ref('global/students').push().key || ('stu' + Math.random().toString(36).substr(2, 9));
                        const parts = line.split(' ');
                        const firstName = parts[0];
                        const lastName = parts.slice(1).join(' ');
                        batch[id] = { 
                            id, 
                            name: line,
                            firstName: firstName,
                            lastName: lastName,
                            lastUpdatedYear: Store.currentYear, 
                            grade: 'שיעור א' 
                        };
                    });
                    db.ref('global/students').update(batch);
                    Object.assign(Store.data.students, batch);
                    OfflineManager.saveState('students', Store.data.students);
                    Students.render();
                    Notify.show(`${lines.length} בחורים נוספו בהצלחה`, 'success');
                    Modal.close();
                });
            },
            openEdit(id) {
                const s = Store.data.students[id];
                if(!s) return Notify.show('שגיאה בטעינת הבחור', 'error');
                const yData = (Store.data.yearData[Store.currentYear]?.students || {})[id] || {};
                const currentGoal = yData.personalGoal; 
                const baseGoal = Store.data.config.baseStudentGoal || 0;
                const fields = this.getFormFields().map(f => ({ ...f, v: s[f.id] || '' }));
                const tiers = (Store.data.config.studentTiers || []).sort((a,b) => a.amount - b.amount);
                let goalOptions = `<option value="">יעד מערכת בסיסי (${baseGoal})</option>`;
                tiers.forEach(t => {
                     goalOptions += `<option value="${t.amount}" ${currentGoal == t.amount ? 'selected' : ''}>${t.amount} (${t.reward})</option>`;
                });
                const isCustom = currentGoal && currentGoal != baseGoal && !tiers.find(t => t.amount == currentGoal);
                const extraHtml = `
                    <div class="mb-4 bg-amber-50 p-3 rounded border border-amber-200">
                        <label class="block text-sm font-bold text-amber-900 mb-1">יעד אישי לשנת ${Store.currentYear}</label>
                        <select id="student-goal-select" class="w-full border border-amber-300 p-2 rounded mb-2 bg-white" onchange="document.getElementById('custom-goal-wrap').style.display = this.value === 'custom' ? 'block' : 'none'">
                            ${goalOptions}
                            <option value="custom" ${isCustom ? 'selected' : ''}>יעד מותאם אישית...</option>
                        </select>
                        <div id="custom-goal-wrap" style="display: ${isCustom ? 'block' : 'none'}">
                            <input type="number" id="student-custom-goal" value="${currentGoal || ''}" placeholder="הכנס סכום יעד..." class="w-full border border-amber-300 p-2 rounded">
                        </div>
                    </div>
                `;
                Modal.render('עריכת פרטי בחור', fields, (data) => {
                    const updates = {};
                    Object.keys(data).forEach(k => { updates[k] = data[k]; });
                    if(data.firstName || data.lastName) updates.name = `${data.firstName || ''} ${data.lastName || ''}`.trim();
                    OfflineManager.write(`global/students/${id}`, updates, 'update');
                    const selectVal = document.getElementById('student-goal-select').value;
                    let finalGoal = null;
                    if(selectVal === 'custom') {
                        const customVal = document.getElementById('student-custom-goal').value;
                        if(customVal) finalGoal = parseInt(customVal);
                    } else if(selectVal !== "") {
                        finalGoal = parseInt(selectVal);
                    }
                    if(finalGoal !== null) {
                        OfflineManager.write(`years/${Store.currentYear}/studentData/${id}/personalGoal`, finalGoal);
                    } else {
                        OfflineManager.write(`years/${Store.currentYear}/studentData/${id}/personalGoal`, null, 'remove');
                    }
                    Notify.show('פרטים עודכנו', 'success');
                }, extraHtml);
            },
            toggleArchive(id, shouldArchive) {
                // תיקון מס' 1: פונקציה להעברה/החזרה מארכיון
                if(shouldArchive && !confirm('האם להעביר בחור זה לארכיון/היסטוריה? הנתונים יישמרו אך הוא לא יופיע בשיבוצים.')) return;
                
                OfflineManager.write(`global/students/${id}/isArchived`, shouldArchive ? true : null); // null מוחק את ה-flag
                // עדכון מטמון ידני
                if (Store.data.students[id]) {
                    Store.data.students[id].isArchived = shouldArchive ? true : false;
                }
                this.render();
                Notify.show(shouldArchive ? 'הבחור הועבר לארכיון' : 'הבחור שוחזר מהארכיון', 'info');
            },
            delete(id) {
                if(confirm('האם אתה בטוח שברצונך למחוק בחור זה לגמרי? פעולה זו תסיר אותו מהקבוצות בשנה הנוכחית.')) {
                    OfflineManager.write(`global/students/${id}`, null, 'remove');
                    // מחיקה מהירה מהמטמון כדי שהממשק יתעדכן מיד
                    delete Store.data.students[id];
                    
                    const groups = Store.data.yearData[Store.currentYear]?.groups || {};
                    Object.keys(groups).forEach(day => {
                        Object.keys(groups[day]).forEach(gid => {
                            const members = groups[day][gid].members || [];
                            const newMembers = members.filter(m => m.id !== id);
                            if(members.length !== newMembers.length) {
                                OfflineManager.write(`years/${Store.currentYear}/groups/${day}/${gid}/members`, newMembers);
                            }
                        });
                    });
                    
                    this.render();
                    Notify.show('הבחור נמחק והוסר מהקבוצות', 'info');
                }
            }
        };

        // --- 7. DONORS LOGIC ---
        const Donors = {
            limit: 40,
            viewMode: 'list', 
            viewTab: 'all',
            kanbanDay: 'night14', 
            loadMore(reset = false) {
                if(reset) { Store.cursors.donors = null; Store.loadedAll.donors = false; }
                document.getElementById('donors-loader-more').style.display = 'block';
                document.getElementById('donors-loader-more').querySelector('button').innerText = 'טוען...';
                let query = db.ref('global/donors').orderByKey().limitToLast(this.limit);
                if(Store.cursors.donors) query = query.endBefore(Store.cursors.donors);
                query.once('value', snap => {
                    const data = snap.val();
                    if(!data) {
                        Store.loadedAll.donors = true;
                        document.getElementById('donors-loader-more').style.display = 'none';
                        return;
                    }
                    const keys = Object.keys(data).sort();
                    Store.cursors.donors = keys[0];
                    Object.assign(Store.data.donors, data);
                    OfflineManager.saveState('donors', Store.data.donors);
                    this.render();
                    if (keys.length < this.limit) {
                        Store.loadedAll.donors = true;
                        document.getElementById('donors-loader-more').style.display = 'none';
                    } else {
                        document.getElementById('donors-loader-more').innerHTML = `
                            <button onclick="Donors.loadMore()" class="bg-slate-200 text-slate-600 px-6 py-2 rounded-full font-bold text-sm">טען עוד...</button>
                        `;
                    }
                });
            },
            syncNewest() {
                db.ref('global/donors').orderByKey().limitToLast(10).once('value', snap => {
                    const data = snap.val();
                    if(data) {
                        Object.assign(Store.data.donors, data);
                        OfflineManager.saveState('donors', Store.data.donors);
                        if(Router.current === 'donors') this.render();
                    }
                });
            },
            render(searchTerm = null) {
                if(this.viewMode === 'list') {
                    document.getElementById('donors-list-view').style.display = 'block';
                    document.getElementById('donors-quick-manager').style.display = 'none';
                    document.getElementById('donors-quick-manager').classList.add('hidden');
                    this.renderList(searchTerm); // שינוי לטבלה/רשימה
                } else {
                    document.getElementById('donors-list-view').style.display = 'none';
                    document.getElementById('donors-quick-manager').style.display = 'flex';
                    document.getElementById('donors-quick-manager').classList.remove('hidden');
                    this.renderManager();
                }
            },
            toggleQuickManager() {
                this.viewMode = this.viewMode === 'list' ? 'manager' : 'list';
                this.render();
            },
            setViewTab(tab) {
                this.viewTab = tab;
                document.querySelectorAll('.donor-view-tab').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
                
                // תיקון מס' 2: עדכון אפשרויות הסינון המשני
                const subFilter = document.getElementById('donors-groups-filter');
                const subSelect = document.getElementById('donor-group-select');
                subSelect.innerHTML = '<option value="">הכל</option>';
                
                if (tab !== 'all' && tab !== 'unassigned') {
                    subFilter.classList.remove('hidden');
                    subFilter.classList.add('flex');
                    const groupsInDay = Store.data.yearData[Store.currentYear]?.groups[tab] || {};
                    Object.entries(groupsInDay).forEach(([gid, g]) => {
                        subSelect.innerHTML += `<option value="${gid}">${g.name}</option>`;
                    });
                } else {
                    subFilter.classList.add('hidden');
                    subFilter.classList.remove('flex');
                }
                
                this.renderList();
            },
            // שינוי מקוביות (Grid) לשורות (List/Table)
            renderList(searchTerm) {
                const term = searchTerm || document.getElementById('donor-search-input').value.trim();
                const tbody = document.getElementById('donors-tbody');
                const selectedGroupId = document.getElementById('donor-group-select').value;
                
                tbody.innerHTML = '';
                
                // הגנה על sort מפני null (תיקון)
                let list = Object.values(Store.data.donors).filter(d => d).sort((a,b) => (a.name||'').localeCompare(b.name||''));
                
                // סינון לפי טאב
                if(this.viewTab === 'unassigned') {
                    const assignedDonors = new Set(Object.keys(Store.data.donorGroupMap));
                    list = list.filter(d => !assignedDonors.has(d.id));
                } else if (this.viewTab !== 'all') {
                    // סינון לפי יום ספציפי
                    const groupsInDay = Store.data.yearData[Store.currentYear]?.groups[this.viewTab] || {};
                    
                    // תיקון מס' 2: סינון משני (בתוך קבוצה ספציפית ביום)
                    if (selectedGroupId) {
                        const g = groupsInDay[selectedGroupId];
                        const donorsInGroup = new Set(g.route || []);
                        list = list.filter(d => donorsInGroup.has(d.id));
                    } else {
                        // כל הקבוצות באותו יום
                        const donorsInDay = new Set();
                        Object.values(groupsInDay).forEach(g => (g.route || []).forEach(id => donorsInDay.add(id)));
                        list = list.filter(d => donorsInDay.has(d.id));
                    }
                }

                if(term) {
                    // [8] תיקון undefined: הוספת הגנה לחיפוש
                    list = list.filter(d => (d.name || '').includes(term) || (d.address||'').includes(term) || (d.city||'').includes(term));
                }
                
                const displayList = list.slice(0, 50);
                
                if(displayList.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-400">לא נמצאו תורמים</td></tr>';
                }

                displayList.forEach(d => {
                    const groupName = Store.data.donorGroupMap[d.id];
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 border-b border-slate-50 transition cursor-pointer group";
                    tr.innerHTML = `
                        <td class="p-3 text-right font-medium text-slate-800">
                             ${d.name} ${d.vip ? '<span class="mr-2 text-[10px] bg-purple-50 text-purple-700 px-1.5 py-0.5 rounded border border-purple-100">VIP</span>' : ''}
                        </td>
                        <td class="p-3 text-right text-gray-500 text-sm">
                             ${d.city || ''} ${d.street || d.address || ''} ${d.floor ? '(קומה '+d.floor+')' : ''}
                        </td>
                        <td class="p-3 text-right text-gray-500 text-sm">${d.phone || ''}</td>
                        <td class="p-3 text-right text-sm">
                            ${groupName ? `<span class="bg-amber-50 text-amber-700 px-2 py-0.5 rounded font-bold border border-amber-100">${groupName}</span>` : '-'}
                        </td>
                        <td class="p-3 text-center flex items-center justify-center gap-2">
                            <button onclick="Donors.openEdit('${d.id}')" class="text-indigo-400 hover:text-indigo-600 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-full transition"><i class="fas fa-pen"></i></button>
                            <button onclick="Donors.delete('${d.id}')" class="text-red-300 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition" title="מחק תורם"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            setKanbanDay(day) {
                this.kanbanDay = day;
                document.querySelectorAll('.kanban-tab').forEach(b => b.classList.toggle('active', b.dataset.day === day));
                this.renderManager();
            },
            renderManager() {
                const poolEl = document.getElementById('donor-pool-list');
                poolEl.innerHTML = '';
                
                const currentDayGroups = [];
                const groupsData = Store.data.yearData[Store.currentYear]?.groups || {};
                if (groupsData[this.kanbanDay]) {
                     Object.entries(groupsData[this.kanbanDay]).forEach(([gid, g]) => {
                        currentDayGroups.push({id: gid, day: this.kanbanDay, ...g});
                    });
                }
                
                // Unassigned logic based on current mapping
                const assignedDonors = new Set(Object.keys(Store.data.donorGroupMap));
                // תיקון: הגנה מקריסה
                const unassigned = Object.values(Store.data.donors).filter(d => d && !assignedDonors.has(d.id));
                
                document.getElementById('pool-count').innerText = unassigned.length;
                unassigned.sort((a,b) => a.name.localeCompare(b.name)).forEach(d => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-2 border rounded shadow-sm text-sm cursor-grab hover:bg-gray-50 flex justify-between flex-col";
                    el.dataset.id = d.id;
                    el.innerHTML = `
                        <div class="font-medium flex justify-between"><span>${d.name}</span> <i class="fas fa-grip-lines text-gray-300"></i></div>
                        <div class="text-xs text-gray-400 mt-1"><i class="fas fa-map-marker-alt"></i> ${d.city || ''} ${d.street || d.address || ''}</div>
                    `;
                    poolEl.appendChild(el);
                });
                new Sortable(poolEl, { group: { name: 'donors', pull: true, put: true }, sort: false, animation: 150 });
                
                const container = document.getElementById('groups-kanban-container');
                container.innerHTML = '';
                
                if (currentDayGroups.length === 0) {
                     container.innerHTML = `<div class="flex items-center justify-center w-full text-gray-400 text-sm">אין קבוצות מוגדרות לזמן זה</div>`;
                }

                currentDayGroups.forEach(g => {
                    const col = document.createElement('div');
                    col.className = "shrink-0 w-72 h-full bg-white rounded-lg shadow-sm border flex flex-col";
                    const displayDay = g.day.replace('night','ליל ').replace('day','יום ');
                    col.innerHTML = `
                        <div class="p-2 border-b bg-indigo-50 font-bold text-sm text-indigo-900 flex justify-between shrink-0 cursor-pointer hover:bg-indigo-100" onclick="Donors.showGroupDetails('${g.id}', '${g.day}')">
                            <span>${g.name}</span>
                            <span class="text-xs font-normal opacity-70">${displayDay}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50 kanban-group-list custom-scroll" data-gid="${g.id}" data-day="${g.day}"></div>
                    `;
                    const listEl = col.querySelector('.kanban-group-list');
                    (g.route || []).forEach(did => {
                        const d = Store.data.donors[did];
                        if(d) {
                            const item = document.createElement('div');
                            item.className = "bg-white p-2 border rounded shadow-sm text-sm cursor-grab flex flex-col justify-between group";
                            item.dataset.id = did;
                            // תיקון: הצגת כתובת גם בשיבוץ
                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <span class="truncate w-40 font-bold">${d.name}</span>
                                    <button onclick="Groups.removeFromRoute('${g.day}','${g.id}','${did}')" class="text-red-300 hover:text-red-500 hidden group-hover:block"><i class="fas fa-times"></i></button>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 truncate">${d.city||''} ${d.street||d.address||''}</div>
                            `;
                            listEl.appendChild(item);
                        }
                    });
                    container.appendChild(col);
                    new Sortable(listEl, {
                        group: 'donors',
                        animation: 150,
                        onAdd: (evt) => {
                            const newOrder = Array.from(listEl.children).map(c => c.dataset.id);
                            OfflineManager.write(`years/${Store.currentYear}/groups/${g.day}/${g.id}/route`, newOrder);
                            setTimeout(() => { Store.loadGroups(); }, 500);
                        },
                        onUpdate: (evt) => {
                             const newOrder = Array.from(listEl.children).map(c => c.dataset.id);
                             OfflineManager.write(`years/${Store.currentYear}/groups/${g.day}/${g.id}/route`, newOrder);
                        }
                    });
                });
            },
            showGroupDetails(gid, day) {
                const g = Store.data.yearData[Store.currentYear].groups[day][gid];
                if (!g) return;
                
                // Fetch history for these donors
                Reports.getAllHistory().then(historyData => {
                    const donors = (g.route || []).map(did => Store.data.donors[did]).filter(x => x);
                    
                    // [3] תיקון סדר השנים בהיסטוריה: כרונולוגי (שנה נוכחית אחרונה/ראשונה? הבקשה: תשפג, תשפד, תשפה)
                    // יצרנו רשימה ממוינת מהישן לחדש (3 שנים אחרונות)
                    const years = Object.keys(HEBREW_YEARS_MAPPING).sort().slice(-3);
                    
                    let html = `<div class="overflow-x-auto"><table class="w-full text-sm border-collapse">
                        <thead class="bg-gray-100"><tr>
                            <th class="p-2 border">שם</th>
                            <th class="p-2 border">כתובת</th>
                            <th class="p-2 border">הערות</th>
                            ${years.map(y => `<th class="p-2 border text-center">${y}</th>`).join('')}
                            <th class="p-2 border">פעולות</th>
                        </tr></thead><tbody>`;
                    
                    donors.forEach(d => {
                        let donationsHtml = '';
                        years.forEach(y => {
                            donationsHtml += `<td class="p-2 border text-center font-bold text-xs">...</td>`; 
                        });

                        html += `<tr>
                            <td class="p-2 border">${d.name}</td>
                            <td class="p-2 border">${d.city||''} ${d.street||''}</td>
                            <td class="p-2 border text-xs max-w-[150px] truncate">${d.notes||''}</td>
                            ${donationsHtml}
                            <td class="p-2 border text-center">
                                <button onclick="Groups.removeFromRoute('${day}','${gid}','${d.id}'); Modal.close();" class="text-red-500 hover:bg-red-50 p-1 rounded">הסר</button>
                            </td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                    
                    Modal.renderRaw(`פרטי קבוצה: ${g.name}`, html, () => Modal.close());
                    // Hide primary button (Save) as this is view/action only
                    document.querySelector('#modal-form .btn-primary').parentElement.style.display = 'none';
                });
            },
            filterPool(v) {
                const list = document.getElementById('donor-pool-list');
                Array.from(list.children).forEach(el => {
                    el.style.display = el.innerText.includes(v) ? 'flex' : 'none';
                });
            },
            getFormFields() {
                const activeKeys = Store.data.config.fields.donors || DEFAULT_ACTIVE_FIELDS.donors;
                const fields = [];
                activeKeys.forEach(k => {
                    let def = PREDEFINED_FIELDS.donors.find(p => p.k === k);
                    if (!def && Store.data.config.customFieldsDefs && Store.data.config.customFieldsDefs[k]) {
                        def = { k: k, l: Store.data.config.customFieldsDefs[k].l, t: 'text' };
                    }
                    if(def) fields.push({id:k, l:def.l, t:def.t, opts:def.opts, r:def.r});
                });
                return fields;
            },
            openAddModal() {
                const allGroups = [];
                const gData = Store.data.yearData[Store.currentYear]?.groups || {};
                Object.entries(gData).forEach(([d, dayG]) => Object.entries(dayG).forEach(([gid, g]) => allGroups.push({id: gid, day:d, name: g.name})));
                const groupSelectHtml = `
                    <div class="mb-3 p-3 bg-amber-50 rounded border border-amber-100">
                        <label class="block text-sm font-bold text-amber-800 mb-1">שיוך לקבוצה (אופציונלי)</label>
                        <select id="new-donor-group" class="w-full border p-2 rounded bg-white text-sm">
                            <option value="">-- ללא שיוך --</option>
                            ${allGroups.map(g => `<option value="${g.day}|${g.id}">${g.name} (${g.day})</option>`).join('')}
                        </select>
                    </div>
                `;
                Modal.render('הוספת תורם חדש', this.getFormFields(), (data) => {
                    // [2] בדיקת חובה: שם פרטי ומשפחה
                    if (!data.firstName || !data.lastName) {
                        return Notify.show('שגיאה: חובה להזין שם פרטי ושם משפחה', 'error');
                    }

                    const id = db.ref('global/donors').push().key || ('don' + Date.now());
                    // יצירת שדה name אחוד לתאימות
                    if(data.firstName || data.lastName) data.name = `${data.firstName || ''} ${data.lastName || ''}`.trim();
                    if(!data.name) data.name = 'ללא שם';
                    
                    OfflineManager.write(`global/donors/${id}`, { id, joinYear: Store.currentYear, ...data });
                    
                    const groupEl = document.getElementById('new-donor-group');
                    const groupVal = groupEl ? groupEl.value : null;
                    if(groupVal) {
                        const [day, gid] = groupVal.split('|');
                        const ref = db.ref(`years/${Store.currentYear}/groups/${day}/${gid}/route`);
                        ref.once('value', s => {
                            const list = s.val() || [];
                            list.push(id);
                            OfflineManager.write(`years/${Store.currentYear}/groups/${day}/${gid}/route`, list);
                        });
                    }
                    Notify.show('תורם נוסף בהצלחה', 'success');
                }, groupSelectHtml);
            },
            openEdit(id) {
                const d = Store.data.donors[id];
                if (!d) return Notify.show('תורם לא נמצא', 'error');
                const fields = this.getFormFields().map(f => ({ ...f, v: d[f.id] }));
                Modal.render('עריכת תורם', fields, (data) => {
                    if(data.firstName || data.lastName) data.name = `${data.firstName || ''} ${data.lastName || ''}`.trim();
                    OfflineManager.write(`global/donors/${id}`, data, 'update');
                    Notify.show('פרטי תורם עודכנו', 'success');
                });
            },
            delete(id) {
                if(confirm('אזהרה: האם אתה בטוח שברצונך למחוק תורם זה? הפעולה תסיר אותו מכל הקבוצות ומסד הנתונים.')) {
                    OfflineManager.write(`global/donors/${id}`, null, 'remove');
                    delete Store.data.donors[id]; // מחיקה מיידית מהמטמון
                    
                    // ניקוי מקבוצות
                    const groups = Store.data.yearData[Store.currentYear]?.groups || {};
                    Object.keys(groups).forEach(day => {
                        Object.keys(groups[day]).forEach(gid => {
                            const route = groups[day][gid].route || [];
                            const newRoute = route.filter(did => did !== id);
                            if(route.length !== newRoute.length) {
                                OfflineManager.write(`years/${Store.currentYear}/groups/${day}/${gid}/route`, newRoute);
                            }
                        });
                    });
                    
                    this.render();
                    Notify.show('התורם נמחק בהצלחה', 'info');
                }
            },
            handleSearch() { this.limit = 40; this.render(); }
        };

        // --- 8. GROUPS LOGIC ---
        const Groups = {
            currentDay: 'night14',
            activeGroupId: null,
            setDay(d) {
                this.currentDay = d;
                document.querySelectorAll('.group-tab').forEach(b => b.classList.toggle('active', b.dataset.day === d));
                this.activeGroupId = null;
                this.render();
            },
            render() {
                const listEl = document.getElementById('groups-list');
                listEl.innerHTML = '';
                const groups = (Store.data.yearData[Store.currentYear]?.groups || {})[this.currentDay] || {};
                Object.entries(groups).forEach(([gid, g]) => {
                    const isActive = gid === this.activeGroupId;
                    const el = document.createElement('div');
                    el.className = `p-4 border-b cursor-pointer transition flex justify-between items-center group ${isActive ? 'bg-indigo-50 border-r-4 border-r-indigo-600' : 'hover:bg-slate-50'}`;
                    el.onclick = () => this.selectGroup(gid, g);
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-700 text-sm group-hover:text-indigo-700">${g.name}</div>
                            <div class="text-xs text-gray-400 mt-1">${(g.members||[]).length} בחורים | ${(g.route||[]).length} תורמים</div>
                        </div>
                        <i class="fas fa-chevron-left text-xs text-gray-300 ${isActive?'text-indigo-500':''}"></i>
                    `;
                    listEl.appendChild(el);
                });
                const ph = document.getElementById('group-placeholder');
                const editor = document.getElementById('group-editor');
                if(this.activeGroupId && groups[this.activeGroupId]) {
                    ph.classList.add('hidden');
                    editor.classList.remove('hidden');
                    this.renderEditor(groups[this.activeGroupId]);
                } else {
                    ph.classList.remove('hidden');
                    editor.classList.add('hidden');
                }
            },
            selectGroup(gid, g) {
                this.activeGroupId = gid;
                document.getElementById('active-group-name').innerText = g.name;
                const dayText = document.querySelector(`.group-tab[data-day="${this.currentDay}"]`).innerText;
                document.getElementById('active-group-details').innerText = `${dayText} | ${(g.members||[]).length} בחורים`;
                this.render(); 
                this.renderEditor(g);
            },
            renderEditor(group) {
                const memList = document.getElementById('group-members-list');
                memList.innerHTML = '';
                (group.members || []).forEach((m, idx) => {
                    const s = Store.data.students[m.id];
                    if(!s) return;
                    const name = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                    const roleSelect = `
                        <select onchange="Groups.updateMemberRole(${idx}, this.value)" class="text-xs border rounded p-1 mr-2 bg-gray-50">
                            <option value="חבר" ${m.role === 'חבר' ? 'selected' : ''}>חבר</option>
                            <option value="ראש צוות" ${m.role === 'ראש צוות' ? 'selected' : ''}>ראש צוות</option>
                            <option value="סגן" ${m.role === 'סגן' ? 'selected' : ''}>סגן</option>
                        </select>
                    `;
                    memList.innerHTML += `
                        <div class="bg-white p-2 border rounded shadow-sm text-sm flex justify-between items-center mb-1">
                            <div class="flex items-center">
                                <span class="font-bold text-slate-700 ml-2">${name}</span>
                                ${roleSelect}
                            </div>
                            <button onclick="Groups.removeMember(${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                        </div>`;
                });
                const routeList = document.getElementById('group-route-list');
                routeList.innerHTML = '';
                (group.route || []).forEach((did, i) => {
                    const d = Store.data.donors[did];
                    if(!d) return;
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 border rounded-lg shadow-sm text-sm mb-2 flex justify-between items-center cursor-grab active:cursor-grabbing hover:border-emerald-200 transition";
                    el.dataset.id = did;
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="bg-emerald-100 text-emerald-700 w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold">${i+1}</span>
                            <div>
                                <div class="font-bold text-slate-800">${d.name}</div>
                                <div class="text-xs text-gray-500">${d.city || ''} ${d.street || d.address || ''}</div>
                            </div>
                        </div>
                        <i class="fas fa-grip-lines text-gray-300"></i>
                    `;
                    routeList.appendChild(el);
                });
                if(this.sortableInstance) this.sortableInstance.destroy();
                this.sortableInstance = new Sortable(routeList, {
                    animation: 150,
                    ghostClass: 'bg-emerald-50',
                    onEnd: () => {
                        const newOrder = Array.from(routeList.children).map(c => c.dataset.id);
                        OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/route`, newOrder);
                    }
                });
                this.filterStudents('');
            },
            addNewGroup() {
                const n = prompt("שם הקבוצה:");
                if(n) {
                    const newRef = db.ref(`years/${Store.currentYear}/groups/${this.currentDay}`).push();
                    OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${newRef.key}`, {name: n, members: [], route: []});
                }
            },
            renameGroup() {
                const old = document.getElementById('active-group-name').innerText;
                const n = prompt("שם חדש לקבוצה:", old);
                if(n && n !== old) OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/name`, n);
            },
            deleteGroup() {
                 if(confirm('האם אתה בטוח שברצונך למחוק קבוצה זו?')) {
                     OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}`, null, 'remove');
                     this.activeGroupId = null;
                     this.render();
                 }
            },
            filterStudents(term) {
                const pool = document.getElementById('pool-students');
                pool.innerHTML = '';
                // תיקון מס' 1: סינון ארכיון מרשימת הוספה לקבוצות + הגנה מקריסה
                let list = Object.values(Store.data.students).filter(s => s && !s.isArchived);
                list = list.map(s => ({
                    ...s, 
                    fullName: s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : (s.name || '')
                }));

                // סינון בחורים שכבר משובצים באותו יום בכל הקבוצות
                const dayGroups = Store.data.yearData[Store.currentYear].groups[this.currentDay] || {};
                const assignedInDay = new Set();
                Object.values(dayGroups).forEach(g => (g.members||[]).forEach(m => assignedInDay.add(m.id)));
                list = list.filter(s => !assignedInDay.has(s.id));

                if(term) {
                    list = list.filter(s => s.fullName.includes(term));
                }
                
                list.slice(0, 50).forEach(s => {
                    pool.innerHTML += `<div onclick="Groups.addMember('${s.id}')" class="p-2 border-b cursor-pointer hover:bg-indigo-50 flex justify-between text-sm"><span class="font-medium">${s.fullName}</span><i class="fas fa-plus text-indigo-500"></i></div>`;
                });
                if (list.length > 50) {
                     pool.innerHTML += `<div class="text-xs text-center p-2 text-gray-400">ישנן עוד תוצאות, דייק את החיפוש...</div>`;
                }
            },
            addMember(sid) {
                const path = `years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members`;
                db.ref(path).once('value', snap => {
                    const list = snap.val() || [];
                    if(!list.some(x => x.id === sid)) {
                        list.push({id: sid, role: 'חבר'});
                        OfflineManager.write(path, list);
                    }
                });
            },
            removeMember(idx) {
                const path = `years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members`;
                db.ref(path).once('value', s => {
                    const l = s.val(); l.splice(idx,1); 
                    OfflineManager.write(path, l);
                });
            },
            updateMemberRole(idx, newRole) {
                const path = `years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members/${idx}/role`;
                OfflineManager.write(path, newRole);
            },
            removeFromRoute(day, gid, did) {
                const path = `years/${Store.currentYear}/groups/${day}/${gid}/route`;
                db.ref(path).once('value', s => {
                    let l = s.val() || [];
                    l = l.filter(x => x !== did);
                    OfflineManager.write(path, l);
                });
                setTimeout(() => Store.loadGroups(), 500); // עדכון מפה
            },
            openGroupDonationModal() {
                // שינוי לוגיקה: התרומה לא מתחלקת, נרשמת כישות קבוצתית
                const g = (Store.data.yearData[Store.currentYear].groups[this.currentDay] || {})[this.activeGroupId];
                if (!g) return Notify.show('שגיאה בטעינת הקבוצה', 'error');

                const html = `
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1">סכום תרומה קבוצתי</label>
                        <input type="number" id="group-total-amount" class="input-field w-full" placeholder="לדוגמה: 1000">
                        <p class="text-xs text-gray-500 mt-1">הסכום יירשם לזכות הקבוצה ולא יחולק בין הבחורים.</p>
                    </div>
                `;
                Modal.renderRaw('הוספת תרומה קבוצתית', html, () => {
                    const total = parseInt(document.getElementById('group-total-amount').value);
                    if (!total || total <= 0) return;
                    
                    const id = 'tx' + Date.now();
                    OfflineManager.write(`years/${Store.currentYear}/finance/${id}`, {
                        id, date: Date.now(), type: 'income',
                        amount: total, category: 'תרומה קבוצתית',
                        desc: `תרומה לקבוצה: ${g.name}`,
                        isGroup: true,
                        groupId: this.activeGroupId,
                        groupName: g.name,
                        isPurim: true 
                    });
                    if(OfflineManager.isOnline) db.ref(`years/${Store.currentYear}/stats/income`).transaction(curr => (curr || 0) + total);
                    Notify.show(`תרומה של ${total} ש"ח נרשמה לקבוצה בהצלחה!`, 'success');
                    Modal.close();
                    setTimeout(() => Finance.loadMore(true), 1000);
                });
            },
            copyFromPreviousYear() {
                const mapRev = {'תשפ״ח':5788, 'תשפ״ז':5787, 'תשפ״ו':5786, 'תשפ״ה':5785, 'תשפ״ד':5784, 'תשפ״ג':5783, 'תשפ״ב':5782, 'תשפ״א':5781, 'תש״פ':5780};
                const map = {5788:'תשפ״ח', 5787:'תשפ״ז', 5786:'תשפ״ו', 5785:'תשפ״ה', 5784:'תשפ״ד', 5783:'תשפ״ג', 5782:'תשפ״ב', 5781:'תשפ״א', 5780:'תש״פ'};
                
                const currNum = mapRev[Store.currentYear];
                if(!currNum) return alert('לא ניתן לזהות את השנה הנוכחית');
                const prevYear = map[currNum - 1];
                if(!prevYear) return alert('לא ניתן לזהות את השנה הקודמת');

                if(!confirm(`האם לייבא קבוצות משנת ${prevYear}? הפעולה תייבא את מבנה הקבוצות ואת כל התורמים שהיו משובצים אליהן בכל השנים (אלא אם הועברו). הבחורים לא יועתקו.`)) return;

                Notify.show('מייבא נתונים...', 'info');
                
                const prevYear2 = map[currNum - 2];
                const p1 = db.ref(`years/${prevYear}/groups`).once('value');
                const p2 = prevYear2 ? db.ref(`years/${prevYear2}/groups`).once('value') : Promise.resolve({val:()=>({})});

                Promise.all([p1, p2]).then(snaps => {
                    const old1 = snaps[0].val() || {};
                    const old2 = snaps[1].val() || {};
                    
                    const newGroups = {};
                    
                    const merge = (target, source) => {
                        Object.keys(source).forEach(day => {
                            if(!target[day]) target[day] = {};
                            Object.keys(source[day]).forEach(gid => {
                                if(!target[day][gid]) target[day][gid] = { name: source[day][gid].name, route: [], members: [] };
                                const existingRoute = new Set(target[day][gid].route);
                                (source[day][gid].route || []).forEach(did => {
                                    if(!existingRoute.has(did)) target[day][gid].route.push(did);
                                });
                            });
                        });
                    };

                    merge(newGroups, old1);
                    merge(newGroups, old2);

                    db.ref(`years/${Store.currentYear}/groups`).update(newGroups, (err) => {
                        if(err) Notify.show('שגיאה בהעתקה', 'error');
                        else {
                            Notify.show('הקבוצות והמסלולים יובאו בהצלחה!', 'success');
                            setTimeout(() => location.reload(), 1500);
                        }
                    });
                });
            },
            exportGroupData(format) {
                const g = (Store.data.yearData[Store.currentYear].groups[this.currentDay] || {})[this.activeGroupId];
                if(!g) return;
                
                Reports.getAllHistory().then(historyData => {
                    const donors = (g.route || []).map(did => Store.data.donors[did]).filter(x => x);
                    const rows = donors.map(d => {
                        const row = {
                            "שם": d.name,
                            "כתובת": `${d.city||''} ${d.street||''}`,
                            "טלפון": d.phone || '',
                            "הערות": d.notes || ''
                        };
                         Object.keys(historyData).forEach(yNum => {
                             const hYear = Object.keys(HEBREW_YEARS_MAPPING).find(key => HEBREW_YEARS_MAPPING[key] == yNum);
                             if(hYear) row[hYear] = historyData[yNum][d.id] || 0;
                         });
                         return row;
                    });

                    if (format === 'excel') {
                        const ws = XLSX.utils.json_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "נתוני קבוצה");
                        XLSX.writeFile(wb, `Group_${g.name}.xlsx`);
                    } else {
                        // PDF
                        const doc = new jspdf.jsPDF({ orientation: 'landscape' });
                        doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
                        doc.setFont("Roboto");
                        doc.text(`נתוני קבוצה: ${g.name}`, 200, 10, { align: 'right' });
                        
                        const headers = Object.keys(rows[0] || {});
                        const body = rows.map(r => Object.values(r));
                        
                        doc.autoTable({
                            head: [headers],
                            body: body,
                            theme: 'grid',
                            styles: { font: 'Roboto', halign: 'right' }
                        });
                        doc.save(`Group_${g.name}.pdf`);
                    }
                });
            },
            // תיקון: הדפסת קוביות מסודרות
            printAllGroups() {
                Notify.show('מכין הדפסה מרוכזת...', 'info');
                // תיקון מס' 2: הדפסת הקבוצות של היום הנוכחי בלבד (מה שנבחר בטאב)
                const groups = Store.data.yearData[Store.currentYear]?.groups[this.currentDay] || {};
                const dayName = this.currentDay.replace('night','ליל ').replace('day','יום ');

                if (Object.keys(groups).length === 0) {
                     return Notify.show('אין קבוצות להדפסה ביום זה', 'info');
                }

                let html = `<div class="boxes-container">`;
                
                Object.values(groups).forEach(g => {
                    html += `
                        <div class="group-box">
                            <div class="group-box-header">${g.name} - ${dayName}</div>
                            <div class="group-box-content">
                    `;
                    
                    // מיון חברים לפי תפקיד
                    const members = g.members || [];
                    const commanders = members.filter(m => m.role === 'ראש צוות');
                    const deputies = members.filter(m => m.role === 'סגן');
                    const regulars = members.filter(m => m.role !== 'ראש צוות' && m.role !== 'סגן');
                    
                    const renderRow = (m, roleText) => {
                        const s = Store.data.students[m.id];
                        if (!s) return '';
                        const name = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                        return `
                            <div class="group-box-row">
                                <span class="box-name">${name} ${roleText ? `<span class="box-role">(${roleText})</span>` : ''}</span>
                                <span class="box-grade">${s.grade || ''}</span>
                            </div>
                        `;
                    };
                    
                    commanders.forEach(m => html += renderRow(m, 'ר"צ'));
                    deputies.forEach(m => html += renderRow(m, 'סגן'));
                    regulars.forEach(m => html += renderRow(m, ''));
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                const pa = document.getElementById('print-area');
                pa.innerHTML = `
                    <div class="print-header no-print-bg">
                        <img src="1.JPG" alt="לוגו">
                        <h1>רשימת קבוצות - ${dayName}</h1>
                        <h3>שנה: ${Store.currentYear}</h3>
                    </div>
                    ${html}
                `;
                window.print();
            },
            async printSheet(type) {
                const g = (Store.data.yearData[Store.currentYear].groups[this.currentDay] || {})[this.activeGroupId];
                if(!g) return;
                
                const dayMap = {'night14': 'ליל י"ד', 'day14': 'יום י"ד', 'day15': 'יום ט"ו'};
                const dayName = dayMap[this.currentDay] || this.currentDay;
                
                let html = `
                    <div class="print-header">
                        <img src="1.JPG" alt="לוגו">
                        <h1>${type==='route'?'דף מסלול':'דף קבוצה'} - ${g.name}</h1>
                        <h3>שנה: ${Store.currentYear} | זמן: ${dayName}</h3>
                    </div>
                `;
                
                if(type === 'members') {
                    document.body.classList.add('wall-mode');
                    const members = g.members || [];
                    const commanders = members.filter(m => m.role === 'ראש צוות');
                    const deputies = members.filter(m => m.role === 'סגן');
                    const regulars = members.filter(m => m.role !== 'ראש צוות' && m.role !== 'סגן');

                    const renderMemberRow = (m, idx) => {
                        const s = Store.data.students[m.id];
                        if (!s) return '';
                        const name = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                        
                        let roleBadge = '';
                        let rowClass = '';
                        if (m.role === 'ראש צוות') { roleBadge = '<span class="role-badge role-commander">ראש צוות</span>'; rowClass = 'font-bold bg-blue-50'; }
                        else if (m.role === 'סגן') { roleBadge = '<span class="role-badge role-deputy">סגן</span>'; rowClass = 'bg-yellow-50'; }
                        
                        return `<tr class="${rowClass}">
                            <td width="5%">${idx+1}</td>
                            <td width="55%"><b>${name}</b> ${roleBadge}</td>
                            <td width="40%">${s.grade || ''}</td>
                        </tr>`;
                    };

                    html += `<table class="print-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>שם הבחור</th>
                                <th>שיעור</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    let count = 0;
                    commanders.forEach(m => html += renderMemberRow(m, count++));
                    deputies.forEach(m => html += renderMemberRow(m, count++));
                    regulars.forEach(m => html += renderMemberRow(m, count++));
                    html += `</tbody></table>`;
                    
                } else {
                    document.body.classList.remove('wall-mode');
                    Notify.show('מכין נתונים להדפסה...', 'info');
                    
                    const yearMapRev = {'תשפ״ח':5788, 'תשפ״ז':5787, 'תשפ״ו':5786, 'תשפ״ה':5785, 'תשפ״ד':5784, 'תשפ״ג':5783, 'תשפ״ב':5782, 'תשפ״א':5781, 'תש״פ':5780};
                    const yearMap = {5788:'תשפ״ח', 5787:'תשפ״ז', 5786:'תשפ״ו', 5785:'תשפ״ה', 5784:'תשפ״ד', 5783:'תשפ״ג', 5782:'תשפ״ב', 5781:'תשפ״א', 5780:'תש״פ'};
                    
                    // [3] תיקון סדר שנים כרונולוגי:
                    let currNum = yearMapRev[Store.currentYear] || 5785;
                    const prev1 = yearMap[currNum-1] || (currNum-1).toString();
                    const prev2 = yearMap[currNum-2] || (currNum-2).toString();
                    const prev3 = yearMap[currNum-3] || (currNum-3).toString();

                    const getHistory = async (year) => {
                        const snap = await db.ref(`years/${year}/finance`).once('value');
                        const val = snap.val() || {};
                        const totals = {};
                        Object.values(val).forEach(tx => {
                            if (tx.type === 'income' && tx.donorId) {
                                if (!totals[tx.donorId]) totals[tx.donorId] = 0;
                                if (!isNaN(parseFloat(tx.amount))) totals[tx.donorId] += parseFloat(tx.amount);
                                else totals[tx.donorId] = tx.amount; 
                            }
                        });
                        return totals;
                    };

                    const [hist1, hist2, hist3] = await Promise.all([
                        getHistory(prev1),
                        getHistory(prev2),
                        getHistory(prev3)
                    ]);

                    // סדר כרונולוגי: prev3, prev2, prev1 (למשל תשפג, תשפד, תשפה)
                    html += `<table class="print-table">
                        <thead>
                            <tr>
                                <th width="3%">#</th>
                                <th width="10%">שם פרטי</th>
                                <th width="10%">שם משפחה</th>
                                <th width="8%">עיר</th>
                                <th width="8%">שכונה</th>
                                <th width="10%">רחוב</th>
                                <th width="5%">קומה</th>
                                <th width="16%">הערות</th>
                                <th width="7%">${prev3}</th>
                                <th width="7%">${prev2}</th>
                                <th width="7%">${prev1}</th>
                                <th width="9%">סכום</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    (g.route||[]).forEach((did, i) => {
                        const d = Store.data.donors[did];
                        if(d) {
                            let fName = d.firstName;
                            let lName = d.lastName;
                            if(!fName && !lName && d.name) {
                                const parts = d.name.split(' ');
                                fName = parts[0];
                                lName = parts.slice(1).join(' ');
                            }
                            let street = d.street || d.address;
                            
                            const val1 = hist1[did] ? (isNaN(hist1[did]) ? hist1[did] : '₪'+hist1[did]) : '';
                            const val2 = hist2[did] ? (isNaN(hist2[did]) ? hist2[did] : '₪'+hist2[did]) : '';
                            const val3 = hist3[did] ? (isNaN(hist3[did]) ? hist3[did] : '₪'+hist3[did]) : '';

                            html += `<tr>
                                <td>${i+1}</td>
                                <td>${fName || ''}</td>
                                <td><b>${lName || ''}</b></td>
                                <td>${d.city || ''}</td>
                                <td>${d.neighborhood || ''}</td>
                                <td>${street || ''}</td>
                                <td>${d.floor || ''}</td>
                                <td>${d.notes||''}</td>
                                <td>${val3}</td>
                                <td>${val2}</td>
                                <td>${val1}</td>
                                <td></td>
                            </tr>`;
                        }
                    });
                    html += `</tbody></table>`;
                }
                
                const pa = document.getElementById('print-area');
                pa.innerHTML = html;
                window.print(); 
            }
        };

        // --- 9. FINANCE LOGIC ---
        const Finance = {
            currentFilter: 'all',
            limit: 30,
            financeData: {},
            reset() { 
                this.financeData = {}; Store.cursors.finance = null; 
                document.getElementById('finance-tbody').innerHTML = '';
                this.loadMore(); 
            },
            loadMore(reset = false) {
                if(reset) this.reset();
                let q = db.ref(`years/${Store.currentYear}/finance`).orderByChild('date').limitToLast(this.limit);
                if(Store.cursors.finance) q = q.endBefore(Store.cursors.finance);
                q.once('value', snap => {
                    const data = snap.val();
                    if(!data) {
                        document.getElementById('finance-loader-more').style.display = 'none';
                        return;
                    }
                    const arr = [];
                    Object.keys(data).forEach(k => arr.push(data[k]));
                    arr.sort((a,b) => b.date - a.date); 
                    Store.cursors.finance = arr[arr.length-1].date;
                    document.getElementById('finance-loader-more').style.display = 'block';
                    Object.assign(this.financeData, data);
                    this.render();
                });
            },
            render() {
                const tbody = document.getElementById('finance-tbody');
                tbody.innerHTML = ''; 
                let raw = Object.values(this.financeData);
                if(this.currentFilter !== 'all') {
                    if(this.currentFilter === 'purim') raw = raw.filter(tx => tx.isPurim);
                    else raw = raw.filter(tx => tx.type === this.currentFilter);
                }
                
                raw.sort((a,b) => b.date - a.date);
                tbody.innerHTML = raw.map(tx => {
                    let entityName = '-';
                    if (tx.studentId) {
                         const s = Store.data.students[tx.studentId];
                         entityName = s ? (s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name) : 'לא ידוע';
                    } else if (tx.donorId) {
                         entityName = Store.data.donors[tx.donorId]?.name || 'לא ידוע';
                    } else if (tx.isGroup) {
                        entityName = `קבוצה: ${tx.groupName || tx.groupId}`;
                    }

                    // תיקון מס' 8: טיפול בסכום שהוא טקסט (למניעת באגים)
                    const isNote = isNaN(parseFloat(tx.amount));
                    const displayAmount = isNote ? `<span class="text-xs text-gray-500">${tx.amount}</span>` : `₪${parseInt(tx.amount).toLocaleString()}`;
                    const rowClass = isNote ? 'bg-gray-50 italic' : 'hover:bg-slate-50';

                    // [5] תצוגת תאריך עברי
                    const displayDate = System.toHebrewDate(tx.date);

                    return `
                    <tr class="${rowClass} border-b border-slate-50 transition">
                        <td class="p-3 text-gray-500 text-xs">${displayDate}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${tx.type==='income'?'bg-emerald-50 text-emerald-700':'bg-rose-50 text-rose-700'}">${tx.type==='income'?'הכנסה':'הוצאה'}</span></td>
                        <td class="p-3 font-medium text-slate-700">${tx.category}</td>
                        <td class="p-3">
                            <div class="text-sm">${tx.desc || ''}</div>
                            ${entityName !== '-' ? `<div class="text-xs text-gray-400"><i class="fas fa-user-tag"></i> ${entityName}</div>` : ''}
                            ${tx.addedBy ? `<div class="text-[10px] text-gray-400">נוסף ע״י: ${tx.addedBy}</div>` : ''}
                        </td>
                        <td class="p-3 font-bold ${tx.type==='income'?'text-emerald-600':'text-rose-600'}" dir="ltr">${displayAmount}</td>
                        <td class="p-3 flex gap-2 justify-center">
                            <button onclick="Finance.editTx('${tx.id}')" class="text-gray-300 hover:text-indigo-500 transition"><i class="fas fa-pen"></i></button>
                            <button onclick="Finance.deleteTx('${tx.id}', '${tx.type}', '${tx.amount}')" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            },
            setFilter(f) {
                this.currentFilter = f;
                document.querySelectorAll('.finance-filter').forEach(b => {
                    const active = b.dataset.f === f;
                    b.classList.toggle('active', active);
                    b.classList.toggle('bg-slate-800', active);
                    b.classList.toggle('text-white', active);
                    b.classList.toggle('shadow-md', active);
                });
                this.render();
            },
            
            // תיקון מס' 4: תצוגת ניהול תלושים
            openVouchersView() {
                document.getElementById('finance-main-view').classList.add('hidden');
                document.getElementById('finance-store-debts-view').classList.add('hidden');
                document.getElementById('finance-vouchers-view').classList.remove('hidden');
                this.renderPendingVouchers();
            },
            closeVouchersView() {
                document.getElementById('finance-main-view').classList.remove('hidden');
                document.getElementById('finance-vouchers-view').classList.add('hidden');
                this.loadMore(true);
            },
            // תיקון מס' 1: פונקציה לפתיחת מסך חובות לחנויות
            openStoreDebtsView() {
                document.getElementById('finance-main-view').classList.add('hidden');
                document.getElementById('finance-vouchers-view').classList.add('hidden');
                document.getElementById('finance-store-debts-view').classList.remove('hidden');
                this.renderStoreDebts();
            },
            closeStoreDebtsView() {
                document.getElementById('finance-main-view').classList.remove('hidden');
                document.getElementById('finance-store-debts-view').classList.add('hidden');
                this.loadMore(true);
            },

            renderPendingVouchers() {
                const list = document.getElementById('pending-vouchers-list');
                list.innerHTML = '<div class="text-center text-gray-400">טוען תלושים...</div>';
                
                db.ref(`years/${Store.currentYear}/vouchersPending`).once('value', s => {
                    const data = s.val();
                    if(!data) {
                        list.innerHTML = '<div class="text-center text-gray-400 p-4">אין תלושים הממתינים למימוש</div>';
                        return;
                    }
                    list.innerHTML = '';
                    Object.values(data).forEach(v => {
                        const student = Store.data.students[v.studentId];
                        const sName = student ? (student.firstName ? `${student.firstName} ${student.lastName}` : student.name) : 'לא ידוע';
                        list.innerHTML += `
                            <div class="bg-white p-4 border rounded shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-gray-800">${v.voucherName} (שווי: ₪${v.faceValue})</div>
                                    <div class="text-sm text-gray-500">עבור: <span class="font-bold text-indigo-600">${sName}</span> | חנות: ${v.storeName || 'לא צוין'}</div>
                                    <div class="text-xs text-gray-400">עלות למערכת: ₪${v.realCost}</div>
                                </div>
                                <button onclick="Finance.realizeVoucher('${v.id}')" class="bg-purple-600 text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-purple-700">
                                    העבר למומש (רשום הוצאה)
                                </button>
                            </div>
                        `;
                    });
                });
            },
            // תיקון מס' 1: רישום תלוש כמומש עם מידע על חנות
            realizeVoucher(vid) {
                if(!confirm('האם לרשום תלוש זה כמומש? הפעולה תיצור הוצאה בקופה לפי העלות האמיתית.')) return;
                
                db.ref(`years/${Store.currentYear}/vouchersPending/${vid}`).once('value', s => {
                    const v = s.val();
                    if(!v) return;
                    
                    // Create expense
                    const expenseId = 'exp' + Date.now();
                    const expenseTx = {
                        id: expenseId,
                        date: Date.now(),
                        type: 'expense',
                        amount: parseFloat(v.realCost), // Real cost is the expense
                        category: 'תלושים/מתנות',
                        desc: `מימוש תלוש: ${v.voucherName} (שווי ${v.faceValue})`,
                        studentId: v.studentId,
                        isPurim: true,
                        // NEW: שיוך לחנות וסטטוס תשלום
                        storeName: v.storeName || 'כללי',
                        isPaidToStore: false
                    };
                    
                    OfflineManager.write(`years/${Store.currentYear}/finance/${expenseId}`, expenseTx);
                    if(OfflineManager.isOnline) {
                         db.ref(`years/${Store.currentYear}/stats/expense`).transaction(c => (c||0) + expenseTx.amount);
                    }
                    
                    // Remove from pending
                    OfflineManager.write(`years/${Store.currentYear}/vouchersPending/${vid}`, null, 'remove');
                    
                    Notify.show('התלוש מומש ונרשמה הוצאה', 'success');
                    setTimeout(() => this.renderPendingVouchers(), 500);
                });
            },
            
            // תיקון מס' 1: הצגת סיכום חובות לחנויות
            renderStoreDebts() {
                const container = document.getElementById('store-debts-container');
                container.innerHTML = '<div class="text-center text-gray-400">מחשב נתונים...</div>';
                
                db.ref(`years/${Store.currentYear}/finance`).once('value', s => {
                    const allTx = Object.values(s.val() || {});
                    const storeMap = {};
                    
                    // סינון הוצאות תלושים
                    allTx.forEach(tx => {
                        if (tx.type === 'expense' && tx.category === 'תלושים/מתנות' && tx.storeName) {
                            if (!storeMap[tx.storeName]) storeMap[tx.storeName] = { total: 0, paid: 0, debts: 0, items: [] };
                            
                            const amt = parseFloat(tx.amount) || 0;
                            storeMap[tx.storeName].total += amt;
                            if (tx.isPaidToStore) {
                                storeMap[tx.storeName].paid += amt;
                            } else {
                                storeMap[tx.storeName].debts += amt;
                            }
                            storeMap[tx.storeName].items.push(tx);
                        }
                    });
                    
                    if (Object.keys(storeMap).length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-400">אין נתוני חובות לחנויות. (ודא שתלושים מומשו עם שיוך לחנות)</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    Object.entries(storeMap).forEach(([store, data]) => {
                         const debtClass = data.debts > 0 ? 'text-red-600' : 'text-green-600';
                         let itemsHtml = '';
                         data.items.forEach(item => {
                             const btnLabel = item.isPaidToStore ? 'סמן כלא שולם' : 'סמן כשולם';
                             const btnClass = item.isPaidToStore ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-700 font-bold';
                             const sName = Store.data.students[item.studentId] ? Store.data.students[item.studentId].name : '';
                             
                             itemsHtml += `
                                <div class="flex justify-between items-center border-b p-2 text-sm ${item.isPaidToStore ? 'bg-gray-50 opacity-75' : ''}">
                                    <div>
                                        <div class="font-medium">${item.desc}</div>
                                        <div class="text-xs text-gray-500">${sName ? 'עבור: '+sName : ''} | ${System.toHebrewDate(item.date)}</div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="font-bold">₪${item.amount}</span>
                                        <button onclick="Finance.toggleStorePayment('${item.id}', ${!item.isPaidToStore})" class="text-xs px-2 py-1 rounded border ${btnClass}">
                                            ${btnLabel}
                                        </button>
                                    </div>
                                </div>
                             `;
                         });

                         container.innerHTML += `
                            <div class="bg-white border rounded-xl overflow-hidden mb-4 shadow-sm">
                                <div class="p-4 bg-gray-50 border-b flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                    <h4 class="font-bold text-lg">${store}</h4>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-500">סך הכל: ₪${data.total.toLocaleString()}</div>
                                        <div class="font-bold ${debtClass}">חוב לתשלום: ₪${data.debts.toLocaleString()}</div>
                                    </div>
                                    <i class="fas fa-chevron-down text-gray-400 ml-2"></i>
                                </div>
                                <div class="hidden bg-white p-2 max-h-60 overflow-y-auto custom-scroll">
                                    ${itemsHtml}
                                </div>
                            </div>
                         `;
                    });
                });
            },
            toggleStorePayment(id, status) {
                OfflineManager.write(`years/${Store.currentYear}/finance/${id}/isPaidToStore`, status);
                setTimeout(() => this.renderStoreDebts(), 200);
            },

            // --- תיקון 3: טבלת הוספה מרוכזת (אקסל סטייל) ---
            renderBatchTransactionForm() {
                const today = new Date().toISOString().split('T')[0];
                const vouchers = Store.data.config.vouchers || [];
                
                // יצירת רשימת בחורים/תורמים ל-datalist
                const studentsList = Object.values(Store.data.students).map(s => {
                    const n = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                    return `<option value="${n} (בחור)">${s.id}</option>`;
                }).join('');
                const donorsList = Object.values(Store.data.donors).map(d => `<option value="${d.name} (תורם)">${d.id}</option>`).join('');

                const catsIncome = `<option>תרומה כללית</option><option>מזומן</option><option>צק</option><option>אשראי</option>`;
                const catsExpense = `<option>אוכל</option><option>ציוד</option><option>שיווק</option><option>אחר</option><option>תלושים/מתנות</option>`;

                const html = `
                    <div class="overflow-x-auto">
                        <datalist id="entity-list">
                            ${studentsList}
                            ${donorsList}
                        </datalist>
                        <table class="w-full text-right batch-table" id="batch-tx-table">
                            <thead>
                                <tr>
                                    <th width="80">סוג</th>
                                    <th width="120">תאריך</th>
                                    <th width="150">שם (חפש והקלד)</th>
                                    <th width="100">סכום / תלוש</th>
                                    <th width="120">קטגוריה</th>
                                    <th>פרטים / הערות</th>
                                    <th width="50" class="text-center">פורים</th>
                                    <th width="40"></th>
                                </tr>
                            </thead>
                            <tbody id="batch-tbody">
                                <!-- שורות ייווצרו דינמית -->
                            </tbody>
                        </table>
                        <button onclick="Finance.addBatchRow()" class="mt-4 text-indigo-600 font-bold text-sm hover:underline">+ הוסף שורה</button>
                    </div>
                `;

                Modal.renderRaw('הוספת תנועות מרוכזת', html, () => Finance.submitBatch());
                
                // הוספת 5 שורות התחלתיות
                for(let i=0; i<5; i++) Finance.addBatchRow();
            },

            addBatchRow() {
                const tbody = document.getElementById('batch-tbody');
                const rowId = 'row-' + Date.now() + Math.random().toString(36).substr(2, 5);
                const tr = document.createElement('tr');
                tr.id = rowId;
                const today = new Date().toISOString().split('T')[0];
                
                // Voucher Options
                const vouchers = Store.data.config.vouchers || [];
                let voucherOpts = '<option value="">-- בחר תלוש --</option>';
                vouchers.forEach(v => {
                    voucherOpts += `<option value="${v.id}" data-cost="${v.realCost}" data-face="${v.faceValue}" data-name="${v.voucherName}">${v.voucherName} (${v.storeName})</option>`;
                });

                tr.innerHTML = `
                    <td>
                        <select class="batch-input" name="type" onchange="Finance.toggleRowType(this)">
                            <option value="income">הכנסה</option>
                            <option value="expense">הוצאה</option>
                            <option value="voucher">תלוש לבחור</option>
                        </select>
                    </td>
                    <td><input type="date" class="batch-input" name="date" value="${today}"></td>
                    <td>
                        <input type="text" list="entity-list" class="batch-input" name="entityName" placeholder="הקלד שם..." onchange="Finance.resolveEntity(this)">
                        <input type="hidden" name="entityId">
                        <input type="hidden" name="entityType">
                    </td>
                    <td>
                        <!-- עבור הכנסה/הוצאה רגילה -->
                        <input type="number" class="batch-input field-amount" name="amount" placeholder="0">
                        <!-- עבור תלוש -->
                        <select class="batch-input field-voucher hidden" name="voucherId" onchange="Finance.fillVoucherDetails(this)">${voucherOpts}</select>
                    </td>
                    <td>
                        <select class="batch-input field-cat" name="category">
                            <option>תרומה כללית</option><option>מזומן</option><option>צק</option><option>אשראי</option>
                        </select>
                    </td>
                    <td><input type="text" class="batch-input" name="desc"></td>
                    <td class="text-center"><input type="checkbox" name="isPurim" checked class="h-4 w-4"></td>
                    <td class="text-center"><button onclick="document.getElementById('${rowId}').remove()" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></td>
                `;
                tbody.appendChild(tr);
            },

            toggleRowType(select) {
                const tr = select.closest('tr');
                const type = select.value;
                const catSelect = tr.querySelector('.field-cat');
                const amtInput = tr.querySelector('.field-amount');
                const voucherSelect = tr.querySelector('.field-voucher');
                
                if (type === 'voucher') {
                    amtInput.classList.add('hidden');
                    voucherSelect.classList.remove('hidden');
                    catSelect.innerHTML = `<option>תלושים/מתנות</option>`;
                    catSelect.disabled = true;
                } else {
                    amtInput.classList.remove('hidden');
                    voucherSelect.classList.add('hidden');
                    catSelect.disabled = false;
                    if (type === 'income') {
                        catSelect.innerHTML = `<option>תרומה כללית</option><option>מזומן</option><option>צק</option><option>אשראי</option>`;
                    } else {
                        catSelect.innerHTML = `<option>אוכל</option><option>ציוד</option><option>שיווק</option><option>אחר</option><option>תלושים/מתנות</option>`;
                    }
                }
            },

            resolveEntity(input) {
                const val = input.value;
                const tr = input.closest('tr');
                const hiddenId = tr.querySelector('input[name="entityId"]');
                const hiddenType = tr.querySelector('input[name="entityType"]');
                
                // ה-datalist שומר את ה-ID בתור ה-value אם המשתמש בחר מהרשימה? לא, בדפדפנים זה הפוך לפעמים.
                // נחפש במאגר לפי השם שהוזן
                // Datalist מציג "שם (סוג)" כערך.
                // ננסה לחלץ.
                
                // חיפוש חכם במאגר
                const cleanName = val.replace(' (בחור)', '').replace(' (תורם)', '');
                
                let foundId = null; 
                let foundType = null;

                // חיפוש בבחורים
                const s = Object.values(Store.data.students).find(s => {
                    const n = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                    return n === cleanName;
                });
                if (s) { foundId = s.id; foundType = 'student'; }
                
                // אם לא, חיפוש בתורמים
                if (!foundId) {
                    const d = Object.values(Store.data.donors).find(d => d.name === cleanName);
                    if (d) { foundId = d.id; foundType = 'donor'; }
                }

                if (foundId) {
                    hiddenId.value = foundId;
                    hiddenType.value = foundType;
                    input.classList.add('border-green-500', 'bg-green-50');
                } else {
                    hiddenId.value = '';
                    hiddenType.value = '';
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            },

            fillVoucherDetails(select) {
                // אופציונלי: מילוי אוטומטי של תיאור
            },

            submitBatch() {
                const rows = document.querySelectorAll('#batch-tbody tr');
                let count = 0;
                
                rows.forEach(tr => {
                    const type = tr.querySelector('select[name="type"]').value;
                    const dateVal = tr.querySelector('input[name="date"]').value;
                    const entityId = tr.querySelector('input[name="entityId"]').value;
                    const entityType = tr.querySelector('input[name="entityType"]').value; // student/donor
                    const entityNameRaw = tr.querySelector('input[name="entityName"]').value;
                    const category = tr.querySelector('select[name="category"]').value;
                    const desc = tr.querySelector('input[name="desc"]').value;
                    const isPurim = tr.querySelector('input[name="isPurim"]').checked;
                    
                    const timestamp = dateVal ? new Date(dateVal + 'T12:00:00').getTime() : Date.now();
                    const txId = 'tx' + Date.now() + Math.random().toString(36).substr(2,5);

                    if (type === 'voucher') {
                        // הוספת תלוש
                        const voucherSelect = tr.querySelector('select[name="voucherId"]');
                        const vOption = voucherSelect.options[voucherSelect.selectedIndex];
                        if (!vOption.value || !entityId || entityType !== 'student') return; // חובה בחור לתלוש
                        
                        const vData = {
                            id: 'vp' + Date.now() + Math.random().toString(36).substr(2,5),
                            studentId: entityId,
                            voucherId: vOption.value,
                            voucherName: vOption.dataset.name,
                            realCost: parseFloat(vOption.dataset.cost),
                            faceValue: parseFloat(vOption.dataset.face),
                            storeName: vOption.text.match(/\((.*?)\)/)?.[1] || 'כללי', // חילוץ שם החנות מהטקסט
                            dateIssued: timestamp
                        };
                        OfflineManager.write(`years/${Store.currentYear}/vouchersPending/${vData.id}`, vData);
                        count++;
                        
                    } else {
                        // הכנסה / הוצאה
                        const amount = parseFloat(tr.querySelector('input[name="amount"]').value);
                        if (!amount) return;

                        const txData = {
                            id: txId,
                            date: timestamp,
                            type: type,
                            amount: amount,
                            category: category,
                            desc: (entityId ? '' : `שם: ${entityNameRaw}. `) + desc,
                            isPurim: isPurim
                        };
                        
                        if (entityId) {
                            if (entityType === 'student') txData.studentId = entityId;
                            if (entityType === 'donor') txData.donorId = entityId;
                        }

                        OfflineManager.write(`years/${Store.currentYear}/finance/${txId}`, txData);
                        
                        if(OfflineManager.isOnline) {
                             db.ref(`years/${Store.currentYear}/stats/${type}`).transaction(curr => (curr || 0) + amount);
                        }
                        
                        // בדיקת יעד בחור אם רלוונטי
                        if(type === 'income' && txData.studentId) {
                            System.checkStudentProgress(txData.studentId, amount);
                        }
                        count++;
                    }
                });
                
                if (count > 0) {
                    Notify.show(`${count} שורות נקלטו בהצלחה`, 'success');
                    Modal.close();
                } else {
                    alert('לא נקלטו נתונים (ודא שמילאת סכומים ושמות תקינים)');
                }
            },

            editTx(id) {
                const tx = this.financeData[id];
                if(!tx) return;
                // שימוש בחלונית הישנה לעריכה (פשוט יותר) או התאמת החדשה. נשתמש בישנה כרגע כדי לא לשבור תאימות מלאה
                // אבל נוסיף את התאריך שם
                this.openTransactionModal(tx.type, tx); 
            },
            
            // פונקציה תומכת (הישנה, עם תוספת תאריך)
            openTransactionModal(type, existingData = null) {
                const cats = type==='income' ? ['תרומה כללית','מזומן','צק','אשראי'] : ['אוכל','ציוד','שיווק','אחר','תלושים/מתנות'];
                const studentsOpts = Object.values(Store.data.students).filter(s => s).map(s => {
                    const n = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                    return `<option value="${s.id}">${n}</option>`;
                }).join('');
                const donorsOpts = Object.values(Store.data.donors).filter(d => d).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                
                // ברירת מחדל לתאריך
                let defaultDate = new Date().toISOString().split('T')[0];
                if (existingData && existingData.date) {
                    defaultDate = new Date(existingData.date).toISOString().split('T')[0];
                }

                const html = `
                    <div class="space-y-4">
                        <div>
                             <label class="lbl">תאריך</label>
                             <input type="date" id="tx-date" value="${defaultDate}" class="input-field w-full">
                        </div>
                        <div id="amount-input-container">
                            <label class="lbl">סכום (או הערת טקסט)</label>
                            <input type="text" id="tx-amount" class="input-field w-full text-lg font-bold" value="${existingData?.amount || ''}" required>
                        </div>
                        <div>
                            <label class="lbl">קטגוריה</label>
                            <select id="tx-category" class="input-field w-full">
                                ${cats.map(c => `<option ${existingData?.category===c?'selected':''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border">
                            <label class="lbl">מקור ${type==='income'?'הכנסה':'הוצאה'}</label>
                            <div class="flex gap-4 mb-2">
                                <label><input type="radio" name="tx-src" value="none" ${(!existingData?.studentId && !existingData?.donorId)?'checked':''} onclick="document.getElementById('src-select-area').classList.add('hidden')"> כללי</label>
                                <label><input type="radio" name="tx-src" value="student" ${existingData?.studentId?'checked':''} onclick="document.getElementById('src-select-area').classList.remove('hidden'); document.getElementById('sel-student').classList.remove('hidden'); document.getElementById('sel-donor').classList.add('hidden')"> בחור</label>
                                <label><input type="radio" name="tx-src" value="donor" ${existingData?.donorId?'checked':''} onclick="document.getElementById('src-select-area').classList.remove('hidden'); document.getElementById('sel-student').classList.add('hidden'); document.getElementById('sel-donor').classList.remove('hidden')"> תורם</label>
                            </div>
                            <div id="src-select-area" class="${(existingData?.studentId || existingData?.donorId)?'':'hidden'}">
                                <select id="sel-student" class="input-field w-full ${existingData?.studentId?'':'hidden'}"><option value="">-- בחר בחור --</option>${studentsOpts}</select>
                                <select id="sel-donor" class="input-field w-full ${existingData?.donorId?'':'hidden'}"><option value="">-- בחר תורם --</option>${donorsOpts}</select>
                            </div>
                        </div>
                        <div>
                            <label class="lbl">תיאור / הערות</label>
                            <textarea id="tx-desc" class="input-field w-full h-20">${existingData?.desc || ''}</textarea>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="tx-purim" class="h-5 w-5 rounded text-indigo-600" ${(!existingData || existingData.isPurim)?'checked':''}>
                            <span class="text-sm font-bold">שייך לפורים?</span>
                        </div>
                    </div>
                `;
                
                Modal.renderRaw(existingData ? 'עריכת תנועה' : (type === 'income' ? 'הוספת הכנסה' : 'הוספת הוצאה'), html, () => {
                    const srcType = document.querySelector('input[name="tx-src"]:checked').value;
                    let studentId = null, donorId = null;
                    if(srcType === 'student') studentId = document.getElementById('sel-student').value;
                    if(srcType === 'donor') donorId = document.getElementById('sel-donor').value;
                    
                    let amount = document.getElementById('tx-amount').value;
                    if(!amount) return alert('חובה להזין סכום או ערך');
                    
                    let isNote = false;
                    if (!isNaN(parseFloat(amount))) amount = parseFloat(amount);
                    else isNote = true;
                    
                    // תאריך
                    const dVal = document.getElementById('tx-date').value;
                    const timestamp = dVal ? new Date(dVal + 'T12:00:00').getTime() : Date.now();

                    const id = existingData ? existingData.id : ('tx' + Date.now());
                    const newData = {
                        id, date: timestamp, type,
                        amount: amount,
                        category: document.getElementById('tx-category').value,
                        desc: document.getElementById('tx-desc').value,
                        isPurim: document.getElementById('tx-purim').checked,
                        studentId, donorId
                    };
                    
                    OfflineManager.write(`years/${Store.currentYear}/finance/${id}`, newData, existingData ? 'update' : 'set');
                    
                    // עדכון סטטיסטיקה (בסיסי, לא מדוייק לעריכה מורכבת אך מספיק לרוב המקרים)
                    if(OfflineManager.isOnline && !isNote && !existingData) {
                        db.ref(`years/${Store.currentYear}/stats/${type}`).transaction(curr => (curr || 0) + amount);
                    }
                    
                    Notify.show('נשמר בהצלחה', 'success');
                    Modal.close();
                });
                
                // שחזור ערכים אם יש
                if(existingData?.studentId) document.getElementById('sel-student').value = existingData.studentId;
                if(existingData?.donorId) document.getElementById('sel-donor').value = existingData.donorId;
            },

            quickAdd(type, entityId, entityType) {
                // גם כאן הוספה מהירה
                Modal.render('הוספה מהירה', [{id:'amt',l:'סכום',t:'text',r:true}], (v) => {
                    const id = 'tx' + Date.now();
                    let amount = v.amt;
                    let isNote = false;
                    if(!isNaN(parseFloat(amount))) amount = parseFloat(amount);
                    else isNote = true;

                    OfflineManager.write(`years/${Store.currentYear}/finance/${id}`, {
                        id, date: Date.now(), type, amount: amount,
                        category: 'תרומה מהירה',
                        [entityType === 'student' ? 'studentId' : 'donorId']: entityId,
                        isPurim: true 
                    });
                    if(OfflineManager.isOnline && !isNote) {
                        db.ref(`years/${Store.currentYear}/stats/${type}`).transaction(curr => (curr || 0) + amount);
                    }
                    if(type === 'income' && entityType === 'student' && !isNote) {
                        System.checkStudentProgress(entityId, amount);
                    }
                    Notify.show('תרומה נקלטה', 'success');
                });
            },
            deleteTx(id, type, amountVal) {
                if(confirm('למחוק תנועה זו?')) {
                    OfflineManager.write(`years/${Store.currentYear}/finance/${id}`, null, 'remove');
                    const amount = parseFloat(amountVal);
                    if(OfflineManager.isOnline && !isNaN(amount)) {
                        db.ref(`years/${Store.currentYear}/stats/${type}`).transaction(curr => (curr || 0) - amount);
                    }
                    Notify.show('תנועה נמחקה', 'info');
                }
            }
        };

        // --- 10. REPORTS & EXPORT ---
        const Reports = {
            searchEntity(v) {
                const res = document.getElementById('rep-entity-results');
                res.innerHTML = '';
                if(v.length < 2) { res.classList.add('hidden'); return; }
                res.classList.remove('hidden');
                // תיקון: הגנה מקריסה בעת חיפוש
                const students = Object.values(Store.data.students).filter(s => s).filter(s => {
                    const n = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                    return n && n.includes(v);
                }).slice(0,5);
                const donors = Object.values(Store.data.donors).filter(d => d && d.name && d.name.includes(v)).slice(0,5);
                students.forEach(s => {
                    const n = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                    res.innerHTML += `<div class="p-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="Reports.selectEntity('${s.id}','${n}','student')"><i class="fas fa-user-graduate text-blue-500"></i> ${n} <span class="text-xs text-gray-500">(בחור)</span></div>`;
                });
                donors.forEach(d => {
                    res.innerHTML += `<div class="p-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="Reports.selectEntity('${d.id}','${d.name}','donor')"><i class="fas fa-hand-holding-heart text-emerald-500"></i> ${d.name} <span class="text-xs text-gray-500">(תורם)</span></div>`;
                });
            },
            selectEntity(id, name, type) {
                document.getElementById('rep-entity-search').value = name;
                document.getElementById('rep-entity-id').value = id + '|' + type;
                document.getElementById('rep-entity-results').classList.add('hidden');
            },
            
            async getAllHistory(studentId = null) {
                const years = Object.keys(HEBREW_YEARS_MAPPING).map(k => HEBREW_YEARS_MAPPING[k]);
                const promises = years.map(y => db.ref(`years/${y}/finance`).once('value'));
                const snapshots = await Promise.all(promises);
                
                const allTx = [];
                // מיפוי: עבור כל שנה, נשמור את השנה שלה בכל עסקה
                snapshots.forEach((snap, idx) => {
                    const yearNum = years[idx];
                    const val = snap.val();
                    if(val) Object.values(val).forEach(t => {
                        // מציאת השנה העברית
                        const hYear = Object.keys(HEBREW_YEARS_MAPPING).find(key => HEBREW_YEARS_MAPPING[key] == yearNum);
                        t._year = hYear; // שמירת השנה לשימוש בטבלה
                        allTx.push(t);
                    });
                });
                
                // [7] תיקון יצוא דוח בחור: סינון גם לפי ID וגם הסרת הוצאות
                if (studentId) {
                    return allTx.filter(t => t.studentId === studentId && t.type === 'income');
                }
                return allTx; 
            },

            async generateIndividual(id, name) {
                Notify.show('מלקט נתונים מכל השנים...', 'info');
                const data = await this.getAllHistory(id);
                
                // תיקון מס' 2: אם אין נתונים, הורד תבנית ריקה עם כותרות
                const rows = data.length > 0 ? data.map(t => ({
                    "שנה": t._year || '',
                    "תאריך": System.toHebrewDate(t.date),
                    "קטגוריה": t.category,
                    "תיאור": t.desc,
                    "סכום": t.amount
                })) : [{ "שנה": "", "תאריך": "", "קטגוריה": "", "תיאור": "", "סכום": "" }];

                const ws = XLSX.utils.json_to_sheet(rows);
                if(!ws['!views']) ws['!views'] = [];
                // [7] תיקון אקסל RTL
                ws['!views'].push({ rightToLeft: true });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "דוח הכנסות אישי");
                wb.Workbook = { Views: [{ RTL: true }] };
                XLSX.writeFile(wb, `Income_Report_${name.replace(/ /g,'_')}.xlsx`);
                Notify.show('הדוח הורד בהצלחה', 'success');
            },

            // תיקון מס' 1: פתק להדפסה (גזירה) במקום PDF להורדה
            async printStudentSlip(id, name) {
                Notify.show('מכין דף בחור להדפסה...', 'info');
                const data = await this.getAllHistory(id);
                const s = Store.data.students[id];
                
                let total = 0;
                let rowsHtml = '';
                
                // מיון לפי תאריך
                data.sort((a,b) => b.date - a.date);
                
                data.forEach(t => {
                    const amt = isNaN(parseFloat(t.amount)) ? 0 : parseFloat(t.amount);
                    total += amt;
                    rowsHtml += `
                        <tr>
                            <td>${t.amount}</td>
                            <td>${t.desc || '-'}</td>
                            <td>${t.category}</td>
                            <td>${System.toHebrewDate(t.date)}</td>
                            <td>${t._year || ''}</td>
                        </tr>
                    `;
                });

                if (data.length === 0) {
                     rowsHtml = `<tr><td colspan="5" style="text-align:center; padding:10px;">אין נתונים</td></tr>`;
                }

                const html = `
                    <div class="student-slip">
                        <div class="student-slip-header">
                            <div>
                                <div class="student-slip-title">${name}</div>
                                <div>${s.grade || ''} | ת.ז: ${s.idNum || ''}</div>
                            </div>
                            <img src="1.JPG" alt="לוגו" class="student-slip-logo">
                        </div>
                        
                        <table class="print-table" style="width:100%;">
                            <thead>
                                <tr>
                                    <th>סכום</th>
                                    <th>תיאור</th>
                                    <th>קטגוריה</th>
                                    <th>תאריך</th>
                                    <th>שנה</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                            <tfoot>
                                <tr style="background:#e0f2fe; font-weight:bold;">
                                    <td>₪${total.toLocaleString()}</td>
                                    <td colspan="4">סה״כ לתשלום / זיכוי</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div style="margin-top:20px; font-size:10pt; color:#666;">
                             הופק בתאריך: ${System.toHebrewDate(new Date())}
                        </div>
                    </div>
                `;

                const pa = document.getElementById('print-area');
                pa.innerHTML = html;
                window.print();
            },

            generateStandard() {
                Notify.show('מייצא נתונים...', 'info');
                db.ref(`years/${Store.currentYear}/finance`).once('value', snap => {
                    const type = document.getElementById('rep-type').value;
                    const entVal = document.getElementById('rep-entity-id').value;
                    let data = Object.values(snap.val() || {});
                    if(type !== 'all') data = data.filter(t => t.type === type);
                    if(entVal) {
                        const [eid, etype] = entVal.split('|');
                        data = data.filter(t => (etype === 'student' ? t.studentId : t.donorId) === eid);
                    }
                    const rows = data.map(t => ({
                        "תאריך": System.toHebrewDate(t.date),
                        "סוג תנועה": t.type === 'income' ? 'הכנסה' : 'הוצאה',
                        "קטגוריה": t.category,
                        "תיאור / הערות": t.desc,
                        "סכום בש״ח": t.amount
                    }));
                    const ws = XLSX.utils.json_to_sheet(rows);
                    if(!ws['!views']) ws['!views'] = [];
                    ws['!views'].push({ rightToLeft: true });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "דוח כספי");
                    wb.Workbook = { Views: [{ RTL: true }] };
                    XLSX.writeFile(wb, `Report_${Store.currentYear}.xlsx`);
                    Notify.show('הקובץ מוכן!', 'success');
                });
            },
            
            // --- עורך דוחות חדש ומתקדם ---
            editorState: {
                bgImg: null,
                bgOpacity: 0.2,
                title: 'דוח תצוגה משוקלל',
                images: [],
                zoom: 0.6,
                headers: ['שם הבחור', 'יעד אישי', 'סה״כ לתצוגה', 'אחוז מיעד', 'מתנה'],
                colsVisible: [true, true, true, true, true],
                headersOrder: [0, 1, 2, 3, 4], // תיקון מס' 3: סדר עמודות
                orientation: 'landscape',
                rowsPerPage: 22 // [4] ברירת מחדל
            },
            
            // [4] פונקציה לעדכון שורות לדף
            setRowsPerPage(val) {
                this.editorState.rowsPerPage = parseInt(val) || 20;
                this.renderEditorCanvas();
            },
            
            openEditor() {
                document.getElementById('report-editor-screen').classList.remove('hidden-screen');
                this.renderHeadersEditor();
                this.renderEditorCanvas();
            },
            closeEditor() {
                document.getElementById('report-editor-screen').classList.add('hidden-screen');
            },

            // תיקון מס' 3: עריכת כותרות ושינוי סדר/ביטול עמודות
            renderHeadersEditor() {
                const container = document.getElementById('editor-headers-container');
                container.innerHTML = '';
                
                this.editorState.headersOrder.forEach((originalIndex, displayOrder) => {
                    const val = this.editorState.headers[originalIndex];
                    const isVis = this.editorState.colsVisible[originalIndex];
                    
                    const el = document.createElement('div');
                    el.className = "flex items-center gap-2 bg-slate-50 p-1 border rounded text-xs";
                    el.innerHTML = `
                         <button onclick="Reports.moveHeader(${displayOrder}, -1)" class="text-gray-400 hover:text-blue-500"><i class="fas fa-arrow-up"></i></button>
                         <button onclick="Reports.moveHeader(${displayOrder}, 1)" class="text-gray-400 hover:text-blue-500"><i class="fas fa-arrow-down"></i></button>
                         <input type="checkbox" ${isVis ? 'checked' : ''} onchange="Reports.toggleCol(${originalIndex}, this.checked)">
                         <input type="text" value="${val}" oninput="Reports.updateHeader(${originalIndex}, this.value)" class="flex-1 bg-transparent outline-none">
                    `;
                    container.appendChild(el);
                });
            },
            moveHeader(currIdx, direction) {
                const newIdx = currIdx + direction;
                const arr = this.editorState.headersOrder;
                if (newIdx < 0 || newIdx >= arr.length) return;
                
                // Swap
                const temp = arr[currIdx];
                arr[currIdx] = arr[newIdx];
                arr[newIdx] = temp;
                
                this.renderHeadersEditor();
                this.renderEditorCanvas();
            },
            
            async renderEditorCanvas() {
                const container = document.getElementById('report-canvas-container');
                container.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-400">טוען נתונים...</div>';
                
                const [finSnap, grpSnap] = await Promise.all([
                    db.ref(`years/${Store.currentYear}/finance`).once('value'),
                    db.ref(`years/${Store.currentYear}/groups`).once('value')
                ]);

                const finances = Object.values(finSnap.val() || {});
                const groupsData = grpSnap.val() || {};
                const config = Store.data.config;
                // Group Discounts per Time
                const discounts = config.groupDiscounts || {};
                
                // Bonus Tiers logic
                const bonusTiers = config.bonusTiers || [];

                let list = [];

                // תיקון קריטי: הגנה מקריסה בלולאה
                Object.values(Store.data.students).filter(s => s && !s.isArchived).forEach(student => {
                    let actual = 0;
                    let extra = 0;
                    // הכנסות בפועל
                    finances.filter(f => f.studentId === student.id && f.type === 'income').forEach(f => {
                         if (!isNaN(parseFloat(f.amount))) actual += parseFloat(f.amount);
                    });

                    // חישוב הנחות קבוצה לפי זמנים
                    Object.keys(groupsData).forEach(day => {
                        Object.values(groupsData[day]).forEach(g => {
                            if((g.members||[]).some(m => m.id === student.id)) {
                                const disc = parseInt(discounts[day] || 0);
                                if (disc > 0) extra += disc;
                            }
                        });
                    });

                    // תיקון: בונוס לפי תרומה של תורם (מדרגות טווח)
                    const donorsBrought = Object.values(Store.data.donors).filter(d => d && d.referrerId === student.id);
                    donorsBrought.forEach(d => {
                        let donorTotal = 0;
                        finances.filter(f => f.donorId === d.id && f.type === 'income').forEach(f => {
                            if (!isNaN(parseFloat(f.amount))) donorTotal += parseFloat(f.amount);
                        });
                        
                        // בדיקת הטווח
                        // מחפש את המדרגה שהסכום נמצא בתוכה
                        const tier = bonusTiers.find(t => donorTotal >= t.rangeMin && donorTotal <= t.rangeMax);
                        if (tier) {
                            extra += (donorTotal * (tier.percent / 100));
                        }
                    });
                    
                    // בונוס קבוע (Referral Goal Tier)
                    donorsBrought.forEach(d => {
                         let donorTotal = 0;
                         finances.filter(f => f.donorId === d.id && f.type === 'income').forEach(f => donorTotal += (isNaN(f.amount)?0:parseFloat(f.amount)));
                         const tiers = config.tiers || [];
                         const tier = tiers.sort((a,b) => b.amount - a.amount).find(t => donorTotal >= t.amount);
                         if (tier && !isNaN(parseInt(tier.gift))) extra += parseInt(tier.gift);
                    });

                    const yData = (Store.data.yearData[Store.currentYear]?.students || {})[student.id] || {};
                    const goal = yData.personalGoal || config.baseStudentGoal || 0;
                    const name = student.firstName && student.lastName ? `${student.firstName} ${student.lastName}` : student.name;
                    const totalDisplay = Math.round(actual + extra);

                    const studentTiers = config.studentTiers || [];
                    const rewardTier = studentTiers.sort((a,b) => b.amount - a.amount).find(t => totalDisplay >= t.amount);
                    const reward = rewardTier ? rewardTier.reward : '-';

                    if(totalDisplay > 0 || goal > 0) {
                        list.push({name, goal, totalDisplay, pct: goal>0 ? Math.round((totalDisplay/goal)*100) : 0, reward});
                    }
                });

                list.sort((a,b) => b.totalDisplay - a.totalDisplay);

                // --- Pagination Logic (Orientation Aware) ---
                // [4] שימוש בכמות שורות דינמית
                const ROWS_PER_PAGE = this.editorState.rowsPerPage || (this.editorState.orientation

=== 'landscape' ? 22 : 35);
const chunks = [];
for (let i = 0; i < list.length; i += ROWS_PER_PAGE) {
chunks.push(list.slice(i, i + ROWS_PER_PAGE));
}
if (chunks.length === 0) chunks.push([]); 

            container.innerHTML = ''; 

            const bgStyle = this.editorState.bgImg ? `background-image: url('${this.editorState.bgImg}');` : '';
            const h = this.editorState.headers;
            const pageClass = this.editorState.orientation === 'landscape' ? 'page-landscape' : 'page-portrait';
            
            // Build dynamic header row based on order
            let tableHeaderHTML = '<tr class="bg-slate-200">';
            this.editorState.headersOrder.forEach(idx => {
                if (this.editorState.colsVisible[idx]) {
                     tableHeaderHTML += `<th class="border border-black p-1 text-center">${h[idx]}</th>`;
                }
            });
            tableHeaderHTML += '</tr>';

            chunks.forEach((chunk, pageIdx) => {
                let pageHtml = `
                <div class="report-page ${pageClass} editor-print-mode" style="transform: scale(${this.editorState.zoom});">
                    <div class="print-layer-bg bg-contain bg-center bg-no-repeat" style="${bgStyle} opacity: ${this.editorState.bgOpacity};"></div>
                    
                    <div class="print-layer-content p-10 h-full flex flex-col">
                        <div class="print-header mb-4">
                            <img src="1.JPG" alt="לוגו" style="height: 60px;">
                            <h1 class="text-2xl font-black text-center" id="canvas-title">${this.editorState.title}</h1>
                            <h3 class="text-center">שנה: ${Store.currentYear} | עמוד ${pageIdx+1} מתוך ${chunks.length}</h3>
                        </div>
                        
                        <div class="flex-1">
                             <table class="w-full text-right border-collapse text-sm">
                                <thead>${tableHeaderHTML}</thead>
                                <tbody>
                                    ${chunk.map(item => {
                                        // Dynamic cells based on order
                                        let rowHtml = '<tr class="bg-white/80">';
                                        this.editorState.headersOrder.forEach(idx => {
                                            if (this.editorState.colsVisible[idx]) {
                                                let val = '';
                                                if (idx === 0) val = `<span class="font-bold">${item.name}</span>`;
                                                if (idx === 1) val = item.goal;
                                                if (idx === 2) val = `<span class="font-bold">${item.totalDisplay}</span>`;
                                                if (idx === 3) val = `${item.pct}%`;
                                                if (idx === 4) val = `<span class="text-xs">${item.reward}</span>`;
                                                rowHtml += `<td class="border border-black p-1 text-center">${val}</td>`;
                                            }
                                        });
                                        rowHtml += '</tr>';
                                        return rowHtml;
                                    }).join('')}
                                </tbody>
                             </table>
                        </div>
                    </div>
                    
                    <div class="print-layer-decor absolute inset-0 overflow-hidden pointer-events-auto" id="decor-layer-${pageIdx}">
                        <!-- Images go here -->
                    </div>
                </div>`;
                
                const pageEl = document.createElement('div');
                pageEl.innerHTML = pageHtml;
                container.appendChild(pageEl.firstElementChild);
            });
        },
        
        updateTitle(val) {
            this.editorState.title = val;
            const els = document.querySelectorAll('#canvas-title');
            els.forEach(el => el.innerText = val);
        },

        updateHeader(originalIdx, val) {
            this.editorState.headers[originalIdx] = val;
            this.renderEditorCanvas();
        },
        
        toggleCol(originalIdx, isChecked) {
            this.editorState.colsVisible[originalIdx] = isChecked;
            this.renderEditorCanvas();
        },
        
        updateBackground(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.editorState.bgImg = e.target.result;
                    // עדכון מיידי של כל הדפים
                    document.querySelectorAll('.print-layer-bg').forEach(el => el.style.backgroundImage = `url('${e.target.result}')`);
                };
                reader.readAsDataURL(input.files[0]);
            }
        },
        
        updateBgOpacity(val) {
            this.editorState.bgOpacity = val;
            document.querySelectorAll('.print-layer-bg').forEach(el => el.style.opacity = val);
        },
        
        setZoom(val) {
            this.editorState.zoom = val;
            document.querySelectorAll('.report-page').forEach(el => el.style.transform = `scale(${val})`);
        },
        
        setOrientation(val) {
            this.editorState.orientation = val;
            // עדכון CSS כללי לדף ההדפסה
            const styleEl = document.getElementById('dynamic-print-style') || document.createElement('style');
            styleEl.id = 'dynamic-print-style';
            // תיקון מס' 5: עדכון שוליים והגדרת גודל דף
            styleEl.innerHTML = `@media print { @page { size: A4 ${val}; margin: 0; } body { padding-bottom: 50px; } }`;
            document.head.appendChild(styleEl);
            this.renderEditorCanvas();
        },
        
        addDecorImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgId = 'decor-' + Date.now();
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'draggable-item';
                    imgContainer.id = imgId;
                    imgContainer.style.top = '100px';
                    imgContainer.style.left = '100px';
                    imgContainer.style.width = '150px';
                    imgContainer.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-contain pointer-events-none">
                        <div class="resize-handle"></div>
                    `;
                    
                    // Add to first page only by default
                    const firstPageLayer = document.querySelector('[id^="decor-layer-"]');
                    if (firstPageLayer) {
                        firstPageLayer.appendChild(imgContainer);
                        this.makeDraggable(imgContainer);
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        },
        
        makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let isResizing = false;
            
            elmnt.onmousedown = function(e) {
                if (e.target.classList.contains('resize-handle')) return; 
                document.querySelectorAll('.draggable-item').forEach(el => el.classList.remove('selected'));
                elmnt.classList.add('selected');
                dragMouseDown(e);
            };

            const resizeHandle = elmnt.querySelector('.resize-handle');
            resizeHandle.onmousedown = function(e) {
                e.stopPropagation();
                isResizing = true;
                e.preventDefault();
                let startX = e.clientX;
                let startWidth = parseInt(document.defaultView.getComputedStyle(elmnt).width, 10);
                
                document.onmouseup = function() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                    isResizing = false;
                };
                
                document.onmousemove = function(e) {
                    let newW = startWidth + (e.clientX - startX) / Reports.editorState.zoom; 
                    elmnt.style.width = newW + 'px';
                };
            };

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                const zoom = Reports.editorState.zoom || 1;
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2 / zoom) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1 / zoom) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        },
        
        printEditor() {
            const container = document.getElementById('report-canvas-container');
            const printArea = document.getElementById('print-area');
            
            const clones = [];
            container.querySelectorAll('.report-page').forEach(page => {
                 const c = page.cloneNode(true);
                 c.style.transform = 'none'; // Reset zoom for print
                 c.style.marginBottom = '0';
                 
                 // Clean UI
                 c.querySelectorAll('.draggable-item').forEach(el => {
                    el.classList.remove('selected');
                    el.style.border = 'none';
                    const handle = el.querySelector('.resize-handle');
                    if(handle) handle.style.display = 'none';
                 });
                 clones.push(c);
            });
            
            printArea.innerHTML = '';
            clones.forEach(c => printArea.appendChild(c));
            
            window.print();
        }
    };

    // --- 11. ROBUST EXCEL IMPORT MANAGER ---
    const Importer = {
        currentType: null,
        fileData: null,
        init(type) {
            if (type === 'students') {
                // תפריט בחירה לסוג יבוא בחורים
                const html = `
                    <div class="space-y-4">
                        <button onclick="Importer.startImport('students_new')" class="w-full bg-blue-50 p-4 rounded-xl border border-blue-200 hover:bg-blue-100 flex items-center gap-4 text-right">
                            <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center shrink-0"><i class="fas fa-user-plus"></i></div>
                            <div>
                                <div class="font-bold text-blue-900">יבוא בחורים חדשים</div>
                                <div class="text-xs text-blue-700">הוספת בחורים למאגר המערכת מקובץ אקסל</div>
                            </div>
                        </button>
                        <button onclick="Importer.startImport('students_donations')" class="w-full bg-emerald-50 p-4 rounded-xl border border-emerald-200 hover:bg-emerald-100 flex items-center gap-4 text-right">
                            <div class="bg-emerald-500 text-white w-10 h-10 rounded-full flex items-center justify-center shrink-0"><i class="fas fa-hand-holding-usd"></i></div>
                            <div>
                                <div class="font-bold text-emerald-900">יבוא תרומות לבחורים</div>
                                <div class="text-xs text-emerald-700">קליטת סכומי תרומה שהביאו בחורים (לפי שנים)</div>
                            </div>
                        </button>
                    </div>
                `;
                Modal.renderRaw('בחר סוג יבוא', html, () => {});
                // הסתרת כפתורי המודל הרגילים כי זה תפריט בחירה
                document.querySelector('#modal-form .btn-primary').parentElement.style.display = 'none';
            } else {
                this.startImport(type);
            }
        },
        startImport(type) {
            this.currentType = type; // students_new, students_donations, donors
            Modal.close();
            setTimeout(() => {
                const input = document.getElementById('excel-upload-input');
                input.value = '';
                input.click();
            }, 300);
        },
        handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                this.fileData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
                if (this.fileData.length === 0) { Notify.show('הקובץ ריק', 'error'); return; }
                this.openMappingModal();
            };
            reader.readAsArrayBuffer(file);
        },
        openMappingModal() {
            const excelHeaders = Object.keys(this.fileData[0]);
            let systemFields = [];
            let isDonationImport = false;

            if (this.currentType === 'students_new') {
                systemFields = PREDEFINED_FIELDS.students;
            } else if (this.currentType === 'donors') {
                systemFields = PREDEFINED_FIELDS.donors;
                isDonationImport = true; 
            } else if (this.currentType === 'students_donations') {
                systemFields = [
                    {k:'firstName', l:'שם פרטי', t:'text'}, 
                    {k:'lastName', l:'שם משפחה', t:'text'},
                    {k:'fullName', l:'שם מלא (עמודה אחת)', t:'text'}
                ];
                isDonationImport = true;
            }
            
            const customDefs = Store.data.config.customFieldsDefs || {};
            const allFields = [...systemFields];
            if (this.currentType !== 'students_donations') {
                Object.entries(customDefs).forEach(([k, def]) => {
                     if(!allFields.find(f => f.k === k)) allFields.push({k:k, l:def.l});
                });
            }

            let html = `<div dir="rtl" class="text-right">`;
            html += `<div class="bg-blue-50 p-4 rounded mb-4 text-sm text-blue-800">נמצאו ${this.fileData.length} רשומות. אנא התאם את עמודות האקסל לשדות המערכת:</div>`;
            html += `<div class="grid grid-cols-2 gap-4 font-bold border-b pb-2 mb-2"><div>שדה במערכת</div><div>עמודה באקסל</div></div>`;
            
            allFields.forEach(field => {
                let options = `<option value="">-- אל תייבא --</option>`;
                excelHeaders.forEach(header => {
                    const isMatch = header.includes(field.l) || field.l.includes(header);
                    options += `<option value="${header}" ${isMatch ? 'selected' : ''}>${header}</option>`;
                });
                
                html += `
                <div class="grid grid-cols-2 gap-4 items-center mb-2">
                    <div class="text-sm">${field.l} ${field.r ? '*' : ''}</div>
                    <select id="map-${field.k}" class="border rounded p-1 w-full text-sm bg-white">${options}</select>
                </div>`;
            });

            if (isDonationImport) {
                html += `<div class="mt-4 pt-4 border-t border-dashed">
                    <h4 class="font-bold mb-2 text-indigo-700">יבוא תרומות / היסטוריה</h4>
                    <p class="text-xs text-gray-500 mb-2">בחר עמודות המכילות סכומים עבור כל שנה.</p>
                    <div id="history-map-container">
                `;
                
                const years = Object.keys(HEBREW_YEARS_MAPPING);
                years.forEach(hYear => {
                    const numYear = HEBREW_YEARS_MAPPING[hYear];
                    let options = `<option value="">-- ללא יבוא --</option>`;
                    excelHeaders.forEach(header => {
                        const isMatch = header.includes(hYear) || header.includes(hYear.replace(/['"]/g, ''));
                        options += `<option value="${header}" ${isMatch ? 'selected' : ''}>${header}</option>`;
                    });
                    html += `
                    <div class="grid grid-cols-2 gap-4 items-center mb-1">
                        <div class="text-sm">תרומות ${hYear} (${numYear})</div>
                        <select id="map-finance-${numYear}" class="border rounded p-1 w-full text-sm bg-gray-50 history-selector" data-year="${numYear}">${options}</select>
                    </div>`;
                });
                html += `</div></div>`;
            }
            html += `</div>`; 

            const customBtn = `<button onclick="Importer.executeImport()" class="w-full bg-green-600 text-white py-3 rounded-xl
font-bold mt-4 shadow-lg hover:bg-green-700">בצע יבוא</button>`;
code
Code
Modal.renderRaw(`יבוא נתונים מאקסל`, html + customBtn, () => {});
            document.querySelector('#modal-form .btn-primary').parentElement.style.display = 'none';
        },
        executeImport() {
            const mapping = {};
            const historyMapping = {};
            
            let fieldsToCheck = [];
            if (this.currentType === 'students_new') fieldsToCheck = PREDEFINED_FIELDS.students;
            else if (this.currentType === 'donors') fieldsToCheck = PREDEFINED_FIELDS.donors;
            else fieldsToCheck = [{k:'firstName'},{k:'lastName'},{k:'fullName'}];

            if (this.currentType !== 'students_donations') {
                 const customDefs = Store.data.config.customFieldsDefs || {};
                 Object.keys(customDefs).forEach(k => fieldsToCheck.push({k}));
            }

            fieldsToCheck.forEach(f => {
                const el = document.getElementById(`map-${f.k}`);
                if(el && el.value) mapping[f.k] = el.value;
            });

            document.querySelectorAll('.history-selector').forEach(el => {
                if (el.value) historyMapping[el.dataset.year] = el.value;
            });

            if (this.currentType === 'students_donations' && !mapping.fullName && (!mapping.firstName || !mapping.lastName)) {
                Notify.show('חובה למפות שם מלא או שם פרטי+משפחה לזיהוי הבחור', 'error');
                return;
            }

            Notify.show('מעבד נתונים...', 'info');
            
            const dbPath = (this.currentType === 'donors') ? 'global/donors' : 'global/students';
            const revYearMap = {};
            Object.keys(HEBREW_YEARS_MAPPING).forEach(k => revYearMap[HEBREW_YEARS_MAPPING[k]] = k);

            db.ref(dbPath).once('value', snapshot => {
                const existingData = snapshot.val() || {};
                const nameMap = {};
                Object.values(existingData).forEach(item => {
                    if (item.name) nameMap[item.name.trim()] = item.id;
                    // [8] תיקון קריטי: הגנה על split מפני undefined כדי למנוע קריסה בקונסול
                    if (item.name) {
                        const reversedName = item.name.split(' ').reverse().join(' ');
                        nameMap[reversedName] = item.id;
                    }
                });

                let countNew = 0;
                let countFinance = 0;
                
                const updates = {};
                const financeUpdates = {};

                this.fileData.forEach(row => {
                    const tempObj = {};
                    Object.keys(mapping).forEach(sysKey => {
                        tempObj[sysKey] = row[mapping[sysKey]];
                    });
                    
                    let fullName = tempObj.fullName;
                    if (!fullName && (tempObj.firstName || tempObj.lastName)) {
                        fullName = `${tempObj.firstName || ''} ${tempObj.lastName || ''}`.trim();
                    }
                    
                    if (!fullName) return; 

                    let entityId = nameMap[fullName];
                    
                    if (this.currentType !== 'students_donations') {
                        if (!entityId) {
                            entityId = db.ref(dbPath).push().key;
                            const newObj = { id: entityId, ...tempObj, name: fullName };
                            if (this.currentType === 'students_new') newObj.lastUpdatedYear = Store.currentYear;
                            else newObj.joinYear = Store.currentYear; 
                            
                            updates[`${dbPath}/${entityId}`] = newObj;
                            nameMap[fullName] = entityId; 
                            countNew++;
                        }
                    } else {
                        if (!entityId) return; 
                    }

                    if (entityId) {
                        Object.entries(historyMapping).forEach(([year, colHeader]) => {
                            let val = row[colHeader];
                            if (!val) return;
                            
                            const txId = 'imp' + Date.now() + Math.random().toString(36).substr(2, 5);
                            const hebrewYear = revYearMap[year] || year;
                            
                            const tx = {
                                id: txId,
                                date: new Date(parseInt(year) - 3760, 2, 14).getTime(),
                                type: 'income',
                                category: 'יבוא אקסל',
                                desc: 'היסטוריה/יבוא',
                                amount: val,
                                isPurim: true
                            };
                            
                            if (this.currentType === 'donors') tx.donorId = entityId;
                            else tx.studentId = entityId;

                            financeUpdates[`years/${hebrewYear}/finance/${txId}`] = tx;
                            countFinance++;
                        });
                    }
                });

                const promises = [];
                if (Object.keys(updates).length > 0) promises.push(db.ref().update(updates));
                if (Object.keys(financeUpdates).length > 0) promises.push(db.ref().update(financeUpdates));

                Promise.all(promises).then(() => {
                    Modal.close();
                    document.querySelector('#modal-form .btn-primary').parentElement.style.display = 'flex';
                    
                    let msg = 'הפעולה הסתיימה. ';
                    if (countNew > 0) msg += `נוספו ${countNew} רשומות חדשות. `;
                    if (countFinance > 0) msg += `נקלטו ${countFinance} תרומות.`;
                    
                    if (countNew === 0 && countFinance === 0) msg = 'לא בוצעו שינויים (לא נמצאו התאמות או נתונים חדשים).';
                    
                    Notify.show(msg, countFinance > 0 ? 'success' : 'info');
                    
                    if (this.currentType.includes('students')) Students.loadMore(true);
                    else Donors.loadMore(true);
                    
                    if (countFinance > 0) Finance.loadMore(true);

                }).catch(err => {
                    console.error(err);
                    Notify.show('שגיאה בשמירת הנתונים', 'error');
                });
            });
        }
    };

   const Settings = {
    init() {
        this.renderFieldsEditor();
        this.renderGoals();
        this.renderStudentRewards();
        this.renderBonusTiers();
        this.renderVouchers(); // תיקון מס' 4: טעינת תלושים
        if(Store.data.config) {
            document.getElementById('conf-global-goal').value = Store.data.config.globalGoal || '';
            document.getElementById('conf-base-student-goal').value = Store.data.config.baseStudentGoal || '';
            document.getElementById('conf-enable-ai').checked = Store.data.config.enableAI || false;
            
            const gd = Store.data.config.groupDiscounts || {};
            document.getElementById('conf-disc-night14').value = gd.night14 || 0;
            document.getElementById('conf-disc-day14').value = gd.day14 || 0;
            document.getElementById('conf-disc-day15').value = gd.day15 || 0;
        }
    },
    save(key, val) { OfflineManager.write(`settings/${key}`, parseInt(val)); Notify.show('הגדרה נשמרה', 'success'); },
    saveGroupDiscount(key, val) {
        OfflineManager.write(`settings/groupDiscounts/${key}`, parseInt(val));
    },
    
    // User Management - DB based
    createUser() {
        const email = document.getElementById('new-user-email').value;
        const pass = document.getElementById('new-user-pass').value;
        const role = document.getElementById('new-user-role').value;
        if(!email || !pass) return alert('נא למלא אימייל וסיסמה');
        
        try {
            const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
            secondaryApp.auth().createUserWithEmailAndPassword(email, pass).then(cred => {
                db.ref(`users/${cred.user.uid}`).set({
                    email: email,
                    role: role
                });
                secondaryApp.auth().signOut();
                secondaryApp.delete(); 
                Notify.show('משתמש נוצר בהצלחה!', 'success');
                document.getElementById('new-user-email').value = '';
                document.getElementById('new-user-pass').value = '';
            }).catch(err => {
                alert("שגיאה ביצירת משתמש: " + err.message);
                if(secondaryApp) secondaryApp.delete();
            });
        } catch(e) { console.error(e); }
    },
    
    loadUsersList() {
        db.ref('users').once('value', snap => {
            const users = snap.val() || {};
            const container = document.getElementById('users-list-container');
            container.innerHTML = '';
            Object.entries(users).forEach(([uid, u]) => {
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm">
                        <div><span class="font-bold">${u.email}</span> (${u.role})</div>
                        <div class="flex gap-2">
                            <button onclick="Settings.sendPasswordReset('${u.email}')" class="text-orange-500 hover:text-orange-700 text-xs font-bold" title="שלח למשתמש מייל לאיפוס/שינוי סיסמה">שנה סיסמה (מייל)</button>
                            <button onclick="Settings.updateUserRole('${uid}', '${u.role === 'admin' ? 'user' : 'admin'}')" class="text-blue-500 hover:underline text-xs">שנה תפקיד</button>
                            <button onclick="Settings.deleteUserDB('${uid}')" class="text-red-500 hover:text-red-700 text-xs font-bold">מחק גישה</button>
                        </div>
                    </div>
                `;
            });
        });
    },
    
    // פונקציה חדשה לאיפוס סיסמה (שינוי סיסמה - תכונה 6)
    // הערה: מטעמי אבטחה ב-Firebase, לא ניתן לראות סיסמאות. הדרך המאובטחת היא לשלוח מייל איפוס.
    sendPasswordReset(email) {
        if(confirm(`האם לשלוח ל-${email} מייל לשינוי סיסמה? זו הדרך המאובטחת לשנות סיסמה למשתמש קיים.`)) {
            auth.sendPasswordResetEmail(email).then(() => {
                Notify.show('מייל לשינוי סיסמה נשלח בהצלחה', 'success');
            }).catch(error => {
                Notify.show('שגיאה בשליחת מייל: ' + error.message, 'error');
            });
        }
    },
    
    updateUserRole(uid, newRole) {
        if(confirm('לשנות את תפקיד המשתמש?')) {
            db.ref(`users/${uid}/role`).set(newRole).then(() => {
                this.loadUsersList();
                Notify.show('תפקיד עודכן', 'success');
            });
        }
    },
    
    deleteUserDB(uid) {
        if(confirm('זהירות: פעולה זו תסיר את גישת המשתמש מהמערכת (לא מוחק מה-Auth). האם להמשיך?')) {
            db.ref(`users/${uid}`).remove().then(() => {
                this.loadUsersList();
                Notify.show('גישה הוסרה', 'info');
            });
        }
    },
    
    // --- תיקון: ייצוא וייבוא JSON למניעת כפילויות ---
    exportDataAsJSON() {
        Notify.show('מכין גיבוי מלא...', 'info');
        db.ref('/').once('value', snap => {
            const fullData = snap.val();
            const dataStr = JSON.stringify(fullData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_ezer_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            Notify.show('הגיבוי ירד למחשב', 'success');
        });
    },
    
    importDataFromJSON(input) {
        const file = input.files[0];
        if (!file) return;
        
        if(!confirm('אזהרה: פעולה זו תייבא נתונים מהקובץ. המערכת תוסיף רק נתונים חסרים ולא תדרוס נתונים קיימים. להמשיך?')) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                Notify.show('מנתח נתונים...', 'info');
                
                db.ref('/').once('value', snap => {
                    const currentData = snap.val() || {};
                    const updates = {};
                    let addedCount = 0;
                    
                    // Recursive merge function
                    function processMerge(path, incoming, existing) {
                        if (typeof incoming === 'object' && incoming !== null) {
                            Object.keys(incoming).forEach(key => {
                                const newPath = path ? `${path}/${key}` : key;
                                if (!existing || !existing.hasOwnProperty(key)) {
                                    // New data found
                                    updates[newPath] = incoming[key];
                                    addedCount++;
                                } else if (typeof incoming[key] === 'object' && incoming[key] !== null) {
                                    // Deep dive
                                    processMerge(newPath, incoming[key], existing[key]);
                                }
                            });
                        }
                    }
                    
                    processMerge('', importedData, currentData);
                    
                    if (Object.keys(updates).length > 0) {
                        db.ref().update(updates).then(() => {
                            Notify.show(`השחזור הצליח! נוספו ${addedCount} רשומות חדשות.`, 'success');
                            setTimeout(() => location.reload(), 2000);
                        }).catch(err => {
                            console.error(err);
                            Notify.show('שגיאה בשמירת הנתונים', 'error');
                        });
                    } else {
                        Notify.show('לא נמצאו נתונים חדשים לייבוא.', 'info');
                    }
                });
            } catch(err) {
                alert('קובץ לא תקין');
            }
        };
        reader.readAsText(file);
    },

    syncYears() {
        if(!confirm('פעולה זו תקדם את כל הבחורים בשיעור אחד. בוגרי קיבוץ ח\' יועברו לרשימת התורמים. האם להמשיך?')) return;
        Notify.show('מבצע סנכרון...', 'info');
        db.ref('global/students').once('value', s => {
            const allStudents = s.val() || {};
            const updates = {};
            const newDonors = {};
            let movedCount = 0;
            Object.values(allStudents).forEach(st => {
                const currentGrade = st.grade;
                if(!currentGrade) return;
                const idx = SHIURIM_ORDER.indexOf(currentGrade);
                if(idx === -1) return; 
                if(idx < SHIURIM_ORDER.length - 1) {
                    updates[`global/students/${st.id}/grade`] = SHIURIM_ORDER[idx + 1];
                } else {
                    movedCount++;
                    updates[`global/students/${st.id}`] = null; 
                    const n = st.firstName && st.lastName ? `${st.firstName} ${st.lastName}` : (st.name || '');
                    newDonors[`global/donors/${st.id}`] = {
                        id: st.id,
                        name: n,
                        phone: st.phone,
                        address: st.city || '',
                        joinYear: Store.currentYear,
                        notes: 'בוגר (הועבר אוטומטית)',
                        isAlumni: true
                    };
                }
            });
            db.ref().update(updates).then(() => {
                 if(movedCount > 0) db.ref().update(newDonors);
                 Notify.show(`סנכרון הושלם. ${movedCount} בוגרים הועברו לתורמים.`, 'success');
                 setTimeout(() => location.reload(), 2000);
            });
        });
    },
    renderFieldsEditor() {
        const type = document.getElementById('settings-field-type').value;
        const list = document.getElementById('settings-active-fields');
        const customList = document.getElementById('settings-custom-list');
        const select = document.getElementById('settings-predefined-field');
        
        const defs = PREDEFINED_FIELDS[type] || [];
        select.innerHTML = '';
        defs.forEach(d => select.innerHTML += `<option value="${d.k}">${d.l}</option>`);
        
        const customDefs = Store.data.config.customFieldsDefs || {};
        customList.innerHTML = '';
        Object.entries(customDefs).forEach(([k, def]) => {
             select.innerHTML += `<option value="${k}" class="text-indigo-600">${def.l} (מותאם)</option>`;
             customList.innerHTML += `
                <div class="flex justify-between items-center text-xs bg-gray-50 p-1 border rounded">
                    <span>${def.l} (${k})</span>
                    <button onclick="Settings.deleteCustomFieldDef('${k}')" class="text-red-500 hover:text-red-700 px-2" title="מחק שדה מהמערכת"><i class="fas fa-trash"></i></button>
                </div>
             `;
        });
        if(Object.keys(customDefs).length === 0) customList.innerHTML = '<span class="text-gray-400 text-xs">אין שדות מותאמים</span>';
        
        const active = (Store.data.config.fields || {})[type] || DEFAULT_ACTIVE_FIELDS[type];
        list.innerHTML = '';
        active.forEach(k => {
            let def = defs.find(d => d.k === k);
            if (!def && customDefs[k]) def = {l: customDefs[k].l};
            const label = def ? def.l : k;
            list.innerHTML += `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded border text-sm">
                    <span>${label}</span>
                    <button onclick="Settings.removeField('${type}','${k}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </div>
            `;
        });
    },
    addField() {
        const type = document.getElementById('settings-field-type').value;
        const key = document.getElementById('settings-predefined-field').value;
        const active = (Store.data.config.fields || {})[type] || [];
        if(!active.includes(key)) {
            active.push(key);
            OfflineManager.write(`settings/fields/${type}`, active);
            if(!Store.data.config.fields) Store.data.config.fields = {};
            Store.data.config.fields[type] = active;
            this.renderFieldsEditor();
        }
    },
    addCustomField() {
        const key = document.getElementById('custom-field-key').value.trim();
        const label = document.getElementById('custom-field-label').value.trim();
        if(!key || !label) return alert('חובה למלא מזהה (באנגלית) ותווית (בעברית)');
        const defs = Store.data.config.customFieldsDefs || {};
        defs[key] = { l: label };
        OfflineManager.write(`settings/customFieldsDefs`, defs);
        Store.data.config.customFieldsDefs = defs;
        const type = document.getElementById('settings-field-type').value;
        const active = (Store.data.config.fields || {})[type] || [];
        if(!active.includes(key)) {
            active.push(key);
            OfflineManager.write(`settings/fields/${type}`, active);
            if(!Store.data.config.fields) Store.data.config.fields = {};
            Store.data.config.fields[type] = active;
        }
        document.getElementById('custom-field-key').value = '';
        document.getElementById('custom-field-label').value = '';
        Notify.show('שדה מותאם נוסף בהצלחה', 'success');
        this.renderFieldsEditor();
    },
    deleteCustomFieldDef(key) {
        if(!confirm('האם אתה בטוח שברצונך למחוק שדה זה מהמערכת? פעולה זו תסיר אותו מהקבוצות בשנה הנוכחית.')) return;
        const defs = Store.data.config.customFieldsDefs || {};
        delete defs[key];
        OfflineManager.write('settings/customFieldsDefs', defs);
        Store.data.config.customFieldsDefs = defs;
        
        ['students', 'donors'].forEach(type => {
            let active = (Store.data.config.fields || {})[type] || [];
            if(active.includes(key)) {
                active = active.filter(k => k !== key);
                OfflineManager.write(`settings/fields/${type}`, active);
                Store.data.config.fields[type] = active;
            }
        });

        this.renderFieldsEditor();
        Notify.show('השדה נמחק מהמערכת', 'info');
    },
    removeField(type, key) {
        if(!confirm('האם להסיר את השדה מהרשימה הפעילה?')) return;
        let active = (Store.data.config.fields || {})[type] || [];
        active = active.filter(k => k !== key);
        OfflineManager.write(`settings/fields/${type}`, active);
        Store.data.config.fields[type] = active;
        this.renderFieldsEditor();
    },
    renderGoals() {
        const div = document.getElementById('settings-goals-tiers');
        const tiers = Store.data.config.tiers || [];
        div.innerHTML = tiers.map((t, i) => `
            <div class="flex gap-2 items-center mb-2">
                <span class="text-sm font-bold w-6">#${i+1}</span>
                <input type="number" placeholder="סכום תרומה" value="${t.amount}" onchange="Settings.updateTier(${i}, 'amount', this.value)" class="input-field w-24 p-1 text-sm">
                <input type="text" placeholder="סכום זיכוי (מספר) או מתנה" value="${t.gift}" onchange="Settings.updateTier(${i}, 'gift', this.value)" class="input-field flex-1 p-1 text-sm">
                <button onclick="Settings.removeTier(${i})" class="text-red-500"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    },
    addGoalTier() {
        const tiers = Store.data.config.tiers || [];
        tiers.push({amount: 0, gift: ''});
        OfflineManager.write('settings/tiers', tiers);
        Store.data.config.tiers = tiers;
        this.renderGoals();
    },
    updateTier(i, k, v) {
        const tiers = [...Store.data.config.tiers];
        tiers[i][k] = v;
        OfflineManager.write('settings/tiers', tiers);
    },
    removeTier(i) {
        const tiers = Store.data.config.tiers || [];
        tiers.splice(i, 1);
        OfflineManager.write('settings/tiers', tiers);
        Store.data.config.tiers = tiers;
        this.renderGoals();
    },
    renderStudentRewards() {
        const div = document.getElementById('settings-student-rewards');
        const tiers = Store.data.config.studentTiers || [];
        div.innerHTML = tiers.map((t, i) => `
            <div class="flex gap-2 items-center bg-white p-2 rounded border border-amber-100">
                <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 font-bold">${i+1}</div>
                <div class="flex-1 grid grid-cols-2 gap-2">
                    <input type="number" placeholder="סכום יעד" value="${t.amount}" onchange="Settings.updateStudentReward(${i}, 'amount', this.value)" class="input-field text-sm">
                    <input type="text" placeholder="תיאור מתנה/תגמול" value="${t.reward}" onchange="Settings.updateStudentReward(${i}, 'reward', this.value)" class="input-field text-sm">
                </div>
                <button onclick="Settings.removeStudentReward(${i})" class="text-red-400 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash-alt"></i></button>
            </div>
        `).join('');
    },
    addStudentReward() {
        const tiers = Store.data.config.studentTiers || [];
        tiers.push({amount: 5000, reward: 'מתנה חדשה'});
        OfflineManager.write('settings/studentTiers', tiers);
        Store.data.config.studentTiers = tiers;
        this.renderStudentRewards();
    },
    updateStudentReward(i, k, v) {
        const tiers = [...Store.data.config.studentTiers];
        tiers[i][k] = k === 'amount' ? parseInt(v) : v;
        OfflineManager.write('settings/studentTiers', tiers);
    },
    removeStudentReward(i) {
        const tiers = Store.data.config.studentTiers || [];
        tiers.splice(i, 1);
        OfflineManager.write('settings/studentTiers', tiers);
        Store.data.config.studentTiers = tiers;
        this.renderStudentRewards();
    },
    renderBonusTiers() {
        const div = document.getElementById('settings-bonus-tiers');
        const tiers = Store.data.config.bonusTiers || [];
        div.innerHTML = tiers.map((t, i) => `
            <div class="flex gap-2 items-center mb-2">
                <span class="text-xs">מ:</span>
                <input type="number" value="${t.rangeMin}" onchange="Settings.updateBonusTier(${i}, 'rangeMin', this.value)" class="input-field w-20 p-1 text-sm">
                <span class="text-xs">עד:</span>
                <input type="number" value="${t.rangeMax}" onchange="Settings.updateBonusTier(${i}, 'rangeMax', this.value)" class="input-field w-20 p-1 text-sm">
                <span class="text-xs">ש"ח =</span>
                <input type="number" value="${t.percent}" onchange="Settings.updateBonusTier(${i}, 'percent', this.value)" class="input-field w-16 p-1 text-sm">
                <span class="text-xs">%</span>
                <button onclick="Settings.removeBonusTier(${i})" class="text-red-500"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    },
    addBonusTier() {
        const tiers = Store.data.config.bonusTiers || [];
        // עדכון: מדרגות טווח
        tiers.push({rangeMin: 0, rangeMax: 1000, percent: 10});
        OfflineManager.write('settings/bonusTiers', tiers);
        Store.data.config.bonusTiers = tiers;
        this.renderBonusTiers();
    },
    updateBonusTier(i, k, v) {
        const tiers = [...Store.data.config.bonusTiers];
        tiers[i][k] = parseFloat(v);
        OfflineManager.write('settings/bonusTiers', tiers);
    },
    removeBonusTier(i) {
        const tiers = Store.data.config.bonusTiers || [];
        tiers.splice(i, 1);
        OfflineManager.write('settings/bonusTiers', tiers);
        Store.data.config.bonusTiers = tiers;
        this.renderBonusTiers();
    },
    
    // תיקון מס' 4: לוגיקה לניהול סוגי תלושים בהגדרות
    renderVouchers() {
        const div = document.getElementById('settings-vouchers-list');
        if(!div) return;
        const vouchers = Store.data.config.vouchers || [];
        
        if (vouchers.length === 0) {
            div.innerHTML = '<div class="text-gray-400 text-sm">לא הוגדרו תלושים</div>';
            return;
        }

        div.innerHTML = vouchers.map((v, i) => `
            <div class="flex gap-2 items-center bg-white p-2 rounded border border-purple-100 shadow-sm">
                <div class="flex-1 grid grid-cols-3 gap-2">
                    <div>
                        <label class="text-[10px] text-gray-500 block">שם החנות</label>
                        <input type="text" value="${v.storeName}" onchange="Settings.updateVoucher(${i}, 'storeName', this.value)" class="input-field text-sm w-full py-1">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block">שווי (למשתמש)</label>
                        <input type="number" value="${v.faceValue}" onchange="Settings.updateVoucher(${i}, 'faceValue', this.value)" class="input-field text-sm w-full py-1">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block">עלות אמיתית</label>
                        <input type="number" value="${v.realCost}" onchange="Settings.updateVoucher(${i}, 'realCost', this.value)" class="input-field text-sm w-full py-1">
                    </div>
                </div>
                <button onclick="Settings.removeVoucherType(${i})" class="text-red-400 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash-alt"></i></button>
            </div>
        `).join('');
    },
    addVoucherType() {
        const vouchers = Store.data.config.vouchers || [];
        vouchers.push({ id: 'v' + Date.now(), storeName: '', faceValue: 0, realCost: 0 });
        OfflineManager.write('settings/vouchers', vouchers);
        Store.data.config.vouchers = vouchers;
        this.renderVouchers();
    },
    updateVoucher(i, k, v) {
        const vouchers = [...Store.data.config.vouchers];
        vouchers[i][k] = (k === 'faceValue' || k === 'realCost') ? parseFloat(v) : v;
        OfflineManager.write('settings/vouchers', vouchers);
    },
    removeVoucherType(i) {
        if(!confirm('למחוק סוג תלוש זה?')) return;
        const vouchers = Store.data.config.vouchers || [];
        vouchers.splice(i, 1);
        OfflineManager.write('settings/vouchers', vouchers);
        Store.data.config.vouchers = vouchers;
        this.renderVouchers();
    }
};

// --- 12. SHARED MODAL & HELPERS ---
const Modal = {
    render(title, fields, onSave, extraHtml='') {
        let html = '';
        fields.forEach(f => {
            html += `<div class="mb-4">
                <label class="block text-sm font-bold text-slate-700 mb-1">${f.l} ${f.r?'<span class="text-red-500">*</span>':''}</label>`;
            
            if(f.t === 'select') {
                html += `<select id="field-${f.id}" class="w-full border border-slate-300 p-2.5 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition">`;
                f.opts.forEach(o => html += `<option value="${o}" ${f.v===o?'selected':''}>${o}</option>`);
                html += `</select>`;
            } else if(f.t === 'checkbox') {
                 html += `<div class="flex items-center gap-2"><input type="checkbox" id="field-${f.id}" ${f.v?'checked':''} class="h-5 w-5 rounded text-indigo-600"> <span class="text-sm">פעיל</span></div>`;
            } else if(f.t === 'textarea') {
                html += `<textarea id="field-${f.id}" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition h-24">${f.v||''}</textarea>`;
            } else if(f.t === 'referrer_select') {
                const opts = Object.values(Store.data.students).map(s => {
                    const n = s.firstName && s.lastName ? `${s.firstName} ${s.lastName}` : s.name;
                    return `<option value="${s.id}" ${f.v===s.id?'selected':''}>${n}</option>`;
                }).join('');
                html += `<select id="field-${f.id}" class="w-full border border-slate-300 p-2.5 rounded-lg bg-white"><option value="">-- בחר --</option>${opts}</select>`;
            } else {
                html += `<input id="field-${f.id}" type="${f.t||'text'}" value="${f.v||''}" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" ${f.r?'required':''}>`;
            }
            html += `</div>`;
        });
        html += extraHtml;
        this.renderRaw(title, html, () => {
            const data = {};
            fields.forEach(f => {
                const el = document.getElementById(`field-${f.id}`);
                data[f.id] = f.t === 'checkbox' ? el.checked : el.value;
            });
            onSave(data);
            this.close();
        });
    },
    renderRaw(title, bodyHtml, onSaveAction) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = bodyHtml;
        document.getElementById('modal-form').classList.remove('hidden-screen');
        // Ensure buttons are visible
        document.querySelector('#modal-form .btn-primary').parentElement.style.display = 'flex';
        
        setTimeout(() => document.querySelector('#modal-form > div').classList.remove('scale-95', 'opacity-0'), 10);
        const btn = document.getElementById('modal-save-btn');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = onSaveAction;
    },
    close() { 
        const el = document.querySelector('#modal-form > div');
        el.classList.add('scale-95'); 
        setTimeout(() => document.getElementById('modal-form').classList.add('hidden-screen'), 150); 
    }
};

const Dashboard = {
    render() {
        const stats = Store.data.stats || { income: 0, expense: 0 };
        const inc = stats.income || 0;
        const exp = stats.expense || 0;
        document.getElementById('dash-income').innerText = `₪${inc.toLocaleString()}`;
        document.getElementById('dash-expense').innerText = `₪${exp.toLocaleString()}`;
        document.getElementById('dash-total-balance').innerText = `₪${(inc - exp).toLocaleString()}`;
        
        // [1] הצגת סכום היעד בטקסט ליד הגרף
        const goal = Store.data.config.globalGoal || 100000;
        const elGoalText = document.getElementById('dash-goal-text-amount');
        if (elGoalText) elGoalText.innerText = `₪${parseInt(goal).toLocaleString()}`;

        const pct = Math.min(100, Math.round((inc / goal) * 100));
        setTimeout(() => { 
            const bar = document.getElementById('dash-bar');
            if(bar) bar.style.width = pct + '%'; 
        }, 100);
        document.getElementById('dash-goal-progress').innerText = pct + '%';
        
        // עדכון מספרי משתמשים ותורמים מלאים (אמיתיים) מהשרת
        db.ref('global/students').once('value', s => {
            const count = s.numChildren();
            const el = document.getElementById('dash-stat-students');
            if(el) el.innerText = count;
        });
        db.ref('global/donors').once('value', s => {
            const count = s.numChildren();
            const el = document.getElementById('dash-stat-donors');
            if(el) el.innerText = count;
        });

        if (Store.role !== 'user') {
            db.ref(`years/${Store.currentYear}/finance`).orderByChild('date').limitToLast(5).once('value', s => {
                const logs = document.getElementById('dash-logs');
                if(!logs) return;
                const val = s.val();
                if(!val) { logs.innerHTML = '<div class="text-center text-gray-400 mt-4">אין תנועות אחרונות</div>'; return; }
                const arr = Object.values(val).sort((a,b)=>b.date-a.date);
                logs.innerHTML = arr.map(t => {
                    const icon = t.type==='income' ? 'fa-arrow-down text-emerald-500' : 'fa-arrow-up text-rose-500';
                    const displayAmt = isNaN(parseFloat(t.amount)) ? t.amount : `₪${t.amount}`;
                    return `
                    <div class="p-3 border-b flex justify-between items-center text-sm hover:bg-slate-50">
                        <div class="flex items-center gap-2">
                            <i class="fas ${icon}"></i>
                            <span class="font-medium">${t.category}</span>
                            <span class="text-xs text-gray-400">${t.desc||''}</span>
                        </div>
                        <span class="font-bold">${displayAmt}</span>
                    </div>`;
                }).join('');
            });
        } else {
             const logs = document.getElementById('dash-logs');
             if(logs) logs.innerHTML = '<div class="text-center text-gray-400 mt-4">אין גישה לנתונים כספיים</div>';
        }
    }
};

const style = document.createElement('style');
style.innerHTML = `
    .btn-primary { background-color: #4f46e5; color: white; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2); }
    .btn-secondary { background-color: #ffffff; color: #475569; border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; }
    .btn-secondary:hover { background-color: #f8fafc; border-color: #cbd5e1; }
    .input-field { border: 1px solid #e2e8f0; padding: 0.6rem; border-radius: 0.75rem; outline: none; transition: 0.2s; background-color: #fff; }
    .input-field:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    .lbl { font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 0.25rem; display: block; text-transform: uppercase; letter-spacing: 0.025em; }
    .animate-bounce-slight { animation: bounceSlight 2s infinite; }
    @keyframes bounceSlight { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
`;
document.head.appendChild(style);
</script>
</body>
</html>
