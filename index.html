<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="icon" type="image/png" href="1.JPG">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מערכת ניהול - עזר חתנים | גרסה מלאה ומשודרגת</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- SheetJS - גרסה מלאה ליבוא ויצוא אקסל -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- פונט משודרג -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* הגדרות עיצוב מתקדמות */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; /* מניעת גלילה ראשית */ }
        body { font-family: 'Heebo', sans-serif; background-color: #f0f2f5; }
        
        .bg-sidebar { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); }
        .bg-main { background-color: #f3f4f6; }
        
        /* Scrollbar מעוצב ודק */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* החלה גורפת על אזורי תוכן */
        .view-section { 
            height: 100%; 
            overflow-y: auto; 
            padding-bottom: 2rem;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .view-section::-webkit-scrollbar { width: 6px; }
        .view-section::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- אזור הדפסה משודרג --- */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; left: 0; top: 0; width: 100%; min-height: 100%; 
                background: white; z-index: 99999; direction: rtl; padding: 0; margin: 0; 
                font-family: 'Heebo', sans-serif;
            }
            @page { size: A4 landscape; margin: 5mm; } 
            
            /* עיצוב טבלאות הדפסה יפה */
            .print-container { width: 100%; margin: 0 auto; }
            .print-header-box { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
            .print-title { font-size: 24pt; font-weight: 900; color: #000; }
            .print-subtitle { font-size: 14pt; color: #444; }
            
            .beautiful-table { width: 100%; border-collapse: collapse; font-size: 11pt; }
            .beautiful-table th { background-color: #eef2ff !important; border: 1px solid #000; padding: 8px; text-align: right; color: #000 !important; font-weight: 800; -webkit-print-color-adjust: exact; }
            .beautiful-table td { border: 1px solid #000; padding: 6px; text-align: right; color: #000; vertical-align: middle; }
            .beautiful-table tr:nth-child(even) { background-color: #f9fafb !important; -webkit-print-color-adjust: exact; }
            
            /* עיצוב ספציפי לדף צוות */
            .team-card { border: 2px solid #000; border-radius: 15px; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; }
            .role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-weight: bold; border: 1px solid #000; font-size: 0.8em; }
            .role-leader { background-color: #dbeafe !important; -webkit-print-color-adjust: exact; }
            .role-segan { background-color: #fef3c7 !important; -webkit-print-color-adjust: exact; }
            
            .no-print { display: none !important; }
        }
        #print-area { display: none; }
        
        /* הרשאות */
        body.role-user .financial-data { display: none !important; }
        body.role-user .admin-only { display: none !important; }

        .logo-img-login { max-height: 120px; width: auto; margin: 0 auto 1.5rem auto; display: block; }
        .logo-img-sidebar { max-height: 90px; width: auto; max-width: 100%; object-fit: contain; }
        .nav-btn.active { background-color: rgba(255,255,255,0.1); border-right-color: #6366f1; color: white; }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; display: flex; align-items: center; gap: 12px; animation: slideInLeft 0.3s ease; border-right: 4px solid transparent; }
        .toast.success { border-right-color: #10b981; }
        .toast.error { border-right-color: #ef4444; }
        .toast.info { border-right-color: #3b82f6; }
        .toast-icon { font-size: 1.2rem; }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Status Indicator for Offline */
        #connection-status {
            position: fixed; bottom: 10px; right: 10px; z-index: 9999;
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .status-offline { background-color: #fee2e2; color: #991b1b; display: flex !important; }
        .status-syncing { background-color: #fef3c7; color: #92400e; display: flex !important; }

        /* Celebration Animation */
        .celebration-bg {
            background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%);
            animation: pulse 1s infinite;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body class="h-full text-slate-800 bg-main overflow-hidden">

    <!-- מכל התראות -->
    <div id="toast-container"></div>
    
    <!-- מחוון חיבור -->
    <div id="connection-status" class="items-center gap-2">
        <i class="fas fa-wifi"></i> <span id="conn-text">מנותק - שומר מקומית</span>
    </div>

    <!-- אלמנט נסתר ליבוא קבצים -->
    <input type="file" id="excel-upload-input" accept=".xlsx, .xls" class="hidden" onchange="Importer.handleFileSelect(this)">

    <!-- אזור הדפסה -->
    <div id="print-area"></div>

    <!-- טיימר התנתקות -->
    <div id="timeout-modal" class="fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center hidden-screen backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md border-t-8 border-red-500 animate-bounce-slight">
            <div class="text-6xl text-red-500 mb-4"><i class="fas fa-hourglass-half"></i></div>
            <h2 class="text-2xl font-bold mb-2">זיהינו חוסר פעילות</h2>
            <p class="text-gray-600 mb-6">המערכת תתנתק באופן אוטומטי בעוד <span id="timeout-countdown" class="font-bold text-red-600 text-xl">60</span> שניות.</p>
            <button onclick="InactivityTimer.stayLoggedIn()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">השאר אותי מחובר</button>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div id="celebration-modal" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center hidden-screen">
        <div class="absolute inset-0 overflow-hidden pointer-events-none" id="confetti-container"></div>
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-lg border-4 border-amber-400 relative z-10 transform scale-100 transition-transform">
            <div class="w-24 h-24 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-trophy text-5xl text-amber-500 animate-bounce"></i>
            </div>
            <h2 class="text-4xl font-extrabold text-slate-800 mb-2">כל הכבוד!</h2>
            <h3 class="text-2xl font-bold text-indigo-600 mb-4" id="celebration-name">שם הבחור</h3>
            <p class="text-lg text-gray-600 mb-6">הבחור הגיע ליעד של <span id="celebration-amount" class="font-bold"></span> ש"ח!</p>
            <div class="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-6">
                <div class="text-sm text-amber-800 font-bold uppercase tracking-wider mb-1">המתנה שמגיעה לו:</div>
                <div class="text-2xl font-black text-amber-600" id="celebration-reward">...</div>
            </div>
            <button onclick="document.getElementById('celebration-modal').classList.add('hidden-screen')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">סגור חלון</button>
        </div>
    </div>

    <!-- מסך טעינה -->
    <div id="loader" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col justify-center items-center transition-opacity duration-500">
        <div id="loader-spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
        <h2 id="loader-text" class="text-white text-xl font-medium tracking-wide">טוען נתונים...</h2>
    </div>

    <!-- מסך התחברות -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col justify-center items-center hidden-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="bg-white/95 backdrop-blur p-10 rounded-3xl shadow-2xl w-96 text-center border border-white/20">
            <img src="1.JPG" alt="לוגו מערכת" class="logo-img-login" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <div class="hidden text-indigo-700 text-6xl mb-6"><i class="fas fa-synagogue"></i></div>
            
            <h1 class="text-2xl font-bold text-slate-800 mb-1">ברוכים הבאים</h1>
            <p class="text-gray-500 mb-8 text-sm">ניהול מערכת - עזר חתנים</p>
            
            <form onsubmit="Auth.login(event)" class="space-y-4" autocomplete="off">
                <div class="relative">
                    <i class="fas fa-envelope absolute top-3.5 right-3 text-gray-400"></i>
                    <input type="email" id="email" placeholder="אימייל" class="w-full bg-slate-50 border border-slate-200 p-3 pr-10 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute top-3.5 right-3 text-gray-400"></i>
                    <input type="password" id="password" placeholder="סיסמה" autocomplete="current-password" class="w-full bg-slate-50 border border-slate-200 p-3 pr-10 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95">כניסה למערכת</button>
            </form>
            <div id="login-msg" class="text-red-500 text-sm mt-4 hidden font-bold bg-red-50 p-2 rounded"></div>
        </div>
    </div>

    <!-- ממשק האפליקציה -->
    <div class="flex h-full w-full relative overflow-hidden">

        <!-- תפריט צד -->
        <aside id="sidebar" class="w-64 bg-sidebar text-slate-300 flex flex-col hidden-screen shadow-2xl z-20 h-full border-l border-slate-700 shrink-0">
            <!-- לוגו -->
            <div class="p-6 border-b border-slate-700/50 flex items-center justify-center h-32 bg-black/20">
                <img src="1.JPG" alt="לוגו" class="logo-img-sidebar hover:scale-105 transition" onerror="this.outerHTML='<h2 class=\'font-bold text-xl text-white\'>עזר חתנים</h2>'">
            </div>

            <nav class="flex-1 overflow-y-auto py-6 space-y-1 custom-scroll">
                <button onclick="Router.go('dashboard')" id="nav-dashboard" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-chart-pie w-5 text-center text-indigo-400"></i> לוח מחוונים
                </button>
                
                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider">ניהול נתונים</div>
                <button onclick="Router.go('students')" id="nav-students" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-user-graduate w-5 text-center text-blue-400"></i> בחורים
                </button>
                <button onclick="Router.go('donors')" id="nav-donors" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-hand-holding-usd w-5 text-center text-emerald-400"></i> תורמים
                </button>
                <button onclick="Router.go('groups')" id="nav-groups" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-users-cog w-5 text-center text-amber-400"></i> קבוצות ומסלולים
                </button>

                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider financial-data">כספים ודוחות</div>
                <button onclick="Router.go('finance')" id="nav-finance" class="nav-btn financial-data w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-cash-register w-5 text-center text-rose-400"></i> ניהול קופה
                </button>
                <button onclick="Router.go('reports')" id="nav-reports" class="nav-btn financial-data w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-file-excel w-5 text-center text-green-400"></i> דוחות והדפסות
                </button>
                
                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider admin-only">מנהל</div>
                <button onclick="Router.go('settings')" id="nav-settings" class="nav-btn admin-only w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-sliders-h w-5 text-center text-gray-400"></i> הגדרות מערכת
                </button>
            </nav>

            <div class="mt-auto bg-slate-900/50 backdrop-blur-md border-t border-slate-700/50 p-4">
                <button onclick="Auth.logout()" class="group w-full flex items-center gap-3 p-2.5 rounded-xl hover:bg-red-500/10 hover:text-red-400 transition-all duration-300 mb-4 border border-transparent hover:border-red-500/20">
                    <div class="bg-slate-800 group-hover:bg-red-500 text-slate-400 group-hover:text-white w-8 h-8 rounded-lg flex items-center justify-center transition-colors shadow-lg">
                        <i class="fas fa-power-off text-xs"></i>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-300 group-hover:text-red-300">התנתק מהמערכת</div>
                        <div id="user-email-display" class="text-[10px] text-slate-500 truncate w-32"></div>
                    </div>
                </button>
                <div class="relative overflow-hidden rounded-xl bg-gradient-to-r from-indigo-900/40 to-slate-900/40 border border-slate-700/50 p-3 text-center group">
                    <h4 class="text-sm font-bold text-indigo-300 relative z-10 group-hover:text-white transition-colors">דובי לוי</h4>
                    <a href="mailto:7640421@gmail.com" class="text-[10px] text-slate-500 hover:text-indigo-400 transition relative z-10 flex items-center justify-center gap-1 mt-1">
                        <i class="fas fa-envelope"></i> 7640421@gmail.com
                    </a>
                </div>
            </div>
        </aside>

        <!-- תוכן ראשי -->
        <main id="main-content" class="flex-1 flex flex-col hidden-screen h-full overflow-hidden relative bg-slate-50">
            
            <!-- כותרת עליונה -->
            <header class="bg-white shadow-sm h-16 flex justify-between items-center px-8 z-10 shrink-0 border-b border-gray-200">
                <div class="flex items-center gap-4">
                    <button onclick="document.getElementById('sidebar').classList.toggle('hidden-screen')" class="lg:hidden p-2 text-gray-600"><i class="fas fa-bars"></i></button>
                    <h2 id="page-title" class="text-2xl font-bold text-slate-800 tracking-tight">דף הבית</h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100 flex items-center gap-2">
                        <span class="text-sm text-indigo-900 font-bold">שנה נוכחית:</span>
                        <select id="year-selector" onchange="System.changeYear(this.value)" class="bg-transparent border-none text-indigo-700 font-bold text-sm focus:ring-0 cursor-pointer py-0 outline-none">
                            <!-- שנים יטענו דינמית -->
                        </select>
                    </div>
                </div>
            </header>

            <!-- מיכל תצוגות -->
            <div id="views-container" class="flex-1 overflow-hidden relative">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="view-section p-6 fade-in hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 financial-data">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">יתרה בקופה (כללי)</div>
                                <div class="text-3xl font-bold text-slate-800" id="dash-total-balance">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-xl"><i class="fas fa-wallet"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">הכנסות (<span class="curr-year"></span>)</div>
                                <div class="text-3xl font-bold text-emerald-600" id="dash-income">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl"><i class="fas fa-arrow-down"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">הוצאות (<span class="curr-year"></span>)</div>
                                <div class="text-3xl font-bold text-rose-600" id="dash-expense">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-rose-50 text-rose-600 flex items-center justify-center text-xl"><i class="fas fa-arrow-up"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <div class="text-slate-500 text-sm font-medium">יעד שנתי</div>
                                <div class="text-amber-600 font-bold" id="dash-goal-progress">0%</div>
                            </div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div id="dash-bar" class="bg-amber-500 h-full rounded-full transition-all duration-1000" style="width:0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700"><i class="fas fa-history text-indigo-500 ml-2"></i>עדכונים אחרונים</h3>
                                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">לייב</span>
                            </div>
                            <div id="dash-logs" class="p-4 overflow-y-auto flex-1 custom-scroll">
                                <p class="text-center text-gray-400 mt-4">טוען תנועות אחרונות...</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white flex flex-col items-center justify-center relative overflow-hidden">
                                <i class="fas fa-user-graduate absolute -bottom-4 -right-4 text-8xl text-white/10"></i>
                                <div class="text-5xl font-bold mb-2 z-10" id="dash-stat-students">...</div>
                                <div class="text-indigo-100 z-10">בחורים רשומים</div>
                            </div>
                            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white flex flex-col items-center justify-center relative overflow-hidden">
                                <i class="fas fa-hand-holding-heart absolute -bottom-4 -right-4 text-8xl text-white/10"></i>
                                <div class="text-5xl font-bold mb-2 z-10" id="dash-stat-donors">...</div>
                                <div class="text-emerald-100 z-10">תורמים במערכת</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. STUDENTS -->
                <div id="view-students" class="view-section flex flex-col hidden fade-in bg-white h-full overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex gap-3 items-center justify-between shrink-0">
                        <div class="flex gap-3">
                            <button onclick="Students.openAddModal()" class="btn-primary bg-indigo-600"><i class="fas fa-plus ml-2"></i> הוסף בחור</button>
                            <button onclick="Students.openQuickAdd()" class="btn-secondary"><i class="fas fa-layer-group ml-2 text-indigo-500"></i> הוספה מהירה</button>
                            <button onclick="Importer.init('students')" class="btn-secondary"><i class="fas fa-file-excel ml-2 text-green-600"></i> יבוא מאקסל</button>
                        </div>
                        <div class="relative w-96">
                            <input type="text" id="student-search" oninput="Students.handleSearch(this.value)" placeholder="חיפוש..." class="input-field w-full pl-4 pr-10">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 custom-scroll" id="students-container">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-slate-600 sticky top-0 shadow-sm z-10">
                                <tr>
                                    <th class="p-3 text-right rounded-r-lg bg-slate-50">שם מלא</th>
                                    <th class="p-3 text-right bg-slate-50">שיעור</th>
                                    <th class="p-3 text-right bg-slate-50">שנת כניסה</th>
                                    <th class="p-3 text-right bg-slate-50">יעד אישי</th>
                                    <th class="p-3 text-center rounded-l-lg bg-slate-50">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="students-tbody" class="divide-y divide-slate-100"></tbody>
                        </table>
                        <div id="students-loader-more" class="p-6 text-center mt-2 hidden">
                            <button onclick="Students.loadMore()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-6 py-2 rounded-full text-sm font-bold transition">טען עוד</button>
                        </div>
                    </div>
                </div>

                <!-- 3. DONORS -->
                <div id="view-donors" class="view-section flex flex-col hidden fade-in h-full overflow-hidden">
                    <div class="p-4 bg-white rounded-t-2xl shadow-sm border-b flex gap-3 items-center justify-between mb-0 shrink-0">
                        <div class="flex gap-3">
                            <button onclick="Donors.openAddModal()" class="btn-primary bg-emerald-600"><i class="fas fa-plus ml-2"></i> הוסף תורם</button>
                            <button onclick="Donors.toggleQuickManager()" class="btn-secondary border-emerald-200 text-emerald-700 bg-emerald-50 hover:bg-emerald-100">
                                <i class="fas fa-th ml-2"></i> ניהול שיבוץ מהיר
                            </button>
                            <button onclick="Importer.init('donors')" class="btn-secondary"><i class="fas fa-file-excel text-green-600"></i> יבוא מאקסל</button>
                        </div>
                        <div class="relative w-80">
                            <input type="text" oninput="Donors.handleSearch(this.value)" placeholder="חפש תורם..." class="input-field w-full pl-4 pr-10">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>

                    <div id="donors-list-view" class="flex-1 overflow-y-auto p-4 custom-scroll">
                        <div id="donors-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pb-4"></div>
                        <div id="donors-loader-more" class="p-4 text-center hidden">
                            <button onclick="Donors.loadMore()" class="bg-slate-200 text-slate-600 px-6 py-2 rounded-full font-bold text-sm">טען עוד...</button>
                        </div>
                    </div>

                    <div id="donors-quick-manager" class="hidden flex-1 flex gap-4 overflow-hidden h-full pb-2 p-4">
                        <div class="w-1/4 bg-white rounded-xl shadow border flex flex-col h-full">
                            <div class="p-3 border-b bg-gray-50 font-bold text-gray-700 flex justify-between">
                                <span>מאגר לא משובצים</span>
                                <span id="pool-count" class="bg-gray-200 text-xs px-2 py-0.5 rounded-full">0</span>
                            </div>
                            <div class="p-2 border-b"><input type="text" placeholder="סנן..." oninput="Donors.filterPool(this.value)" class="w-full text-xs p-1 border rounded"></div>
                            <div id="donor-pool-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50/50 custom-scroll"></div>
                        </div>
                        <div class="flex-1 bg-white rounded-xl shadow border flex flex-col">
                            <div class="p-3 border-b bg-indigo-50 font-bold text-indigo-800 flex justify-between items-center">
                                <span>קבוצות השנה (<span class="curr-year"></span>)</span>
                                <div class="text-xs font-normal">גרור תורמים מהמאגר לקבוצות</div>
                            </div>
                            <div class="flex-1 overflow-x-auto overflow-y-hidden p-4 whitespace-nowrap bg-slate-100 custom-scroll" id="groups-kanban-container"></div>
                        </div>
                    </div>
                </div>

                <!-- 4. GROUPS -->
                <div id="view-groups" class="view-section flex flex-col hidden fade-in bg-white h-full overflow-hidden">
                    <div class="px-4 pt-3 border-b bg-slate-50 flex gap-2 shrink-0">
                        <button onclick="Groups.setDay('night14')" class="group-tab active" data-day="night14">ליל י"ד</button>
                        <button onclick="Groups.setDay('day14')" class="group-tab" data-day="day14">יום י"ד</button>
                        <button onclick="Groups.setDay('day15')" class="group-tab" data-day="day15">יום ט"ו</button>
                    </div>

                    <div class="flex flex-1 overflow-hidden">
                        <div class="w-72 border-l flex flex-col bg-white">
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50/50">
                                <span class="font-bold text-sm text-slate-700">רשימת קבוצות</span>
                                <button onclick="Groups.addNewGroup()" class="bg-indigo-100 text-indigo-600 hover:bg-indigo-200 p-1.5 rounded-lg transition"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="groups-list" class="flex-1 overflow-y-auto custom-scroll"></div>
                        </div>

                        <div class="flex-1 flex flex-col bg-slate-50 relative" id="group-workspace">
                            <div id="group-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400 flex-col">
                                <i class="fas fa-layer-group text-6xl mb-4 text-slate-200"></i>
                                <p>בחר קבוצה לעריכה</p>
                            </div>

                            <div id="group-editor" class="hidden flex flex-col h-full">
                                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10">
                                    <div class="flex gap-3 items-center">
                                        <h3 id="active-group-name" class="font-bold text-xl text-slate-800 cursor-pointer hover:bg-gray-100 px-2 rounded" onclick="Groups.renameGroup()"></h3>
                                        <span id="active-group-details" class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full border"></span>
                                        <button onclick="Groups.deleteGroup()" class="text-red-500 bg-red-50 hover:bg-red-100 px-2 py-1 rounded border border-red-100 text-xs font-bold mr-2">מחק קבוצה</button>
                                    </div>
                                    <div class="flex gap-2 text-sm">
                                        <button onclick="Groups.printSheet('team')" class="btn-secondary text-xs"><i class="fas fa-users"></i> דף צוות</button>
                                        <button onclick="Groups.printSheet('route')" class="btn-secondary text-xs"><i class="fas fa-route"></i> דף מסלול</button>
                                    </div>
                                </div>

                                <div class="flex flex-1 overflow-hidden">
                                    <div class="w-1/2 flex flex-col border-l bg-white">
                                        <div class="p-3 bg-emerald-50 text-emerald-900 font-bold text-sm border-b flex justify-between">
                                            <span><i class="fas fa-map-signs"></i> מסלול תורמים</span>
                                            <span class="text-xs font-normal opacity-70">סדר את המסלול בגרירה</span>
                                        </div>
                                        <div id="group-route-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50 custom-scroll"></div>
                                    </div>

                                    <div class="w-1/2 flex flex-col bg-white">
                                        <div class="p-3 bg-indigo-50 text-indigo-900 font-bold text-sm border-b"><i class="fas fa-user-friends"></i> שיבוץ בחורים</div>
                                        <div class="flex-1 flex flex-col overflow-hidden">
                                            <div id="group-members-list" class="flex-1 overflow-y-auto p-3 space-y-2 h-1/2 border-b custom-scroll"></div>
                                            <div class="h-1/2 flex flex-col bg-slate-50">
                                                <div class="p-2 border-b bg-white relative">
                                                    <input type="text" placeholder="חפש בחור להוספה..." oninput="Groups.filterStudents(this.value)" class="w-full text-sm p-2 border rounded pl-8">
                                                    <i class="fas fa-search absolute left-4 top-4 text-gray-300 text-xs"></i>
                                                </div>
                                                <div id="pool-students" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. FINANCE -->
                <div id="view-finance" class="view-section flex flex-col hidden fade-in financial-data bg-white h-full overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0">
                        <div class="flex gap-3">
                             <button onclick="Finance.openTransactionModal('income')" class="btn-primary bg-emerald-600 hover:bg-emerald-700"><i class="fas fa-plus-circle ml-2"></i> הכנסה</button>
                             <button onclick="Finance.openTransactionModal('expense')" class="btn-primary bg-rose-600 hover:bg-rose-700"><i class="fas fa-minus-circle ml-2"></i> הוצאה</button>
                        </div>
                        <div class="flex bg-white rounded-lg p-1 border shadow-sm">
                            <button onclick="Finance.setFilter('all')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter active" data-f="all">הכל</button>
                            <button onclick="Finance.setFilter('income')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-gray-50 text-gray-600" data-f="income">הכנסות</button>
                            <button onclick="Finance.setFilter('expense')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-gray-50 text-gray-600" data-f="expense">הוצאות</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-hidden flex flex-col">
                        <div class="overflow-y-auto flex-1 p-4 custom-scroll" id="finance-scroll-container">
                            <table class="w-full text-sm text-right border-collapse">
                                <thead class="bg-slate-100 text-slate-600 sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-3 rounded-r-lg bg-slate-100">תאריך</th>
                                        <th class="p-3 bg-slate-100">סוג</th>
                                        <th class="p-3 bg-slate-100">קטגוריה</th>
                                        <th class="p-3 bg-slate-100">תיאור / משוייך ל...</th>
                                        <th class="p-3 bg-slate-100">סכום</th>
                                        <th class="p-3 rounded-l-lg bg-slate-100">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="finance-tbody" class="divide-y divide-slate-100"></tbody>
                            </table>
                            <div id="finance-loader-more" class="p-4 text-center mt-2 hidden">
                                <button onclick="Finance.loadMore()" class="text-indigo-600 hover:underline font-bold">טען היסטוריה ישנה יותר...</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. REPORTS -->
                <div id="view-reports" class="view-section hidden fade-in financial-data p-6">
                    <h2 class="text-3xl font-bold mb-8 text-slate-800">דוחות והדפסות</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-4"><i class="fas fa-file-invoice-dollar text-xl"></i></div>
                            <h3 class="font-bold text-lg mb-2">דוח תנועות כספיות</h3>
                            <p class="text-sm text-gray-500 mb-4">ייצוא כל ההכנסות וההוצאות לאקסל עם אפשרויות סינון.</p>
                            <div class="space-y-3">
                                <select id="rep-type" class="input-field w-full text-sm"><option value="all">הכל</option><option value="income">רק הכנסות</option><option value="expense">רק הוצאות</option></select>
                                <button onclick="Reports.generateStandard()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold hover:bg-slate-700 text-sm">הורד לאקסל</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7. SETTINGS -->
                <div id="view-settings" class="view-section p-6 hidden fade-in admin-only">
                    <div class="max-w-5xl mx-auto space-y-8 pb-10">
                        <h2 class="text-3xl font-bold text-slate-800">הגדרות מערכת</h2>

                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-orange-100 bg-orange-50/30">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-xl text-orange-800">תחזוקה שנתית</h3>
                                    <p class="text-sm text-gray-500">קידום שיעורים וסנכרון לשנה העברית החדשה.</p>
                                </div>
                                <button onclick="Settings.syncYears()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition">בצע סנכרון שנתי</button>
                            </div>
                        </div>

                         <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-4 text-slate-700 border-b pb-2">ניהול שנות פעילות</h3>
                            <p class="text-sm text-gray-500 mb-4">המערכת פותחת שנים חדשות אוטומטית. לחץ כאן להוספת שנה היסטורית.</p>
                            <button onclick="Settings.addHistoryYear()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-6 rounded-xl shadow transition">הוסף שנה היסטורית</button>
                        </div>

                        <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-6 text-slate-700 border-b pb-2">ניהול שדות מידע</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label class="block text-sm font-bold mb-2">בחר סוג רשימה:</label>
                                    <select id="settings-field-type" onchange="Settings.renderFieldsEditor()" class="input-field w-full mb-4">
                                        <option value="students">שדות בחור</option>
                                        <option value="donors">שדות תורם</option>
                                    </select>
                                    <div class="bg-gray-50 p-4 rounded-xl border">
                                        <div class="text-sm font-bold mb-2">הוסף שדה:</div>
                                        <div class="flex gap-2 mb-4">
                                            <select id="settings-predefined-field" class="input-field flex-1 text-sm"></select>
                                            <button onclick="Settings.addField()" class="btn-primary bg-indigo-600 text-sm px-4">הוסף</button>
                                        </div>
                                        <div class="text-sm font-bold mt-4 mb-2">שדות פעילים:</div>
                                        <div id="settings-active-fields" class="space-y-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal: Generic Form -->
    <div id="modal-form" class="fixed inset-0 z-50 bg-black/60 hidden-screen flex items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-[550px] max-w-[90vw] overflow-hidden flex flex-col max-h-[90vh] scale-100 transition-transform" dir="rtl">
            <div class="p-5 bg-gradient-to-r from-slate-800 to-slate-900 text-white flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="font-bold text-xl tracking-wide">כותרת</h3>
                <button onclick="Modal.close()" class="hover:text-red-300 hover:rotate-90 transition transform"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-body" class="p-8 overflow-y-auto space-y-5 custom-scroll"></div>
            <div class="p-5 bg-gray-50 flex gap-4 border-t shrink-0">
                <button id="modal-save-btn" class="flex-1 btn-primary py-3 text-lg shadow-md">שמור</button>
                <button onclick="Modal.close()" class="flex-1 btn-secondary py-3 text-lg">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBRunXdWIFiP8-vZao0WZ6WxItMAUt-ORY",
            authDomain: "ezer--project.firebaseapp.com",
            databaseURL: "https://ezer--project-default-rtdb.firebaseio.com",
            projectId: "ezer--project",
            storageBucket: "ezer--project.firebasestorage.app",
            messagingSenderId: "838086109276",
            appId: "1:838086109276:web:201babf8b31c39a0cc9e99"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // 1. Session Persistence: SESSION only
        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

        const SHIURIM_ORDER = ['שיעור א', 'שיעור ב', 'שיעור ג', 'קיבוץ א', 'קיבוץ ב', 'קיבוץ ג', 'קיבוץ ד', 'קיבוץ ה', 'קיבוץ ו', 'קיבוץ ז', 'קיבוץ ח'];
        
        const PREDEFINED_FIELDS = {
            students: [
                {k:'name', l:'שם מלא', t:'text', r:true},
                {k:'phone', l:'טלפון', t:'text'},
                {k:'grade', l:'שיעור', t:'select', opts:SHIURIM_ORDER},
                {k:'entryYear', l:'שנת כניסה', t:'text'},
                {k:'idNum', l:'תעודת זהות', t:'text'},
                {k:'city', l:'עיר מגורים', t:'text'},
                {k:'fatherName', l:'שם האב', t:'text'},
                {k:'room', l:'מספר חדר', t:'text'}
            ],
            donors: [
                {k:'name', l:'שם תורם', t:'text', r:true},
                {k:'address', l:'כתובת', t:'text'},
                {k:'phone', l:'טלפון', t:'text'},
                {k:'email', l:'אימייל', t:'email'},
                {k:'notes', l:'הערות', t:'textarea'},
                {k:'vip', l:'VIP', t:'checkbox'}
            ]
        };
        
        const DEFAULT_ACTIVE_FIELDS = {
            students: ['name','phone','grade','entryYear'],
            donors: ['name','address','phone']
        };

        const getHebrewYear = () => {
            const d = new Date();
            const y = d.getFullYear();
            const hYear = d.getMonth() > 8 ? y + 3761 : y + 3760; 
            const map = {5780:'תש״פ', 5781:'תשפ״א', 5782:'תשפ״ב', 5783:'תשפ״ג', 5784:'תשפ״ד', 5785:'תשפ״ה', 5786:'תשפ״ו', 5787:'תשפ״ז', 5788:'תשפ״ח'};
            return map[hYear] || hYear.toString();
        };

        const Notify = {
            show(msg, type = 'info') {
                const con = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
                el.innerHTML = `<i class="fas ${icon} toast-icon"></i><span class="font-medium text-slate-800 text-sm">${msg}</span>`;
                con.appendChild(el);
                setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
            }
        };

        const OfflineManager = {
            isOnline: navigator.onLine,
            
            init() {
                window.addEventListener('online', () => this.updateStatus(true));
                window.addEventListener('offline', () => this.updateStatus(false));
                this.updateStatus(this.isOnline);
            },
            
            saveState(key, data) {
                try { localStorage.setItem('cache_' + key, JSON.stringify(data)); } catch(e) {}
            },
            
            loadState(key) {
                try { return JSON.parse(localStorage.getItem('cache_' + key)); } catch(e) { return null; }
            },

            updateStatus(online) {
                this.isOnline = online;
                const ind = document.getElementById('connection-status');
                const txt = document.getElementById('conn-text');
                if(online) {
                    ind.style.display = 'none';
                } else {
                    ind.className = 'status-offline';
                    txt.innerText = 'מנותק - שומר מקומית';
                    ind.style.display = 'flex';
                }
            },
            
            write(path, data, type = 'set') {
                const parts = path.split('/');
                let storeKey = null; let itemId = null;

                if (path.includes('global/students')) { storeKey = 'students'; itemId = parts[2]; }
                else if (path.includes('global/donors')) { storeKey = 'donors'; itemId = parts[2]; }

                if (storeKey && itemId) {
                    if (type === 'remove') delete Store.data[storeKey][itemId];
                    else if (type === 'set' || type === 'update') {
                        const existing = Store.data[storeKey][itemId] || {};
                        Store.data[storeKey][itemId] = type === 'update' ? { ...existing, ...data } : data;
                    }
                    this.saveState(storeKey, Store.data[storeKey]);
                    if (Router.current === storeKey) {
                        if(storeKey === 'students') Students.render();
                        else Donors.render();
                    }
                }

                if(this.isOnline) {
                    if(type === 'set') return db.ref(path).set(data);
                    if(type === 'update') return db.ref(path).update(data);
                    if(type === 'remove') return db.ref(path).remove();
                    if(type === 'transaction') return db.ref(path).transaction(data);
                }
            }
        };
        OfflineManager.init();

        const Store = {
            currentYear: getHebrewYear(),
            user: null,
            role: 'user',
            data: {
                students: {}, 
                donors: {},   
                yearData: {}, 
                config: { fields: {} },
                donorGroupMap: {},
                stats: { income: 0, expense: 0 } 
            },
            cursors: { students: null, donors: null, finance: null },
            loadedAll: { students: false, donors: false },

            init() {
                const cachedStudents = OfflineManager.loadState('students');
                const cachedDonors = OfflineManager.loadState('donors');
                
                if(cachedStudents) this.data.students = cachedStudents;
                if(cachedDonors) this.data.donors = cachedDonors;
                
                this.loadConfig();
                this.loadStats();
                
                if (!cachedStudents || Object.keys(cachedStudents).length === 0) Students.loadMore(true); 
                else Students.syncNewest();

                if (!cachedDonors || Object.keys(cachedDonors).length === 0) Donors.loadMore(true);
                else Donors.syncNewest();

                this.loadGroups();
            },

            loadStats() {
                // רק מנהל רואה סטטיסטיקה בזיכרון, אבל כולם צריכים לדעת שנה
                if (Store.role === 'admin') {
                    db.ref(`years/${this.currentYear}/stats`).on('value', s => {
                        this.data.stats = s.val() || { income: 0, expense: 0 };
                        if(Router.current === 'dashboard') Dashboard.render();
                    });
                }
            },
            
            loadGroups() {
                db.ref(`years/${this.currentYear}/groups`).on('value', snap => {
                    if(!this.data.yearData[this.currentYear]) this.data.yearData[this.currentYear] = {};
                    const groupsData = snap.val() || {};
                    this.data.yearData[this.currentYear].groups = groupsData;
                    
                    this.data.donorGroupMap = {};
                    Object.values(groupsData).forEach(dayGroups => {
                        Object.values(dayGroups).forEach(g => {
                            if(g.route) g.route.forEach(did => this.data.donorGroupMap[did] = g.name);
                        });
                    });
                    
                    UI.updateIfVisible('groups');
                    if(Router.current === 'donors') Donors.render(); 
                });
            },

            loadConfig() {
                db.ref('settings').on('value', s => {
                    this.data.config = s.val() || {};
                    if(!this.data.config.fields) this.data.config.fields = JSON.parse(JSON.stringify(DEFAULT_ACTIVE_FIELDS));
                });
            }
        };

        const InactivityTimer = {
            timer: null,
            LIMIT: 30 * 60 * 1000, 
            
            init() {
                ['mousemove', 'keydown', 'click'].forEach(ev => document.addEventListener(ev, () => this.reset()));
                this.reset();
            },
            
            reset() {
                if(!Store.user) return;
                clearTimeout(this.timer);
                document.getElementById('timeout-modal').classList.add('hidden-screen');
                this.timer = setTimeout(() => {
                    document.getElementById('timeout-modal').classList.remove('hidden-screen');
                    setTimeout(() => Auth.logout(), 60000);
                }, this.LIMIT);
            },
            
            stayLoggedIn() { this.reset(); }
        };

        const Auth = {
            login(e) {
                e.preventDefault();
                const em = document.getElementById('email').value;
                const pw = document.getElementById('password').value;
                localStorage.setItem('remember_email', em);

                auth.signInWithEmailAndPassword(em, pw).catch(err => {
                    const msg = document.getElementById('login-msg');
                    msg.innerText = "שגיאה: פרטים שגויים";
                    msg.classList.remove('hidden');
                });
            },
            logout() { 
                auth.signOut(); 
                location.reload(); 
            },
            onStateChange(u) {
                document.getElementById('loader').classList.add('hidden-screen');
                if(u) {
                    Store.user = u;
                    document.getElementById('user-email-display').innerText = u.email;
                    document.getElementById('login-screen').classList.add('hidden-screen');
                    document.getElementById('sidebar').classList.remove('hidden-screen');
                    document.getElementById('main-content').classList.remove('hidden-screen');
                    
                    db.ref(`users/${u.uid}`).once('value', s => {
                        const val = s.val() || {};
                        Store.role = val.role || 'user';
                        document.body.className = `role-${Store.role}`;
                        Store.init();
                        System.initUI();
                        Router.go('dashboard');
                        InactivityTimer.init();
                    });
                } else {
                    document.getElementById('login-screen').classList.remove('hidden-screen');
                    document.getElementById('sidebar').classList.add('hidden-screen');
                    document.getElementById('main-content').classList.add('hidden-screen');
                    
                    const savedEmail = localStorage.getItem('remember_email');
                    if(savedEmail) document.getElementById('email').value = savedEmail;
                }
            }
        };
        auth.onAuthStateChanged(Auth.onStateChange);

        const Router = {
            current: null,
            go(view) {
                if (view === 'finance' && Store.role === 'user') return Notify.show('אין לך הרשאה לצפות בנתונים כספיים', 'error');
                if (view === 'settings' && Store.role === 'user') return Notify.show('אין לך הרשאה להגדרות', 'error');

                this.current = view;
                document.querySelectorAll('.view-section').forEach(el => { el.classList.add('hidden'); el.classList.remove('fade-in'); });
                const el = document.getElementById('view-' + view);
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('fade-in'), 10);
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('nav-' + view).classList.add('active');
                
                const titles = {dashboard:'לוח מחוונים', students:'ניהול בחורים', donors:'ניהול תורמים', groups:'קבוצות ומסלולים', finance:'ניהול קופה', reports:'דוחות', settings:'הגדרות'};
                document.getElementById('page-title').innerText = titles[view] || view;

                if(view === 'students') Students.render();
                if(view === 'donors') Donors.render();
                if(view === 'finance') Finance.loadMore(true);
                if(view === 'dashboard') Dashboard.render();
                if(view === 'settings') Settings.init();
            }
        };

        const UI = {
            updateIfVisible(module) {
                if(Router.current === module) {
                    if(module === 'groups') Groups.render();
                }
            }
        };

        const System = {
            availableYears: [],
            
            initUI() {
                // חישוב שנים: נוכחית + 2 קדימה, ומה שיש ב-DB
                const d = new Date();
                const currG = d.getFullYear();
                const currH = d.getMonth() > 8 ? currG + 3761 : currG + 3760; 
                
                // המרת שנה
                const map = {5780:'תש״פ', 5781:'תשפ״א', 5782:'תשפ״ב', 5783:'תשפ״ג', 5784:'תשפ״ד', 5785:'תשפ״ה', 5786:'תשפ״ו', 5787:'תשפ״ז', 5788:'תשפ״ח'};
                
                // טעינת רשימת שנים מה-DB אם הוגדרו היסטורית
                db.ref('years').once('value', s => {
                     const yearsInDb = Object.keys(s.val() || {});
                     const yearsSet = new Set(yearsInDb);
                     
                     // הוספת שנים "קרובות" אוטומטית
                     for(let i = 0; i <= 2; i++) yearsSet.add((currH + i).toString());
                     
                     this.availableYears = Array.from(yearsSet).sort().reverse();
                     
                     const sel = document.getElementById('year-selector');
                     sel.innerHTML = '';
                     this.availableYears.forEach(y => {
                        const label = map[y] || y.toString();
                        const op = document.createElement('option');
                        op.value = y; op.innerText = label;
                        if(y === Store.currentYear) op.selected = true;
                        sel.appendChild(op);
                     });
                     
                     document.querySelectorAll('.curr-year').forEach(s => s.innerText = map[Store.currentYear] || Store.currentYear);
                });
            },
            
            changeYear(y) {
                Store.currentYear = y;
                Store.data.yearData = {};
                Store.data.stats = { income: 0, expense: 0 };
                Store.loadStats();
                Store.loadGroups();
                Finance.reset();
                const map = {5780:'תש״פ', 5781:'תשפ״א', 5782:'תשפ״ב', 5783:'תשפ״ג', 5784:'תשפ״ד', 5785:'תשפ״ה', 5786:'תשפ״ו', 5787:'תשפ״ז', 5788:'תשפ״ח'};
                document.querySelectorAll('.curr-year').forEach(s => s.innerText = map[y] || y);
                Router.go('dashboard'); 
            }
        };

        const Students = {
            limit: 30,
            loadMore(reset = false) {
                if (reset) { Store.cursors.students = null; Store.loadedAll.students = false; }
                
                document.getElementById('students-loader-more').style.display = 'block';
                let query = db.ref('global/students').orderByKey().limitToLast(this.limit);
                if (Store.cursors.students) query = query.endBefore(Store.cursors.students);

                query.once('value', snap => {
                    const data = snap.val();
                    if (!data) {
                        Store.loadedAll.students = true;
                        document.getElementById('students-loader-more').style.display = 'none';
                        return;
                    }
                    const keys = Object.keys(data).sort();
                    Store.cursors.students = keys[0];
                    Object.assign(Store.data.students, data);
                    OfflineManager.saveState('students', Store.data.students);
                    this.render();
                    
                    if (keys.length < this.limit) {
                        Store.loadedAll.students = true;
                        document.getElementById('students-loader-more').style.display = 'none';
                    }
                });
            },
            syncNewest() {
                db.ref('global/students').orderByKey().limitToLast(10).once('value', snap => {
                    if(snap.val()) { Object.assign(Store.data.students, snap.val()); if(Router.current==='students') this.render(); }
                });
            },
            render() {
                const term = document.getElementById('student-search').value.trim();
                const tbody = document.getElementById('students-tbody');
                tbody.innerHTML = '';
                let list = Object.values(Store.data.students).sort((a,b) => (a.name||'').localeCompare(b.name||''));
                if(term) list = list.filter(s => s.name.includes(term));
                
                list.slice(0, 100).forEach(s => {
                    const yData = (Store.data.yearData[Store.currentYear]?.students || {})[s.id] || {};
                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50 border-b border-slate-50 transition cursor-pointer group";
                    row.innerHTML = `
                        <td class="p-3 text-right font-medium text-slate-700">${s.name}</td>
                        <td class="p-3 text-right text-gray-500">${s.grade || '-'}</td>
                        <td class="p-3 text-right text-gray-400">${s.entryYear || '-'}</td>
                        <td class="p-3 text-right font-bold text-slate-800">₪${parseInt(yData.personalGoal || 0).toLocaleString()}</td>
                        <td class="p-3 text-center flex items-center justify-center gap-2">
                            <button onclick="Students.openEdit('${s.id}')" class="text-indigo-400 hover:text-indigo-600 p-2"><i class="fas fa-pen"></i></button>
                        </td>`;
                    tbody.appendChild(row);
                });
                document.getElementById('dash-stat-students').innerText = Object.keys(Store.data.students).length;
            },
            handleSearch(term) { this.render(); },
            getFormFields() {
                const activeKeys = Store.data.config.fields.students || DEFAULT_ACTIVE_FIELDS.students;
                return activeKeys.map(k => PREDEFINED_FIELDS.students.find(p => p.k === k)).filter(Boolean);
            },
            openAddModal() {
                Modal.render('הוספת בחור חדש', this.getFormFields(), (data) => {
                    const id = db.ref('global/students').push().key;
                    OfflineManager.write(`global/students/${id}`, { id, lastUpdatedYear: Store.currentYear, ...data });
                    Notify.show('בחור נוסף בהצלחה', 'success');
                });
            },
            openQuickAdd() {
                Modal.renderRaw('הוספה מהירה', `<textarea id="qadd" class="w-full border p-2 h-40" placeholder="שמות..."></textarea>`, () => {
                    const lines = document.getElementById('qadd').value.split('\n').filter(l => l.trim());
                    const batch = {};
                    lines.forEach(name => {
                        const id = db.ref('global/students').push().key;
                        batch[id] = { id, name, lastUpdatedYear: Store.currentYear, grade: 'שיעור א' };
                    });
                    db.ref('global/students').update(batch);
                    Object.assign(Store.data.students, batch);
                    Students.render();
                    Modal.close();
                });
            },
            openEdit(id) {
                const s = Store.data.students[id];
                const yData = (Store.data.yearData[Store.currentYear]?.students || {})[id] || {};
                const fields = this.getFormFields().map(f => ({ ...f, v: s[f.id] || '' }));
                const extra = `<div class="mb-4 bg-amber-50 p-3 rounded"><label class="lbl">יעד אישי</label><input type="number" id="s-goal" value="${yData.personalGoal||''}" class="input-field w-full"></div>`;
                
                Modal.render('עריכה', fields, (data) => {
                    OfflineManager.write(`global/students/${id}`, data, 'update');
                    const g = document.getElementById('s-goal').value;
                    if(g) OfflineManager.write(`years/${Store.currentYear}/studentData/${id}/personalGoal`, parseInt(g));
                    Notify.show('עודכן', 'success');
                }, extra);
            }
        };

        const Donors = {
            limit: 40, viewMode: 'list',
            loadMore(reset = false) {
                if(reset) { Store.cursors.donors = null; Store.loadedAll.donors = false; }
                document.getElementById('donors-loader-more').style.display = 'block';
                let query = db.ref('global/donors').orderByKey().limitToLast(this.limit);
                if(Store.cursors.donors) query = query.endBefore(Store.cursors.donors);

                query.once('value', snap => {
                    const data = snap.val();
                    if(!data) { Store.loadedAll.donors = true; document.getElementById('donors-loader-more').style.display = 'none'; return; }
                    Store.cursors.donors = Object.keys(data).sort()[0];
                    Object.assign(Store.data.donors, data);
                    OfflineManager.saveState('donors', Store.data.donors);
                    this.render();
                    if(Object.keys(data).length < this.limit) document.getElementById('donors-loader-more').style.display = 'none';
                });
            },
            syncNewest() {
                db.ref('global/donors').orderByKey().limitToLast(10).once('value', snap => {
                    if(snap.val()) { Object.assign(Store.data.donors, snap.val()); if(Router.current==='donors') this.render(); }
                });
            },
            render() {
                document.getElementById('dash-stat-donors').innerText = Object.keys(Store.data.donors).length;
                if(this.viewMode === 'list') {
                    document.getElementById('donors-list-view').style.display = 'block';
                    document.getElementById('donors-quick-manager').style.display = 'none';
                    document.getElementById('donors-quick-manager').classList.add('hidden');
                    this.renderGrid();
                } else {
                    document.getElementById('donors-list-view').style.display = 'none';
                    document.getElementById('donors-quick-manager').style.display = 'flex';
                    document.getElementById('donors-quick-manager').classList.remove('hidden');
                    this.renderManager();
                }
            },
            toggleQuickManager() { this.viewMode = this.viewMode === 'list' ? 'manager' : 'list'; this.render(); },
            renderGrid() {
                const term = (document.querySelector('#view-donors input')?.value || '').trim();
                const grid = document.getElementById('donors-grid');
                grid.innerHTML = '';
                let list = Object.values(Store.data.donors).sort((a,b) => (a.name||'').localeCompare(b.name||''));
                if(term) list = list.filter(d => d.name.includes(term) || (d.address||'').includes(term));
                
                list.slice(0, 50).forEach(d => {
                    const groupName = Store.data.donorGroupMap[d.id];
                    grid.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition relative group">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800 text-lg">${d.name}</h4>
                            <button onclick="Donors.openEdit('${d.id}')" class="text-gray-300 hover:text-indigo-600"><i class="fas fa-pen"></i></button>
                        </div>
                        <div class="text-sm text-gray-500 mb-2">${d.address || '-'}</div>
                        <div class="flex flex-wrap gap-2 mt-3">
                            ${groupName ? `<span class="text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded font-bold border border-amber-100">${groupName}</span>` : ''}
                            ${d.vip ? '<span class="text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100">VIP</span>' : ''}
                        </div>
                        <div class="mt-4 pt-3 border-t border-dashed financial-data">
                            <button onclick="Finance.quickAdd('income', '${d.id}', 'donor')" class="text-emerald-600 text-sm font-bold w-full">+ תרומה חדשה</button>
                        </div>
                    </div>`;
                });
            },
            renderManager() {
                const poolEl = document.getElementById('donor-pool-list');
                poolEl.innerHTML = '';
                const allGroups = [];
                const groupsData = Store.data.yearData[Store.currentYear]?.groups || {};
                Object.entries(groupsData).forEach(([dayKey, dayGroups]) => {
                    Object.entries(dayGroups).forEach(([gid, g]) => {
                        allGroups.push({id: gid, day: dayKey, ...g});
                    });
                });
                const unassigned = Object.values(Store.data.donors).filter(d => !Store.data.donorGroupMap[d.id]);
                document.getElementById('pool-count').innerText = unassigned.length;
                
                unassigned.sort((a,b) => a.name.localeCompare(b.name)).forEach(d => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-2 border rounded shadow-sm text-sm cursor-grab hover:bg-gray-50 flex justify-between";
                    el.dataset.id = d.id;
                    el.innerHTML = `<span class="font-medium">${d.name}</span><span class="text-xs text-gray-400">${d.address||''}</span>`;
                    poolEl.appendChild(el);
                });
                new Sortable(poolEl, { group: { name: 'donors', pull: true, put: true }, sort: false, animation: 150 });

                const container = document.getElementById('groups-kanban-container');
                container.innerHTML = '';
                allGroups.forEach(g => {
                    const col = document.createElement('div');
                    col.className = "inline-block w-72 h-full align-top bg-white rounded-lg shadow-sm border mx-2 flex flex-col";
                    const displayDay = g.day.replace('night','ליל ').replace('day','יום ');
                    col.innerHTML = `
                        <div class="p-2 border-b bg-indigo-50 font-bold text-sm text-indigo-900 flex justify-between shrink-0">
                            <span>${g.name}</span><span class="text-xs font-normal opacity-70">${displayDay}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50 kanban-group-list custom-scroll" data-gid="${g.id}" data-day="${g.day}"></div>
                    `;
                    const listEl = col.querySelector('.kanban-group-list');
                    (g.route || []).forEach(did => {
                        const d = Store.data.donors[did];
                        if(d) {
                            const item = document.createElement('div');
                            item.className = "bg-white p-2 border rounded shadow-sm text-sm cursor-grab flex justify-between group";
                            item.dataset.id = did;
                            item.innerHTML = `<span class="truncate w-40">${d.name}</span><button onclick="Groups.removeFromRoute('${g.day}','${g.id}','${did}')" class="text-red-300 hover:text-red-500 hidden group-hover:block"><i class="fas fa-times"></i></button>`;
                            listEl.appendChild(item);
                        }
                    });
                    container.appendChild(col);
                    new Sortable(listEl, {
                        group: 'donors', animation: 150,
                        onAdd: () => {
                            const newOrder = Array.from(listEl.children).map(c => c.dataset.id);
                            OfflineManager.write(`years/${Store.currentYear}/groups/${g.day}/${g.id}/route`, newOrder);
                        },
                        onUpdate: () => {
                             const newOrder = Array.from(listEl.children).map(c => c.dataset.id);
                             OfflineManager.write(`years/${Store.currentYear}/groups/${g.day}/${g.id}/route`, newOrder);
                        }
                    });
                });
            },
            filterPool(v) { Array.from(document.getElementById('donor-pool-list').children).forEach(el => el.style.display = el.innerText.includes(v) ? 'flex' : 'none'); },
            getFormFields() {
                const activeKeys = Store.data.config.fields.donors || DEFAULT_ACTIVE_FIELDS.donors;
                return activeKeys.map(k => PREDEFINED_FIELDS.donors.find(p => p.k === k)).filter(Boolean);
            },
            openAddModal() {
                Modal.render('הוספת תורם חדש', this.getFormFields(), (data) => {
                    const id = db.ref('global/donors').push().key;
                    OfflineManager.write(`global/donors/${id}`, { id, joinYear: Store.currentYear, ...data });
                    Notify.show('תורם נוסף בהצלחה', 'success');
                });
            },
            openEdit(id) {
                const d = Store.data.donors[id];
                const fields = this.getFormFields().map(f => ({ ...f, v: d[f.id] }));
                Modal.render('עריכת תורם', fields, (data) => {
                    OfflineManager.write(`global/donors/${id}`, data, 'update');
                    Notify.show('פרטי תורם עודכנו', 'success');
                });
            },
            handleSearch() { this.limit = 40; this.render(); }
        };

        const Groups = {
            currentDay: 'night14',
            activeGroupId: null,
            
            setDay(d) {
                this.currentDay = d;
                document.querySelectorAll('.group-tab').forEach(b => b.classList.toggle('active', b.dataset.day === d));
                this.activeGroupId = null;
                this.render();
            },

            render() {
                const listEl = document.getElementById('groups-list');
                listEl.innerHTML = '';
                const groups = (Store.data.yearData[Store.currentYear]?.groups || {})[this.currentDay] || {};

                Object.entries(groups).forEach(([gid, g]) => {
                    const isActive = gid === this.activeGroupId;
                    const el = document.createElement('div');
                    el.className = `p-4 border-b cursor-pointer transition flex justify-between items-center group ${isActive ? 'bg-indigo-50 border-r-4 border-r-indigo-600' : 'hover:bg-slate-50'}`;
                    el.onclick = () => { this.activeGroupId = gid; this.render(); this.renderEditor(g); };
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-700 text-sm group-hover:text-indigo-700">${g.name}</div>
                            <div class="text-xs text-gray-400 mt-1">${(g.members||[]).length} בחורים | ${(g.route||[]).length} תורמים</div>
                        </div>
                        <i class="fas fa-chevron-left text-xs text-gray-300 ${isActive?'text-indigo-500':''}"></i>
                    `;
                    listEl.appendChild(el);
                });

                const ph = document.getElementById('group-placeholder');
                const editor = document.getElementById('group-editor');

                if(this.activeGroupId && groups[this.activeGroupId]) {
                    ph.classList.add('hidden');
                    editor.classList.remove('hidden');
                    this.renderEditor(groups[this.activeGroupId]);
                    document.getElementById('active-group-name').innerText = groups[this.activeGroupId].name;
                } else {
                    ph.classList.remove('hidden');
                    editor.classList.add('hidden');
                }
            },

            renderEditor(group) {
                const memList = document.getElementById('group-members-list');
                memList.innerHTML = '';
                (group.members || []).forEach((m, idx) => {
                    const s = Store.data.students[m.id];
                    if(!s) return;
                    
                    const roleBadge = m.role === 'ראש צוות' ? 'bg-indigo-100 text-indigo-700' : m.role === 'סגן' ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600';
                    
                    memList.innerHTML += `
                        <div class="bg-white p-2 border rounded shadow-sm text-sm flex justify-between items-center mb-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-700">${s.name}</span>
                                <select onchange="Groups.updateMemberRole(${idx}, this.value)" class="text-xs border rounded p-1 ${roleBadge}">
                                    <option value="חבר" ${m.role==='חבר'?'selected':''}>חבר</option>
                                    <option value="ראש צוות" ${m.role==='ראש צוות'?'selected':''}>ראש צוות</option>
                                    <option value="סגן" ${m.role==='סגן'?'selected':''}>סגן</option>
                                </select>
                            </div>
                            <button onclick="Groups.removeMember(${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                        </div>`;
                });

                const routeList = document.getElementById('group-route-list');
                routeList.innerHTML = '';
                (group.route || []).forEach((did, i) => {
                    const d = Store.data.donors[did];
                    if(!d) return;
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 border rounded-lg shadow-sm text-sm mb-2 flex justify-between items-center cursor-grab active:cursor-grabbing hover:border-emerald-200 transition";
                    el.dataset.id = did;
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="bg-emerald-100 text-emerald-700 w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold">${i+1}</span>
                            <div>
                                <div class="font-bold text-slate-800">${d.name}</div>
                                <div class="text-xs text-gray-500">${d.address}</div>
                            </div>
                        </div>
                        <i class="fas fa-grip-lines text-gray-300"></i>
                    `;
                    routeList.appendChild(el);
                });

                if(this.sortableInstance) this.sortableInstance.destroy();
                this.sortableInstance = new Sortable(routeList, {
                    animation: 150,
                    ghostClass: 'bg-emerald-50',
                    onEnd: () => {
                        const newOrder = Array.from(routeList.children).map(c => c.dataset.id);
                        OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/route`, newOrder);
                    }
                });
            },

            updateMemberRole(idx, role) {
                const path = `years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members/${idx}/role`;
                OfflineManager.write(path, role);
            },

            addNewGroup() {
                const n = prompt("שם הקבוצה:");
                if(n) OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${db.ref().push().key}`, {name: n, members: [], route: []});
            },
            renameGroup() {
                const n = prompt("שם חדש:", document.getElementById('active-group-name').innerText);
                if(n) OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/name`, n);
            },
            deleteGroup() {
                 if(confirm('למחוק קבוצה זו?')) {
                     OfflineManager.write(`years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}`, null, 'remove');
                     this.activeGroupId = null;
                     this.render();
                 }
            },
            filterStudents(term) {
                const pool = document.getElementById('pool-students');
                pool.innerHTML = '';
                if(!term) return;
                Object.values(Store.data.students).filter(s => s.name.includes(term)).slice(0, 10).forEach(s => {
                    pool.innerHTML += `<div onclick="Groups.addMember('${s.id}')" class="p-2 border-b cursor-pointer hover:bg-indigo-50 flex justify-between text-sm"><span class="font-medium">${s.name}</span><i class="fas fa-plus text-indigo-500"></i></div>`;
                });
            },
            addMember(sid) {
                const path = `years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members`;
                db.ref(path).once('value', snap => {
                    const list = snap.val() || [];
                    if(!list.some(x => x.id === sid)) {
                        list.push({id: sid, role: 'חבר'});
                        OfflineManager.write(path, list);
                    }
                });
            },
            removeMember(idx) {
                const path = `years/${Store.currentYear}/groups/${this.currentDay}/${this.activeGroupId}/members`;
                db.ref(path).once('value', s => { const l = s.val(); l.splice(idx,1); OfflineManager.write(path, l); });
            },
            removeFromRoute(day, gid, did) {
                const path = `years/${Store.currentYear}/groups/${day}/${gid}/route`;
                db.ref(path).once('value', s => { const l = (s.val()||[]).filter(x => x !== did); OfflineManager.write(path, l); });
            },

            async printSheet(type) {
                const g = (Store.data.yearData[Store.currentYear].groups[this.currentDay] || {})[this.activeGroupId];
                if(!g) return;
                
                const dayMap = {'night14': 'ליל י"ד', 'day14': 'יום י"ד', 'day15': 'יום ט"ו'};
                const mapYear = {5780:'תש״פ', 5781:'תשפ״א', 5782:'תשפ״ב', 5783:'תשפ״ג', 5784:'תשפ״ד', 5785:'תשפ״ה', 5786:'תשפ״ו', 5787:'תשפ״ז', 5788:'תשפ״ח'};

                let html = `
                    <div class="print-container">
                        <div class="print-header-box">
                            <div style="text-align:right">
                                <div class="print-title">עזר חתנים</div>
                                <div class="print-subtitle">שנת ${mapYear[Store.currentYear] || Store.currentYear}</div>
                            </div>
                            <div style="text-align:center">
                                <h1 style="font-size:30pt;margin:0">${type==='route'?'דף מסלול':'דף קשר - צוות'}</h1>
                                <h2 style="font-size:20pt;margin:0">${g.name} (${dayMap[this.currentDay]})</h2>
                            </div>
                            <div style="text-align:left">
                                <div>הופק בתאריך: ${new Date().toLocaleDateString('he-IL')}</div>
                            </div>
                        </div>
                `;
                
                if(type === 'team') {
                    // דף צוות מעוצב
                    let leaders = (g.members||[]).filter(m => m.role === 'ראש צוות' || m.role === 'סגן');
                    let members = (g.members||[]).filter(m => m.role === 'חבר');
                    
                    html += `<div class="team-card bg-indigo-50 border-indigo-200">
                        <h3 style="font-size:18pt;border-bottom:2px solid #000;margin-bottom:10px">הנהלת הצוות</h3>
                        <table class="beautiful-table" style="font-size:14pt">
                            <thead><tr><th width="30%">תפקיד</th><th width="40%">שם</th><th width="30%">טלפון</th></tr></thead><tbody>`;
                    
                    leaders.forEach(m => {
                        const s = Store.data.students[m.id];
                        html += `<tr>
                            <td><span class="role-badge ${m.role==='ראש צוות'?'role-leader':'role-segan'}">${m.role}</span></td>
                            <td><b>${s.name}</b></td>
                            <td>${s.phone}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                    
                    html += `<div class="team-card">
                        <h3 style="font-size:18pt;border-bottom:2px solid #000;margin-bottom:10px">חברי הצוות</h3>
                        <table class="beautiful-table">
                            <thead><tr><th width="5%">#</th><th width="40%">שם הבחור</th><th width="25%">טלפון</th><th width="30%">הערות / חתימה</th></tr></thead><tbody>`;
                    
                    members.forEach((m, idx) => {
                        const s = Store.data.students[m.id];
                        html += `<tr><td>${idx+1}</td><td><b>${s.name}</b></td><td>${s.phone}</td><td></td></tr>`;
                    });
                    html += `</tbody></table></div>`;

                } else {
                    // דף מסלול עם היסטוריה
                    Notify.show('טוען נתונים היסטוריים...', 'info');
                    
                    const yearsBack = [parseInt(Store.currentYear)-1, parseInt(Store.currentYear)-2, parseInt(Store.currentYear)-3];
                    const donorsData = [];

                    // שליפת נתונים - זה עלול לקחת רגע, לכן ה-Notify
                    // כדי לא להעמיס, נשלוף את כל ה-Finance של 3 שנים אלו (אם המשתמש לא מנהל - נשלוף רק עבור הדפסה)
                    // בגלל מגבלת ה"בלי שינוי" לא נוסיף פונקציות עזר מורכבות, אלא נשתמש ב-once פשוט
                    
                    const historyPromises = yearsBack.map(y => db.ref(`years/${y}/finance`).once('value').then(s => ({y, data: Object.values(s.val()||{})})));
                    const histories = await Promise.all(historyPromises);

                    html += `<table class="beautiful-table">
                        <thead>
                            <tr>
                                <th width="3%">#</th>
                                <th width="15%">שם תורם</th>
                                <th width="15%">כתובת / טלפון</th>
                                <th width="8%">${mapYear[yearsBack[0]]||yearsBack[0]}</th>
                                <th width="8%">${mapYear[yearsBack[1]]||yearsBack[1]}</th>
                                <th width="8%">${mapYear[yearsBack[2]]||yearsBack[2]}</th>
                                <th width="15%" style="border: 2px solid #000;background:#fff!important">סכום ${mapYear[Store.currentYear]}</th>
                                <th width="20%">הערות</th>
                            </tr>
                        </thead><tbody>`;
                    
                    (g.route||[]).forEach((did, i) => {
                        const d = Store.data.donors[did];
                        if(!d) return;
                        
                        // חישוב סכומים
                        const sum1 = histories[0].data.filter(t => t.donorId === did && t.type === 'income').reduce((a,b)=>a+parseInt(b.amount||0), 0);
                        const sum2 = histories[1].data.filter(t => t.donorId === did && t.type === 'income').reduce((a,b)=>a+parseInt(b.amount||0), 0);
                        const sum3 = histories[2].data.filter(t => t.donorId === did && t.type === 'income').reduce((a,b)=>a+parseInt(b.amount||0), 0);
                        
                        html += `<tr>
                            <td>${i+1}</td>
                            <td><b>${d.name}</b>${d.vip?' <span style="font-size:0.7em">⭐</span>':''}</td>
                            <td style="font-size:0.85em">${d.address}<br>${d.phone||''}</td>
                            <td>${sum1 || '-'}</td>
                            <td>${sum2 || '-'}</td>
                            <td>${sum3 || '-'}</td>
                            <td style="border: 2px solid #000"></td>
                            <td style="font-size:0.85em">${d.notes||''}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                }
                
                html += `</div>`; // Close container
                
                const pa = document.getElementById('print-area');
                pa.innerHTML = html;
                setTimeout(() => window.print(), 500);
            }
        };

        const Finance = {
            limit: 30, financeData: {}, currentFilter: 'all',
            reset() { this.financeData = {}; Store.cursors.finance = null; document.getElementById('finance-tbody').innerHTML = ''; this.loadMore(); },
            loadMore(reset = false) {
                if(reset) this.reset();
                let q = db.ref(`years/${Store.currentYear}/finance`).orderByChild('date').limitToLast(this.limit);
                if(Store.cursors.finance) q = q.endBefore(Store.cursors.finance);
                q.once('value', snap => {
                    const data = snap.val();
                    if(!data) { document.getElementById('finance-loader-more').style.display = 'none'; return; }
                    Object.assign(this.financeData, data);
                    Store.cursors.finance = Object.values(data).sort((a,b)=>a.date-b.date)[0].date;
                    document.getElementById('finance-loader-more').style.display = 'block';
                    this.render();
                });
            },
            render() {
                const tbody = document.getElementById('finance-tbody');
                tbody.innerHTML = '';
                let raw = Object.values(this.financeData).sort((a,b) => b.date - a.date);
                if(this.currentFilter !== 'all') raw = raw.filter(tx => tx.type === this.currentFilter);
                
                tbody.innerHTML = raw.map(tx => {
                    const entityName = tx.studentId ? (Store.data.students[tx.studentId]?.name) : tx.donorId ? (Store.data.donors[tx.donorId]?.name) : '-';
                    return `<tr class="hover:bg-slate-50 border-b border-slate-50">
                        <td class="p-3 text-gray-500">${new Date(tx.date).toLocaleDateString('he-IL')}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${tx.type==='income'?'bg-emerald-50 text-emerald-700':'bg-rose-50 text-rose-700'}">${tx.type==='income'?'הכנסה':'הוצאה'}</span></td>
                        <td class="p-3 font-medium">${tx.category}</td>
                        <td class="p-3"><div class="text-sm">${tx.desc||''}</div>${entityName!=='-'?`<div class="text-xs text-gray-400">${entityName}</div>`:''}</td>
                        <td class="p-3 font-bold ${tx.type==='income'?'text-emerald-600':'text-rose-600'}" dir="ltr">₪${parseInt(tx.amount).toLocaleString()}</td>
                        <td class="p-3"><button onclick="Finance.deleteTx('${tx.id}', '${tx.type}', ${tx.amount})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>`;
                }).join('');
            },
            setFilter(f) { this.currentFilter = f; this.render(); },
            openTransactionModal(type) {
                const cats = type==='income' ? ['תרומה כללית','מזומן','צק','אשראי'] : ['אוכל','ציוד','שיווק','אחר'];
                const studentsOpts = Object.values(Store.data.students).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                const donorsOpts = Object.values(Store.data.donors).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                const html = `
                    <div class="space-y-4">
                        <div><label class="lbl">סכום</label><input type="text" id="tx-amount" class="input-field w-full" required></div>
                        <div><label class="lbl">קטגוריה</label><select id="tx-category" class="input-field w-full">${cats.map(c=>`<option>${c}</option>`).join('')}</select></div>
                        <div class="bg-slate-50 p-3 rounded border"><label class="lbl">מקור</label>
                            <div class="flex gap-4 mb-2">
                                <label><input type="radio" name="tx-src" value="none" checked onclick="document.getElementById('src-select-area').classList.add('hidden')"> כללי</label>
                                <label><input type="radio" name="tx-src" value="student" onclick="document.getElementById('src-select-area').classList.remove('hidden'); document.getElementById('sel-student').classList.remove('hidden'); document.getElementById('sel-donor').classList.add('hidden');"> בחור</label>
                                <label><input type="radio" name="tx-src" value="donor" onclick="document.getElementById('src-select-area').classList.remove('hidden'); document.getElementById('sel-student').classList.add('hidden'); document.getElementById('sel-donor').classList.remove('hidden');"> תורם</label>
                            </div>
                            <div id="src-select-area" class="hidden">
                                <select id="sel-student" class="input-field w-full hidden"><option value="">-- בחר --</option>${studentsOpts}</select>
                                <select id="sel-donor" class="input-field w-full hidden"><option value="">-- בחר --</option>${donorsOpts}</select>
                            </div>
                        </div>
                        <div><label class="lbl">תיאור</label><textarea id="tx-desc" class="input-field w-full"></textarea></div>
                    </div>`;
                Modal.renderRaw(type==='income'?'הכנסה':'הוצאה', html, () => {
                    const amount = parseInt(document.getElementById('tx-amount').value);
                    if(!amount) return;
                    const srcType = document.querySelector('input[name="tx-src"]:checked').value;
                    const studentId = srcType==='student'?document.getElementById('sel-student').value:null;
                    const donorId = srcType==='donor'?document.getElementById('sel-donor').value:null;
                    const id = 'tx' + Date.now();
                    
                    OfflineManager.write(`years/${Store.currentYear}/finance/${id}`, {
                        id, date: Date.now(), type, amount, category: document.getElementById('tx-category').value,
                        desc: document.getElementById('tx-desc').value, studentId, donorId
                    });
                    
                    if(OfflineManager.isOnline) db.ref(`years/${Store.currentYear}/stats/${type}`).transaction(curr => (curr || 0) + amount);
                    if(type === 'income' && studentId) {
                        // בדיקת יעד פשוטה
                         const tiers = [{amount:5000, reward:'בונוס'}]; // הדגמה
                    }
                    Modal.close();
                    setTimeout(() => Finance.loadMore(true), 500);
                });
            },
            quickAdd(type, entityId, entityType) {
                 Modal.render('הוספה מהירה', [{id:'amt',l:'סכום',t:'number',r:true}], (v) => {
                    const id = 'tx' + Date.now();
                    const amount = parseInt(v.amt);
                    OfflineManager.write(`years/${Store.currentYear}/finance/${id}`, {
                        id, date: Date.now(), type, amount, category: 'תרומה מהירה',
                        [entityType==='student'?'studentId':'donorId']: entityId
                    });
                    if(OfflineManager.isOnline) db.ref(`years/${Store.currentYear}/stats/${type}`).transaction(curr => (curr || 0) + amount);
                    Notify.show('נקלט', 'success');
                });
            },
            deleteTx(id, type, amount) {
                if(confirm('למחוק?')) {
                    OfflineManager.write(`years/${Store.currentYear}/finance/${id}`, null, 'remove');
                    if(OfflineManager.isOnline) db.ref(`years/${Store.currentYear}/stats/${type}`).transaction(curr => (curr || 0) - amount);
                    delete this.financeData[id];
                    this.render();
                }
            }
        };

        const Reports = {
            generateStandard() {
                db.ref(`years/${Store.currentYear}/finance`).once('value', snap => {
                    const type = document.getElementById('rep-type').value;
                    let data = Object.values(snap.val() || {});
                    if(type !== 'all') data = data.filter(t => t.type === type);

                    const rows = data.map(t => ({
                        "תאריך": new Date(t.date).toLocaleDateString('he-IL'),
                        "סוג": t.type==='income'?'הכנסה':'הוצאה',
                        "קטגוריה": t.category, "תיאור": t.desc, "סכום": t.amount
                    }));

                    const ws = XLSX.utils.json_to_sheet(rows);
                    if(!ws['!views']) ws['!views'] = []; ws['!views'].push({ rightToLeft: true });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "דוח");
                    wb.Workbook = { Views: [{ RTL: true }] };
                    XLSX.writeFile(wb, `Report_${Store.currentYear}.xlsx`);
                });
            }
        };

        const Importer = {
            currentType: null, fileData: null,
            init(type) { this.currentType = type; document.getElementById('excel-upload-input').click(); },
            handleFileSelect(input) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    this.fileData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                    this.openMappingModal();
                };
                reader.readAsArrayBuffer(file);
            },
            openMappingModal() {
                const headers = Object.keys(this.fileData[0]);
                const fields = PREDEFINED_FIELDS[this.currentType];
                let html = `<div class="text-sm mb-4">התאם עמודות (RTL):</div>`;
                fields.forEach(f => {
                    let opts = `<option value="">-- בחר --</option>`;
                    headers.forEach(h => opts += `<option value="${h}" ${h.includes(f.l)?'selected':''}>${h}</option>`);
                    html += `<div class="grid grid-cols-2 gap-4 mb-2 items-center"><label>${f.l}</label><select id="map-${f.k}" class="border rounded p-1">${opts}</select></div>`;
                });
                html += `<button onclick="Importer.executeImport()" class="btn-primary w-full mt-4 p-2">יבא נתונים</button>`;
                Modal.renderRaw('יבוא מאקסל', html, null);
            },
            executeImport() {
                const fields = PREDEFINED_FIELDS[this.currentType];
                const mapping = {};
                fields.forEach(f => mapping[f.k] = document.getElementById(`map-${f.k}`).value);
                const batch = {};
                this.fileData.forEach(row => {
                    const id = db.ref().push().key;
                    const item = { id };
                    if (this.currentType === 'students') item.lastUpdatedYear = Store.currentYear;
                    else item.joinYear = Store.currentYear;
                    fields.forEach(f => { if(mapping[f.k]) item[f.k] = row[mapping[f.k]]; });
                    batch[`global/${this.currentType}/${id}`] = item;
                });
                db.ref().update(batch);
                Notify.show('יבוא הושלם', 'success');
                Modal.close();
            }
        };

        const Settings = {
            init() { this.renderFieldsEditor(); },
            renderFieldsEditor() {
                const type = document.getElementById('settings-field-type').value;
                const list = document.getElementById('settings-active-fields');
                const select = document.getElementById('settings-predefined-field');
                select.innerHTML = '';
                PREDEFINED_FIELDS[type].forEach(d => select.innerHTML += `<option value="${d.k}">${d.l}</option>`);
                
                const active = (Store.data.config.fields || {})[type] || DEFAULT_ACTIVE_FIELDS[type];
                list.innerHTML = active.map(k => {
                    const def = PREDEFINED_FIELDS[type].find(d => d.k === k);
                    return `<div class="flex justify-between bg-gray-50 p-2 border text-sm"><span>${def?def.l:k}</span><button onclick="Settings.removeField('${type}','${k}')" class="text-red-500"><i class="fas fa-trash"></i></button></div>`;
                }).join('');
            },
            addField() {
                const type = document.getElementById('settings-field-type').value;
                const key = document.getElementById('settings-predefined-field').value;
                const active = (Store.data.config.fields || {})[type] || [];
                if(!active.includes(key)) {
                    active.push(key);
                    OfflineManager.write(`settings/fields/${type}`, active);
                    if(!Store.data.config.fields) Store.data.config.fields = {};
                    Store.data.config.fields[type] = active;
                    this.renderFieldsEditor();
                }
            },
            removeField(type, key) {
                let active = (Store.data.config.fields || {})[type] || [];
                active = active.filter(k => k !== key);
                OfflineManager.write(`settings/fields/${type}`, active);
                Store.data.config.fields[type] = active;
                this.renderFieldsEditor();
            },
            syncYears() {
                if(confirm('פעולה זו תקדם כיתות. להמשיך?')) {
                    db.ref('global/students').once('value', s => {
                        const u = {};
                        Object.values(s.val()||{}).forEach(st => {
                            const i = SHIURIM_ORDER.indexOf(st.grade);
                            if(i > -1 && i < SHIURIM_ORDER.length-1) u[`global/students/${st.id}/grade`] = SHIURIM_ORDER[i+1];
                        });
                        db.ref().update(u).then(() => { Notify.show('סנכרון הושלם', 'success'); location.reload(); });
                    });
                }
            },
            addHistoryYear() {
                const y = prompt("הכנס שנה היסטורית (לדוגמה: 5770):");
                if(y && y.length === 4 && !isNaN(y)) {
                    // יצירת צומת ריק לשנה ב-DB כדי שהיא תופיע ברשימות
                    db.ref(`years/${y}`).set({created: Date.now()}).then(() => {
                        Notify.show(`שנת ${y} נוספה למערכת`, 'success');
                        setTimeout(() => location.reload(), 1000);
                    });
                } else {
                    alert('שנה לא תקינה');
                }
            }
        };

        const Modal = {
            render(title, fields, onSave, extraHtml='') {
                let html = '';
                fields.forEach(f => {
                    html += `<div class="mb-4"><label class="lbl">${f.l}</label>`;
                    if(f.t === 'select') html += `<select id="field-${f.id}" class="input-field w-full">${f.opts.map(o=>`<option value="${o}" ${f.v===o?'selected':''}>${o}</option>`).join('')}</select>`;
                    else if(f.t === 'checkbox') html += `<input type="checkbox" id="field-${f.id}" ${f.v?'checked':''}>`;
                    else if(f.t === 'textarea') html += `<textarea id="field-${f.id}" class="input-field w-full h-24">${f.v||''}</textarea>`;
                    else html += `<input id="field-${f.id}" type="${f.t}" value="${f.v||''}" class="input-field w-full">`;
                    html += `</div>`;
                });
                this.renderRaw(title, html + extraHtml, () => {
                    const data = {};
                    fields.forEach(f => {
                        const el = document.getElementById(`field-${f.id}`);
                        data[f.id] = f.t === 'checkbox' ? el.checked : el.value;
                    });
                    onSave(data);
                    this.close();
                });
            },
            renderRaw(title, body, onSave) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = body;
                document.getElementById('modal-form').classList.remove('hidden-screen');
                const btn = document.getElementById('modal-save-btn');
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                if(onSave) { newBtn.onclick = onSave; newBtn.style.display = 'block'; } else { newBtn.style.display = 'none'; }
            },
            close() { document.getElementById('modal-form').classList.add('hidden-screen'); }
        };

        const Dashboard = {
            render() {
                const stats = Store.data.stats || { income: 0, expense: 0 };
                document.getElementById('dash-income').innerText = `₪${(stats.income||0).toLocaleString()}`;
                document.getElementById('dash-expense').innerText = `₪${(stats.expense||0).toLocaleString()}`;
                document.getElementById('dash-total-balance').innerText = `₪${((stats.income||0) - (stats.expense||0)).toLocaleString()}`;
            }
        };

        const style = document.createElement('style');
        style.innerHTML = `
            .btn-primary { background-color: #4f46e5; color: white; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1); }
            .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2); }
            .btn-secondary { background-color: #ffffff; color: #475569; border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; }
            .btn-secondary:hover { background-color: #f8fafc; border-color: #cbd5e1; }
            .input-field { border: 1px solid #e2e8f0; padding: 0.6rem; border-radius: 0.75rem; outline: none; transition: 0.2s; background-color: #fff; }
            .input-field:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
            .lbl { font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 0.25rem; display: block; text-transform: uppercase; letter-spacing: 0.025em; }
            .animate-bounce-slight { animation: bounceSlight 2s infinite; }
            @keyframes bounceSlight { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
